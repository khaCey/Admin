<script>
  // State for the student list
  window._headers     = [];
  window._rows        = [];
  window._displayRows = [];
  window._sortCol     = null;
  window._sortAsc     = true;
  
  // Cache for all student details
  window._studentDetailsCache = {};
  // Ensure global handler exists before any row click uses it
  if (typeof window.openStudentDetails !== 'function') {
    
window.openStudentDetails = function(id){
  try {
    // Remove any existing loading message first
    removeLoadingMessage();
    
    // Show modal immediately with basic info
    var root = document.getElementById('detailsModalRoot');
    if (root) root.classList.remove('hidden');
    
    // Disable edit/delete buttons during loading
    var editBtn = document.getElementById('editBtn');
    var deleteBtn = document.getElementById('deleteBtn');
    if (editBtn) editBtn.disabled = true;
    if (deleteBtn) deleteBtn.disabled = true;
    
    // Disable add buttons during loading
    var addPaymentBtn = document.getElementById('addPaymentBtn');
    var addNoteBtn = document.getElementById('addNoteBtn');
    if (addPaymentBtn) addPaymentBtn.disabled = true;
    if (addNoteBtn) addNoteBtn.disabled = true;
    
    // Get basic student info from the table data
    var studentRow = null;
    var idIdx = window._headers.indexOf('ID');
    var nameIdx = window._headers.indexOf('Name');
    var kanjiIdx = window._headers.indexOf('Êº¢Â≠ó');
    var emailIdx = window._headers.indexOf('email');
    var phoneIdx = window._headers.indexOf('phone');
    var statusIdx = window._headers.indexOf('Status');
    
    // Find the student row
    for (var i = 0; i < window._rows.length; i++) {
      if (String(window._rows[i][idIdx]) === String(id)) {
        studentRow = window._rows[i];
        break;
      }
    }
    
    if (studentRow) {
      // Populate the modal header with basic student info
      var studentName = studentRow[nameIdx] || '';
      var studentKanji = studentRow[kanjiIdx] || '';
      var studentEmail = studentRow[emailIdx] || '';
      var studentPhone = studentRow[phoneIdx] || '';
      var studentStatus = studentRow[statusIdx] || '';
      
      // Update modal elements
      var nameEl = document.getElementById('studentName');
      var kanjiEl = document.getElementById('studentKanji');
      var emailEl = document.getElementById('studentEmail');
      var phoneEl = document.getElementById('studentPhone');
      var statusEl = document.getElementById('statusPill');
      
      if (nameEl) nameEl.textContent = studentName;
      if (kanjiEl) kanjiEl.textContent = studentKanji;
      if (emailEl) emailEl.textContent = studentEmail;
      if (phoneEl) phoneEl.textContent = studentPhone;
      if (statusEl) {
        statusEl.textContent = studentStatus;
        statusEl.className = 'badge ' + (studentStatus.toLowerCase() === 'active' ? 'bg-emerald-600 text-white' : 'bg-slate-600 text-white');
      }
      
      // Show/hide contact info based on availability
      var contactEl = document.getElementById('studentContact');
      if (contactEl) {
        contactEl.style.display = (studentEmail || studentPhone) ? '' : 'none';
      }
      
      // Show loading state for data sections
      var latestTable = document.getElementById('latestTable');
      if (latestTable) {
        latestTable.innerHTML = '<tr><td class="py-1.5 pr-2 text-gray-600">Loading...</td><td class="py-1.5 text-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mx-auto"></div></td></tr>';
      }
      
      var paymentsWrap = document.getElementById('paymentsWrap');
      if (paymentsWrap) {
        paymentsWrap.innerHTML = '<div class="flex items-center justify-center py-4"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div><span class="text-gray-600">Loading payments...</span></div>';
      }
      
      var notesBody = document.getElementById('notesBody');
      if (notesBody) {
        notesBody.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div><span class="text-gray-600">Loading notes...</span></div></td></tr>';
      }
      
      // Month tabs will be dynamically generated by renderTabs() function
      // after the student data is loaded
      
      // Now load the actual data using the original working flow
      if (window.google && google.script && google.script.run) {
        // Add a small delay to prevent rapid successive calls
        setTimeout(function() {
          google.script.run
            .withSuccessHandler(function(baseResp) {
              google.script.run
                .withSuccessHandler(function(latest) {
                  try {
                    var model = (typeof normaliseForModal === 'function')
                      ? normaliseForModal(baseResp, latest)
                      : (baseResp || {});
                    if (typeof loadStudent === 'function') {
                      loadStudent(model);
                    }
                    
                    // Re-enable edit/delete buttons after data is loaded
                    var editBtn = document.getElementById('editBtn');
                    var deleteBtn = document.getElementById('deleteBtn');
                    if (editBtn) editBtn.disabled = false;
                    if (deleteBtn) deleteBtn.disabled = false;
                    
                    // Re-enable add buttons after data is loaded
                    var addPaymentBtn = document.getElementById('addPaymentBtn');
                    var addNoteBtn = document.getElementById('addNoteBtn');
                    if (addPaymentBtn) addPaymentBtn.disabled = false;
                    if (addNoteBtn) addNoteBtn.disabled = false;
                  } catch(e) {
                    console.error('Error normalising/loading student model', e);
                  }
                })
                .withFailureHandler(function(err) {
                  console.error('getLatestByMonth failed', err);
                  try {
                    var model = (typeof normaliseForModal === 'function') ? normaliseForModal(baseResp, {}) : (baseResp || {});
                    if (typeof loadStudent === 'function') loadStudent(model);
                    
                    // Re-enable edit/delete buttons after data is loaded
                    var editBtn = document.getElementById('editBtn');
                    var deleteBtn = document.getElementById('deleteBtn');
                    if (editBtn) editBtn.disabled = false;
                    if (deleteBtn) deleteBtn.disabled = false;
                    
                    // Re-enable add buttons after data is loaded
                    var addPaymentBtn = document.getElementById('addPaymentBtn');
                    var addNoteBtn = document.getElementById('addNoteBtn');
                    if (addPaymentBtn) addPaymentBtn.disabled = false;
                    if (addNoteBtn) addNoteBtn.disabled = false;
                  } catch(e) {
                    console.error('Error loading student model', e);
                  }
                })
                .getLatestByMonth(id);
            })
            .withFailureHandler(function(err) {
              console.error('getStudentDetails failed', err);
            })
            .getStudentDetails(id);
        }, 100); // Small delay to prevent rapid calls
      }
      
      console.log('Student details modal populated for:', studentName);
    } else {
      console.log('Student not found for ID:', id);
    }
    
  } catch(e) {
    console.error('openStudentDetails error', e);
  }
};
;
  }


  // Define sortable columns by header name
  var sortableColumns = ['ID', 'Name', 'Êº¢Â≠ó', 'Status', 'Payment Type', 'Group'];
  var statusOrder = ['Dormant', 'DEMO', 'Active'];

  // Custom column order: ID, Name, Êº¢Â≠ó, Â≠ê, then the rest (excluding 'phone (secondary)')
  function getCustomOrder(headers) {
    const first = ['ID', 'Name', 'Êº¢Â≠ó', 'Â≠ê'];
    const rest = headers.filter(h => !first.includes(h) && h !== 'phone (secondary)');
    return first.concat(rest);
  }

  /**
   * onLoad: initialize app on page load with caching strategy
   */
  function onLoad() {
    // First fetch the student list for immediate display
    google.script.run
      .withSuccessHandler(function(data) {
        // data[0] is headers, data.slice(1) are rows
        window._headers     = data[0];
        window._rows        = data.slice(1);
        window._displayRows = window._rows.slice();

        window._customOrder = getCustomOrder(window._headers);
        
        
        // Immediate render (no comprehensive prewarm)
        const loadingRow = document.getElementById('loadingRow');
        if (loadingRow) { loadingRow.remove(); }
        renderTable();
        hookSearch();
        const searchInput = document.getElementById('searchInput');
        if (searchInput) { searchInput.focus(); searchInput.select(); }
// Debug: Log the first few student IDs to see their format
        console.log('üìä Headers:', window._headers);
        console.log('üìä First 5 student IDs:', window._rows.slice(0, 5).map(row => row[window._headers.indexOf('ID')]));
        
                 // Debug: Check specifically for the Â≠ê column
         const childColIndex = window._headers.indexOf('Â≠ê');
         console.log('Â≠ê column index:', childColIndex);
         if (childColIndex !== -1 && window._rows.length >= 14) {
           console.log('Student 14 (index 13) Â≠ê value:', window._rows[13][childColIndex], 'type:', typeof window._rows[13][childColIndex]);
         } else if (childColIndex === -1) {
           console.log('Â≠ê column not found in headers!');
         }


        
        google.script.run
          .withSuccessHandler(function(cacheData) {
            // Check if cacheData is valid
            if (!cacheData || typeof cacheData !== 'object') {
              console.error('‚ùå Invalid cache data received:', cacheData);
              cacheData = {}; // Use empty object as fallback
            }
            
            window._studentDetailsCache = cacheData;
            console.log('Cache keys:', Object.keys(cacheData));
            
            // NOW render the table and enable user interaction
            console.log('üéâ All data loaded! Rendering table and enabling user interaction...');
            
            // Show completion message
            const completionMessage = document.createElement('div');
            completionMessage.className = 'text-center py-4 text-green-600';
            completionMessage.innerHTML = `
              <div class="flex items-center justify-center space-x-2 text-green-600">
                <div class="w-4 h-4">‚úì</div>
                <span>All data loaded successfully!</span>
              </div>
              <div class="text-sm text-gray-500 mt-2">
                You can now click on students to view details
              </div>
            `;
            document.querySelector('main').appendChild(completionMessage);
            
            // Remove the message after 2 seconds
            setTimeout(() => {
              if (completionMessage && completionMessage.parentNode) {
                completionMessage.remove();
              }
            }, 2000);
            
            // Remove loading row and render actual data
            const loadingRow = document.getElementById('loadingRow');
            if (loadingRow) {
              loadingRow.remove();
            }
            
            renderTable();
            hookSearch();

            // Auto-focus search input for quick typing
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
              searchInput.focus();
              searchInput.select();
            }
            
            // Debug cache status
            debugCache();
            
            // Also fetch notifications
            if (typeof fetchNotifications === 'function') {
              fetchNotifications();
            }
          })
          .withFailureHandler(function(error) {
            
            // Even if cache fails, we should still render the table
            console.log('‚ö†Ô∏è Cache failed, but rendering table with basic data...');
            
            // Remove loading row and render actual data
            const loadingRow = document.getElementById('loadingRow');
            if (loadingRow) {
              loadingRow.remove();
            }
            
            renderTable();
            hookSearch();

            // Auto-focus search input for quick typing
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
              searchInput.focus();
              searchInput.select();
            }
            
            // Still fetch notifications even if cache fails
            if (typeof fetchNotifications === 'function') {
              fetchNotifications();
            }
          })
          ;
      })
      .withFailureHandler(function(e) {
        console.error('Error fetching students:', e);
        // Show error in table instead of hiding loader
        const loadingRow = document.getElementById('loadingRow');
        if (loadingRow) {
          loadingRow.innerHTML = '<td colspan="100%" class="text-center py-8 text-red-600">Error loading students. Please refresh the page.</td>';
        }
      })
      .getStudents();

    // Toggle sidebar collapse/expand
    document.getElementById('toggleSidebarBtn').onclick = function() {
      // Removed showLoader and hideLoader for sidebar toggle
      var sb = document.getElementById('sidebar');
      document.body.classList.toggle('sidebar-collapsed');
    };
  }

  /**
   * Helper function to remove loading message
   */
  function removeLoadingMessage() {
    var loadingMessage = document.getElementById('loadingMessage');
    if (loadingMessage && loadingMessage.parentNode) {
      loadingMessage.remove();
    }
  }

  /**
   * Get student details from cache or fallback to server
   * @param {string|number} studentId - Student ID
   * @returns {Object|null} Student details or null if not found
   */
  function getStudentDetailsFromCache(studentId) {
  if (!studentId) {
    console.log('‚ùå No student ID provided to getStudentDetailsFromCache');
    return null;
  }
  
  var cacheKey = String(studentId).trim();
  
  // Check if cache is initialized
  if (!window._studentDetailsCache) {
    console.log('‚ùå Cache not initialized for student:', cacheKey);
    return null;
  }
  
  // Check if we have the data in cache
  if (window._studentDetailsCache[cacheKey]) {
    console.log('‚úÖ Using cached data for student:', cacheKey);
    return window._studentDetailsCache[cacheKey];
  }
  
  // Try alternative keys (in case of type mismatches)
  const alternativeKeys = [
    String(Number(studentId)), // Try numeric version
    Number(studentId).toString(), // Try string version of number
    studentId.toString(), // Try direct toString
    String(studentId) // Try string conversion
  ];
  
  for (const key of alternativeKeys) {
    if (window._studentDetailsCache[key]) {
      console.log('‚úÖ Found cached data with alternative key:', key, 'for student:', cacheKey);
      return window._studentDetailsCache[key];
    }
  }
  
  // Fallback to server if not in cache
  console.log('‚ùå Student not in cache, fetching from server:', cacheKey);
  console.log('Available cache keys:', Object.keys(window._studentDetailsCache));
  return null;
}

  /**
   * Update cache when new data is added (called from other scripts)
   * @param {string} type - Type of data ('note', 'payment', 'student')
   * @param {Object} data - The new data
   */
  function updateCache(type, data) {
    if (!window._studentDetailsCache) {
      console.log('‚ö†Ô∏è Cache not initialized, skipping update');
      return;
    }
    
    var studentId = String(data['Student ID'] || data['ID']);
    if (!studentId) {
      console.log('‚ö†Ô∏è No student ID found in data:', data);
      return;
    }
    
    console.log('üîÑ Updating cache for student:', studentId, 'type:', type);
    
    // Refresh the specific student's data from server
    google.script.run
      .withSuccessHandler(function(studentData) {
        if (studentData && studentData.student) {
          window._studentDetailsCache[studentId] = studentData;
          console.log('‚úÖ Cache updated for student:', studentId);
        } else {
          console.log('‚ö†Ô∏è No student data returned for cache update:', studentId);
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to update cache for student:', studentId, error);
      })
      .getStudentDetailsOptimized(studentId);
  }

  /**
   * Debug function to check cache status
   * @param {string|number} studentId - Optional student ID to check
   */
  function debugCache(studentId = null) {
    console.log('üîç Cache Debug Info:');
    console.log('Cache initialized:', !!window._studentDetailsCache);
    console.log('Cache type:', typeof window._studentDetailsCache);
    
    if (window._studentDetailsCache) {
      console.log('Total cached students:', Object.keys(window._studentDetailsCache).length);
      console.log('Cache keys:', Object.keys(window._studentDetailsCache));
      
      if (studentId) {
        const normalizedId = String(studentId).trim();
        console.log('Looking for student:', normalizedId);
        console.log('Direct lookup:', window._studentDetailsCache[normalizedId]);
        
        // Try alternative keys
        const alternativeKeys = [
          String(Number(studentId)),
          Number(studentId).toString(),
          studentId.toString(),
          String(studentId)
        ];
        
        for (const key of alternativeKeys) {
          if (window._studentDetailsCache[key]) {
            console.log('Found with key:', key, 'Data:', window._studentDetailsCache[key]);
          }
        }
      }
    }
  }

  /**
   * Refresh the student list from the server
   * This function can be called after adding/updating students
   */
  window.refreshStudentList = function() {
    console.log('üîÑ Refreshing student list...');
    
    // Show loading state
    const tbody = document.getElementById('studentTable');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-8"><div class="flex justify-center items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><span class="ml-2 text-gray-600">Refreshing students...</span></div></td></tr>';
    }
    
    // Fetch fresh data from server
    google.script.run
      .withSuccessHandler(function(data) {
        // Update the global data
        window._headers = data[0];
        window._rows = data.slice(1);
        window._displayRows = window._rows.slice();
        window._customOrder = getCustomOrder(window._headers);
        
        // Re-render the table
        renderTable();
        hookSearch();
        
        console.log('‚úÖ Student list refreshed successfully');
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to refresh student list:', error);
        
        // Show error message
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-8 text-red-600">Failed to refresh students. Please try again.</td></tr>';
        }
      })
      .getStudents();
  };



  /**
   * renderTable: display the filtered & sorted rows in the table body
   */
  function renderTable() {
    var tbody = document.getElementById('studentTable');
    tbody.innerHTML = '';
    if (!window._displayRows.length) {
      tbody.innerHTML = '<tr><td colspan="'+window._headers.length+'" class="text-center text-gray-500 py-6">No students found.</td></tr>';
      return;
    }
    var idIdx = window._headers.indexOf('ID');
    var order = window._customOrder || window._headers;
    window._displayRows.forEach(function(row) {
      var tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.onclick = function() { 
        console.log('üñ±Ô∏è Row clicked, ID index:', idIdx, 'Row ID value:', row[idIdx], 'Type:', typeof row[idIdx]);
        openStudentDetails(row[idIdx]); 
      };
      
      order.forEach(function(h, i) {
        var colIdx = window._headers.indexOf(h);
        var td = document.createElement('td');
        
        // Add sticky class to ID column
        if (h === 'ID') {
          td.className = 'sticky-col';
        }
        
        var cellValue = row[colIdx] || '';
        
                 // Handle different column types
         switch(h) {
          case 'ÂΩìÊó•„Ç≠„É£„É≥„Çª„É´':
            var badgeClass = cellValue === 'Ê∏à' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
            td.innerHTML = '<span class="' + badgeClass + '">' + cellValue + '</span>';
            td.style.textAlign = 'center';
            td.className = 'text-center';
            break;
            
          case 'Status':
            var statusClass = '';
            switch(cellValue) {
              case 'Active': statusClass = 'badge badge-status-active'; break;
              case 'Dormant': statusClass = 'badge badge-status-dormant'; break;
              case 'DEMO': statusClass = 'badge badge-status-demo'; break;
              default: statusClass = 'badge badge-status-dormant';
            }
            td.innerHTML = '<span class="' + statusClass + '">' + cellValue + '</span>';
            td.style.textAlign = 'center';
            break;
            
                     case 'Payment':
             var paymentClass = cellValue === 'NEO' ? 'badge badge-pay-neo' : 'badge badge-pay-old';
             td.innerHTML = '<span class="' + paymentClass + '">' + cellValue + '</span>';
             td.style.textAlign = 'center';
             break;
             
           case 'Group':
             var groupClass = cellValue === 'Individual' ? 'badge badge-group-individual' : 'badge badge-group-group';
             td.innerHTML = '<span class="' + groupClass + '">' + cellValue + '</span>';
             td.style.textAlign = 'center';
             break;
             
           case 'ÂΩìÊó• Cancellation':
             var cancelClass = cellValue === 'Ê∏à' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
             td.innerHTML = '<span class="' + cancelClass + '">' + cellValue + '</span>';
             td.style.textAlign = 'center';
             break;
             
                      case 'email':
            td.innerHTML = '<span class="truncate" title="' + cellValue + '">' + cellValue + '</span>';
            break;
            
          case 'phone':
            td.innerHTML = '<span class="truncate" title="' + cellValue + '">' + cellValue + '</span>';
            td.style.textAlign = 'center';
            break;
            
                     case 'Â≠ê':
             // Simply check if the value is the character 'Â≠ê'
             td.innerHTML = cellValue === 'Â≠ê' ? 'Â≠ê' : '';
             td.style.textAlign = 'center';
             break;
            
          case '‰∫∫Êï∞':
            td.style.textAlign = 'center';
            td.textContent = cellValue;
            break;
            
                     default:
             // Catch-all for any cancellation column that wasn't caught above
             if (h.includes('ÂΩìÊó•') || h.includes('Cancellation') || h.includes('„Ç≠„É£„É≥„Çª„É´')) {
               var cancelClass = cellValue === 'Ê∏à' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
               td.innerHTML = '<span class="' + cancelClass + '">' + cellValue + '</span>';
               td.style.textAlign = 'center';
             } else {
               td.textContent = cellValue;
             }
        }
        
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  /**
   * hookSearch: filter rows as user types in search box
   */
  function hookSearch() {
    document.getElementById('searchInput').oninput = function() {
      var q = this.value.trim().toLowerCase();
      window._displayRows = q
        ? window._rows.filter(r => r.some(c => String(c).toLowerCase().includes(q)))
        : window._rows.slice();
      sortDisplayRows();
      renderTable();
    };
  }

  /**
   * sortDisplayRows: helper to sort window._displayRows based on current sort settings
   */
  function sortDisplayRows() {
    if (window._sortCol === null) return;
    var h = window._headers[window._sortCol];
    window._displayRows.sort(function(a, b) {
      var v1 = a[window._sortCol], v2 = b[window._sortCol];
      // ID: numeric sort
      if (h === 'ID') {
        return window._sortAsc ? (Number(v1) - Number(v2)) : (Number(v2) - Number(v1));
      }
      // Status: custom order, then by Name
      if (h === 'Status') {
        var idx1 = statusOrder.indexOf(v1);
        var idx2 = statusOrder.indexOf(v2);
        if (idx1 === -1) idx1 = statusOrder.length;
        if (idx2 === -1) idx2 = statusOrder.length;
        if (idx1 !== idx2) return window._sortAsc ? idx1 - idx2 : idx2 - idx1;
        // Secondary sort by Name
        var nameIdx = window._headers.indexOf('Name');
        var n1 = a[nameIdx] || '';
        var n2 = b[nameIdx] || '';
        return window._sortAsc ? n1.localeCompare(n2) : n2.localeCompare(n1);
      }
      // Default: string sort
      if (v1 == v2) return 0;
      if (window._sortAsc) return v1 > v2 ? 1 : -1;
      return v1 < v2 ? 1 : -1;
    });
  }
</script>