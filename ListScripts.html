<script>
  // Cache Manager for localStorage functionality
  const cacheManager = {
    // Prefix for all cache keys to avoid conflicts
    prefix: 'student_admin_',
    
    /**
     * Get data from localStorage with timestamp validation
     * @param {string} key - Cache key
     * @returns {any|null} Cached data or null if not found/expired
     */
    get(key) {
      try {
        const fullKey = this.prefix + key;
        const cached = localStorage.getItem(fullKey);
        
        if (!cached) {
          return null;
        }
        
        const parsed = JSON.parse(cached);
        
        // Check if data has timestamp and is still valid
        if (parsed.timestamp && parsed.data) {
          return parsed.data;
        }
        
        // Legacy format without timestamp - return as is
        return parsed;
      } catch (error) {
        console.warn('Error reading from localStorage:', error);
        return null;
      }
    },
    
    /**
     * Set data in localStorage with timestamp
     * @param {string} key - Cache key
     * @param {any} data - Data to cache
     * @param {number} ttl - Time to live in milliseconds (optional)
     */
    set(key, data, ttl = null) {
      try {
        const fullKey = this.prefix + key;
        const cacheEntry = {
          data: data,
          timestamp: Date.now(),
          ttl: ttl
        };
        
        localStorage.setItem(fullKey, JSON.stringify(cacheEntry));
      } catch (error) {
        console.warn('Error writing to localStorage:', error);
        // If localStorage is full, try to clean up old entries
        this.cleanupExpiredCache();
        try {
          localStorage.setItem(fullKey, JSON.stringify(cacheEntry));
        } catch (retryError) {
          console.error('Failed to write to localStorage after cleanup:', retryError);
        }
      }
    },
    
    /**
     * Check if cached data is still fresh
     * @param {string} key - Cache key
     * @param {number} ttl - Time to live in milliseconds
     * @returns {boolean} True if cache is fresh, false otherwise
     */
    isCacheFresh(key, ttl) {
      try {
        const fullKey = this.prefix + key;
        const cached = localStorage.getItem(fullKey);
        
        if (!cached) {
          return false;
        }
        
        const parsed = JSON.parse(cached);
        
        // If no timestamp, consider it expired
        if (!parsed.timestamp) {
          return false;
        }
        
        const age = Date.now() - parsed.timestamp;
        return age < ttl;
      } catch (error) {
        console.warn('Error checking cache freshness:', error);
        return false;
      }
    },
    
    /**
     * Remove specific cache entry
     * @param {string} key - Cache key
     */
    remove(key) {
      try {
        const fullKey = this.prefix + key;
        localStorage.removeItem(fullKey);
      } catch (error) {
        console.warn('Error removing from localStorage:', error);
      }
    },
    
    /**
     * Clean up expired cache entries
     */
    cleanupExpiredCache() {
      try {
        const keysToRemove = [];
        const now = Date.now();
        
        // Check all localStorage keys with our prefix
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          
          if (key && key.startsWith(this.prefix)) {
            try {
              const cached = localStorage.getItem(key);
              const parsed = JSON.parse(cached);
              
              // Remove if no timestamp or expired
              if (!parsed.timestamp || (parsed.ttl && (now - parsed.timestamp) > parsed.ttl)) {
                keysToRemove.push(key);
              }
            } catch (parseError) {
              // Remove malformed entries
              keysToRemove.push(key);
            }
          }
        }
        
        // Remove expired entries
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
        });
        
        if (keysToRemove.length > 0) {
          console.log(`üßπ Cleaned up ${keysToRemove.length} expired cache entries`);
        }
      } catch (error) {
        console.warn('Error during cache cleanup:', error);
      }
    },
    
    /**
     * Clear all cache entries with our prefix
     */
    clearAll() {
      try {
        const keysToRemove = [];
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith(this.prefix)) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
        });
        
        console.log(`üóëÔ∏è Cleared ${keysToRemove.length} cache entries`);
      } catch (error) {
        console.warn('Error clearing cache:', error);
      }
    },
    
    /**
     * Get cache statistics
     * @returns {Object} Cache statistics
     */
    getStats() {
      try {
        let totalEntries = 0;
        let expiredEntries = 0;
        let totalSize = 0;
        const now = Date.now();
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          
          if (key && key.startsWith(this.prefix)) {
            totalEntries++;
            const cached = localStorage.getItem(key);
            totalSize += cached ? cached.length : 0;
            
            try {
              const parsed = JSON.parse(cached);
              if (parsed.timestamp && parsed.ttl && (now - parsed.timestamp) > parsed.ttl) {
                expiredEntries++;
              }
            } catch (parseError) {
              expiredEntries++;
            }
          }
        }
        
        return {
          totalEntries,
          expiredEntries,
          activeEntries: totalEntries - expiredEntries,
          totalSize: `${(totalSize / 1024).toFixed(2)} KB`
        };
      } catch (error) {
        console.warn('Error getting cache stats:', error);
        return { totalEntries: 0, expiredEntries: 0, activeEntries: 0, totalSize: '0 KB' };
      }
    }
  };

  // State for the student list
  window._headers     = [];
  window._rows        = [];
  window._displayRows = [];
  window._sortCol     = null;
  window._sortAsc     = true;
  
  // Cache for all student details
  window._studentDetailsCache = {};
  // Ensure global handler exists before any row click uses it
  if (typeof window.openStudentDetails !== 'function') {
    
window.openStudentDetails = function(id){
  try {
    console.log('üöÄ Opening student details for ID:', id);
    
    // Remove any existing loading message first
    removeLoadingMessage();
    
    // Show modal immediately with basic info
    var root = document.getElementById('detailsModalRoot');
    if (root) root.classList.remove('hidden');
    
    // Disable edit/delete buttons during loading
    var editBtn = document.getElementById('editBtn');
    var deleteBtn = document.getElementById('deleteBtn');
    if (editBtn) editBtn.disabled = true;
    if (deleteBtn) deleteBtn.disabled = true;
    
    // Disable add buttons during loading
    var addPaymentBtn = document.getElementById('addPaymentBtn');
    var addNoteBtn = document.getElementById('addNoteBtn');
    if (addPaymentBtn) addPaymentBtn.disabled = true;
    if (addNoteBtn) addNoteBtn.disabled = true;
    
    // Get basic student info from the table data
    var studentRow = null;
    var idIdx = window._headers.indexOf('ID');
    var nameIdx = window._headers.indexOf('Name');
    var kanjiIdx = window._headers.indexOf('Êº¢Â≠ó');
    var emailIdx = window._headers.indexOf('Email');
    var phoneIdx = window._headers.indexOf('Phone');
    var statusIdx = window._headers.indexOf('Status');
    
    
    // Find the student row
    
    for (var i = 0; i < window._rows.length; i++) {
      if (String(window._rows[i][idIdx]) === String(id)) {
        studentRow = window._rows[i];
        break;
      }
    }
    
    if (!studentRow) {
    }
    
    if (studentRow) {
      // Populate the modal header with basic student info
      var studentName = studentRow[nameIdx] || '';
      var studentKanji = studentRow[kanjiIdx] || '';
      var studentEmail = studentRow[emailIdx] || '';
      var studentPhone = studentRow[phoneIdx] || '';
      var studentStatus = studentRow[statusIdx] || '';
      
      
      // Update modal elements
      var nameEl = document.getElementById('studentName');
      var kanjiEl = document.getElementById('studentKanji');
      var emailEl = document.getElementById('studentEmail');
      var phoneEl = document.getElementById('studentPhone');
      var statusEl = document.getElementById('statusPill');
      
      
      if (nameEl) nameEl.textContent = studentName;
      if (kanjiEl) kanjiEl.textContent = studentKanji;
      if (emailEl) emailEl.textContent = studentEmail;
      if (phoneEl) phoneEl.textContent = studentPhone;
      if (statusEl) {
        statusEl.textContent = studentStatus;
        statusEl.className = 'badge ' + (studentStatus.toLowerCase() === 'active' ? 'bg-emerald-600 text-white' : 'bg-slate-600 text-white');
      }
      
      // Show/hide contact info based on availability
      var contactEl = document.getElementById('studentContact');
      if (contactEl) {
        contactEl.style.display = (studentEmail || studentPhone) ? '' : 'none';
      }
      
      // Show loading state for data sections
      var latestTable = document.getElementById('lr_table');
      if (latestTable) {
        latestTable.innerHTML = '<tr><td class="py-1.5 pr-2 text-gray-600">Loading...</td><td class="py-1.5 text-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mx-auto"></div></td></tr>';
      }
      
      var paymentsBody = document.getElementById('paymentsBody');
      if (paymentsBody) {
        paymentsBody.innerHTML = '<tr><td colspan="8" class="px-3 py-6 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div><span class="text-gray-600">Loading payments...</span></div></td></tr>';
      }
      
      var notesBody = document.getElementById('notesBody');
      if (notesBody) {
        notesBody.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div><span class="text-gray-600">Loading notes...</span></div></td></tr>';
      }
      
      // Month tabs will be dynamically generated by renderTabs() function
      // after the student data is loaded
      
      // Check if we have cached data first
      var cachedData = getStudentDetailsFromCache(id);
      if (cachedData) {
        console.log('‚úÖ Using cached data for instant display');
        
        // Use cached data to populate the modal header (more reliable than table data)
        var headerName = '', headerKanji = '', headerEmail = '', headerPhone = '', headerStatus = '';
        
        if (cachedData.student) {
          var cachedStudent = cachedData.student;
          headerName = cachedStudent.Name || cachedStudent.name || '';
          headerKanji = cachedStudent['Êº¢Â≠ó'] || cachedStudent.kanji || '';
          headerEmail = cachedStudent.email || cachedStudent.Email || '';
          headerPhone = cachedStudent.phone || cachedStudent.Phone || '';
          headerStatus = cachedStudent.Status || cachedStudent.status || '';
          
        } else {
          // Fallback to table data if cached student data is missing
          headerName = studentName;
          headerKanji = studentKanji;
          headerEmail = studentEmail;
          headerPhone = studentPhone;
          headerStatus = studentStatus;
        }
        
        // Update modal elements with the determined data
        var nameEl = document.getElementById('studentName');
        var kanjiEl = document.getElementById('studentKanji');
        var emailEl = document.getElementById('studentEmail');
        var phoneEl = document.getElementById('studentPhone');
        var statusEl = document.getElementById('statusPill');
        
        
        if (nameEl) {
          nameEl.textContent = headerName;
        }
        
        if (kanjiEl) {
          kanjiEl.textContent = headerKanji;
        }
        
        if (emailEl) {
          emailEl.textContent = headerEmail;
        }
        
        if (phoneEl) {
          phoneEl.textContent = headerPhone;
        }
        
        if (statusEl) {
          statusEl.textContent = headerStatus;
          statusEl.className = 'badge ' + (headerStatus.toLowerCase() === 'active' ? 'bg-emerald-600 text-white' : 'bg-slate-600 text-white');
        }
        
        // Show/hide contact info based on availability
        var contactEl = document.getElementById('studentContact');
        if (contactEl) {
          contactEl.style.display = (headerEmail || headerPhone) ? '' : 'none';
        }
        
        // Use cached data to populate the modal content
        if (typeof loadStudent === 'function') {
          // Normalize the cached data to match the expected structure
          if (typeof normaliseForModal === 'function') {
            var normalizedData = normaliseForModal(cachedData);
            loadStudent(normalizedData);
          } else {
            loadStudent(cachedData);
          }
        }
        
        // Re-enable all buttons
        if (editBtn) editBtn.disabled = false;
        if (deleteBtn) deleteBtn.disabled = false;
        if (addPaymentBtn) addPaymentBtn.disabled = false;
        if (addNoteBtn) addNoteBtn.disabled = false;
        
        console.log('Student details modal populated from cache for:', cachedData.student ? (cachedData.student.Name || cachedData.student.name || 'Unknown') : 'Unknown');
        return;
      }
      
      // Check if bulk loading is still in progress
      if (window._bulkLoadingInProgress) {
        console.log('‚è≥ Bulk loading still in progress - this student will be cached soon');
      }
      
      // Check if this is a Dormant student (not cached in bulk loading)
      const currentStudentRow = window._rows.find(row => String(row[window._headers.indexOf('ID')]) === String(id));
      if (currentStudentRow && currentStudentRow[statusIdx] !== 'Active') {
        console.log('‚ÑπÔ∏è Dormant student - will load individually (not cached in bulk loading)');
      }
      
      // If no cache, try to preload this specific student's data
      console.log('üîÑ No cached data for student', id, '- attempting to preload...');
      preloadStudentData(id);
      
      // Fall back to server calls for immediate display
      console.log('üîÑ Fetching from server for immediate display...');
      
      // Now load the actual data using the original working flow
      if (window.google && google.script && google.script.run) {
        // Add a small delay to prevent rapid successive calls
        setTimeout(function() {
          google.script.run
            .withSuccessHandler(function(baseResp) {
              google.script.run
                .withSuccessHandler(function(latest) {
                  try {
                    var model = (typeof normaliseForModal === 'function')
                      ? normaliseForModal(baseResp, latest)
                      : (baseResp || {});
                    if (typeof loadStudent === 'function') {
                      loadStudent(model);
                    }
                    
                    // Re-enable edit/delete buttons after data is loaded
                    var editBtn = document.getElementById('editBtn');
                    var deleteBtn = document.getElementById('deleteBtn');
                    if (editBtn) editBtn.disabled = false;
                    if (deleteBtn) deleteBtn.disabled = false;
                    
                    // Re-enable add buttons after data is loaded
                    var addPaymentBtn = document.getElementById('addPaymentBtn');
                    var addNoteBtn = document.getElementById('addNoteBtn');
                    if (addPaymentBtn) addPaymentBtn.disabled = false;
                    if (addNoteBtn) addNoteBtn.disabled = false;
                  } catch(e) {
                    console.error('Error normalising/loading student model', e);
                  }
                })
                .withFailureHandler(function(err) {
                  console.error('getLatestByMonth failed', err);
                  try {
                    var model = (typeof normaliseForModal === 'function') ? normaliseForModal(baseResp, {}) : (baseResp || {});
                    if (typeof loadStudent === 'function') loadStudent(model);
                    
                    // Re-enable edit/delete buttons after data is loaded
                    var editBtn = document.getElementById('editBtn');
                    var deleteBtn = document.getElementById('editBtn');
                    if (editBtn) editBtn.disabled = false;
                    if (deleteBtn) deleteBtn.disabled = false;
                    
                    // Re-enable add buttons after data is loaded
                    var addPaymentBtn = document.getElementById('addPaymentBtn');
                    var addNoteBtn = document.getElementById('addNoteBtn');
                    if (addPaymentBtn) addPaymentBtn.disabled = false;
                    if (addNoteBtn) addNoteBtn.disabled = false;
                  } catch(e) {
                    console.error('Error loading student model', e);
                  }
                })
                .getLatestByMonth(id);
            })
            .withFailureHandler(function(err) {
              console.error('getStudentDetails failed', err);
            })
            .getStudentDetails(id);
        }, 100); // Small delay to prevent rapid calls
      }
      
      console.log('Student details modal populated for:', studentName);
    } else {
      console.log('Student not found for ID:', id);
    }
    
  } catch(e) {
    console.error('openStudentDetails error', e);
  }
};
;
  }


  // Define sortable columns by header name
  var sortableColumns = ['ID', 'Name', 'Êº¢Â≠ó', 'Status', 'Payment Type', 'Group'];
  var statusOrder = ['Dormant', 'DEMO', 'Active'];

  // Custom column order: ID, Name, Êº¢Â≠ó, Â≠ê, then the rest (excluding 'phone (secondary)')
  function getCustomOrder(headers) {
    const first = ['ID', 'Name', 'Êº¢Â≠ó', 'Â≠ê'];
    const rest = headers.filter(h => !first.includes(h) && h !== 'phone (secondary)');
    return first.concat(rest);
  }

  /**
   * onLoad: initialize app on page load with enhanced caching strategy
   */
  function onLoad() {
    
    // Clean up expired cache entries
    cacheManager.cleanupExpiredCache();
    
    // Show initial loading state
    showBulkLoadingState();
    
    // Set flag to track if bulk loading is in progress
    window._bulkLoadingInProgress = true;
    
    // First fetch the student list for immediate display
    google.script.run
      .withSuccessHandler(function(data) {
        // data[0] is headers, data.slice(1) are rows
        window._headers     = data[0];
        window._rows        = data.slice(1);
        window._displayRows = window._rows.slice();

        window._customOrder = getCustomOrder(window._headers);
        
        
        // Check for Â≠ê column
        const childColIndex = window._headers.indexOf('Â≠ê');
        
        // Now load ALL student data in bulk for instant caching
        // The table will render AFTER bulk loading completes
        loadAllStudentDataInBulk();
        
      })
      .withFailureHandler(function(e) {
        console.error('Error fetching students:', e);
        const loadingRow = document.getElementById('loadingRow');
        if (loadingRow) {
          loadingRow.innerHTML = '<td colspan="100%" class="text-center py-8 text-red-600">Error loading students. Please refresh the page.</td>';
        }
      })
      .getStudents();

    // Toggle sidebar collapse/expand
    document.getElementById('toggleSidebarBtn').onclick = function() {
      var sb = document.getElementById('sidebar');
      document.body.classList.toggle('sidebar-collapsed');
    };
  }

  /**
   * Show bulk loading state
   */
  function showBulkLoadingState() {
    
    // Find the students root container
    const studentsRoot = document.getElementById('studentsRoot');
    if (!studentsRoot) {
      return;
    }
    
    // Create loading message if it doesn't exist
    let loadingMessage = document.getElementById('loadingMessage');
    if (!loadingMessage) {
      loadingMessage = document.createElement('div');
      loadingMessage.id = 'loadingMessage';
      loadingMessage.className = 'text-center py-8 text-gray-600';
      loadingMessage.innerHTML = `
        <div class="flex items-center justify-center space-x-2">
          <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
          <span>Loading student data...</span>
        </div>
      `;
      studentsRoot.appendChild(loadingMessage);
    }
    
    // Show loading message
    loadingMessage.style.display = 'block';
  }

  /**
   * Helper function to remove loading message
   */
  function removeLoadingMessage() {
    var loadingMessage = document.getElementById('loadingMessage');
    if (loadingMessage && loadingMessage.parentNode) {
      loadingMessage.remove();
    }
  }

  /**
   * Get student details from cache or fallback to server
   * @param {string|number} studentId - Student ID
   * @returns {Object|null} Student details or null if not found
   */
  function getStudentDetailsFromCache(studentId) {
    if (!studentId) {
      console.log('‚ùå No student ID provided to getStudentDetailsFromCache');
      return null;
    }
    
    var cacheKey = String(studentId).trim();
    
    // First check memory cache (fastest)
    if (window._studentDetailsCache && window._studentDetailsCache[cacheKey]) {
      console.log('‚úÖ Using memory cache for student:', cacheKey);
      return window._studentDetailsCache[cacheKey];
    }
    
    // Then check localStorage cache
    const localStorageKey = `student_${cacheKey}`;
    if (cacheManager.isCacheFresh(localStorageKey, 1800000)) { // 30 minutes
      const cached = cacheManager.get(localStorageKey);
      if (cached) {
        console.log('‚úÖ Using localStorage cache for student:', cacheKey);
        // Also update memory cache for faster future access
        if (window._studentDetailsCache) {
          window._studentDetailsCache[cacheKey] = cached;
        }
        return cached;
      }
    }
    
    // Try alternative keys (in case of type mismatches)
    const alternativeKeys = [
      String(Number(studentId)), // Try numeric version
      Number(studentId).toString(), // Try string version of number
      studentId.toString(), // Try direct toString
      String(studentId) // Try string conversion
    ];
    
    for (const key of alternativeKeys) {
      if (window._studentDetailsCache && window._studentDetailsCache[key]) {
        console.log('‚úÖ Found cached data with alternative key:', key, 'for student:', cacheKey);
        return window._studentDetailsCache[key];
      }
      
      const altLocalKey = `student_${key}`;
      if (cacheManager.isCacheFresh(altLocalKey, 1800000)) {
        const cached = cacheManager.get(altLocalKey);
        if (cached) {
          console.log('‚úÖ Found localStorage cache with alternative key:', key, 'for student:', cacheKey);
          // Update memory cache
          if (window._studentDetailsCache) {
            window._studentDetailsCache[cacheKey] = cached;
          }
          return cached;
        }
      }
    }
    
    console.log('‚ùå No cached data found for student:', cacheKey);
    return null;
  }

  /**
   * Update cache when new data is added (called from other scripts)
   * @param {string} type - Type of data ('note', 'payment', 'student')
   * @param {Object} data - The new data
   */
  function updateCache(type, data) {
    if (!window._studentDetailsCache) {
      console.log('‚ö†Ô∏è Cache not initialized, skipping update');
      return;
    }
    
    var studentId = String(data['Student ID'] || data['ID']);
    if (!studentId) {
      console.log('‚ö†Ô∏è No student ID found in data:', data);
      return;
    }
    
    console.log('üîÑ Updating cache for student:', studentId, 'type:', type);
    
    // Refresh the specific student's data from server
    google.script.run
      .withSuccessHandler(function(studentData) {
        if (studentData && studentData.student) {
          // Update memory cache
          window._studentDetailsCache[studentId] = studentData;
          
          // Update localStorage cache with 30-minute TTL
          const localStorageKey = `student_${studentId}`;
          cacheManager.set(localStorageKey, studentData, 1800000); // 30 minutes
          
          console.log('‚úÖ Cache updated for student:', studentId, '(memory + localStorage)');
        } else {
          console.log('‚ö†Ô∏è No student data returned for cache update:', studentId);
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to update cache for student:', studentId, error);
      })
      .getStudentDetailsOptimized(studentId);
  }

  /**
   * Load all student data in bulk for caching
   */
  function loadAllStudentDataInBulk() {
    
    // Get all student IDs from the current table data
    const studentIds = [];
    const idIdx = window._headers.indexOf('ID');
    
    if (idIdx === -1) {
      console.error('‚ùå ID column not found in headers');
      return;
    }
    
    // Extract student IDs from table rows, but only count Active students
    const statusIdx = window._headers.indexOf('Status');
    let activeStudentIds = [];
    
    window._rows.forEach(row => {
      if (row[idIdx]) {
        const studentId = String(row[idIdx]).trim();
        const status = row[statusIdx];
        
        if (status === 'Active') {
          activeStudentIds.push(studentId);
        }
        studentIds.push(studentId); // Keep all for display
      }
    });
    
    
    if (studentIds.length === 0) {
      return;
    }
    
    // Update loading message to show progress
    const loadingMessage = document.getElementById('loadingMessage');
    if (loadingMessage) {
      loadingMessage.innerHTML = `
        <div class="flex flex-col items-center justify-center space-y-3">
          <div class="flex items-center space-x-2">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
            <span class="text-lg font-medium">Loading all student data...</span>
          </div>
          <div class="text-sm text-gray-600">
            Caching ${activeStudentIds.length} Active students with payments and notes for instant access
          </div>
          <div class="text-xs text-gray-500">
            This may take a moment - please wait until loading completes
          </div>
        </div>
      `;
    }
    
    // Track loading progress
    let loadingStartTime = Date.now();
    let progressUpdateInterval;
    
    // Start progress updates
    progressUpdateInterval = setInterval(() => {
      if (loadingMessage) {
        const elapsed = Math.round((Date.now() - loadingStartTime) / 1000);
        loadingMessage.innerHTML = `
          <div class="flex flex-col items-center justify-center space-y-3">
            <div class="flex items-center space-x-2">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
              <span class="text-lg font-medium">Loading all student data...</span>
            </div>
            <div class="text-sm text-gray-600">
              Caching ${activeStudentIds.length} Active students with payments and notes for instant access
            </div>
            <div class="text-xs text-gray-500">
              Loading... ${elapsed}s elapsed - please wait until loading completes
            </div>
          </div>
        `;
      }
    }, 1000);
    
    // Use the batched version to avoid timeouts
    google.script.run
      .withSuccessHandler(function(allStudentData) {
        // Clear progress updates
        if (progressUpdateInterval) {
          clearInterval(progressUpdateInterval);
        }
        
        // Clear bulk loading flag
        window._bulkLoadingInProgress = false;
        
        
        if (!allStudentData || Object.keys(allStudentData).length === 0) {
          return;
        }
        
        // Store in both memory cache and localStorage
        let cachedCount = 0;
        Object.keys(allStudentData).forEach(studentId => {
          const data = allStudentData[studentId];
          
          if (data && data.student) {
            // Store in memory cache
            if (window._studentDetailsCache) {
              window._studentDetailsCache[studentId] = data;
            }
            
            // Store in localStorage with 30-minute TTL
            const localStorageKey = `student_${studentId}`;
            cacheManager.set(localStorageKey, data, 1800000); // 30 minutes
            cachedCount++;
          }
        });
        
        console.log(`üíæ Successfully cached data for ${cachedCount} students in memory and localStorage`);
        
        // Show cache statistics
        const stats = cacheManager.getStats();
        console.log('üìà Cache Stats:', stats);
        
        // Remove loading message immediately
        removeLoadingMessage();
        
        // NOW render the table since all data is cached
        console.log('üéØ Rendering table with fully cached data...');
        renderTable();
        hookSearch();
        
        // Auto-focus search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) { 
          searchInput.focus(); 
          searchInput.select(); 
        }
        
        // Update loading message to show completion and hide after a moment
        if (loadingMessage) {
          const totalTime = Math.round((Date.now() - loadingStartTime) / 1000);
          loadingMessage.innerHTML = `
            <div class="flex flex-col items-center justify-center space-y-3">
              <div class="flex items-center space-x-2 text-green-600">
                <div class="w-6 h-6 rounded-full bg-green-600 flex items-center justify-center">
                  <span class="text-white text-xs">‚úì</span>
                </div>
                <span class="text-lg font-medium">All student data loaded and cached!</span>
              </div>
              <div class="text-sm text-gray-600">
                ${cachedCount} students cached with payments and notes (${totalTime}s)
              </div>
              <div class="text-xs text-green-600 font-medium">
                Ready to use - no more loading delays today!
              </div>
            </div>
          `;
          
          // Loading message already removed when table rendered
        }
      })
      .withFailureHandler(function(error) {
        // Clear progress updates
        if (progressUpdateInterval) {
          clearInterval(progressUpdateInterval);
        }
        
        // Clear bulk loading flag
        window._bulkLoadingInProgress = false;
        
        console.error('‚ùå Bulk data load failed:', error);
        console.log('üîÑ Falling back to individual student loading...');
        
        // Remove loading message immediately
        removeLoadingMessage();
        
        // Render table even if bulk loading failed
        console.log('üéØ Rendering table (bulk loading failed, will load individually)...');
        renderTable();
        hookSearch();
        
        // Auto-focus search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) { 
          searchInput.focus(); 
          searchInput.select(); 
        }
        
        // Update loading message to show error
        if (loadingMessage) {
          loadingMessage.innerHTML = `
            <div class="flex items-center justify-center space-x-2 text-yellow-600">
              <div class="w-6 h-6 rounded-full bg-yellow-600 flex items-center justify-center">
                <span class="text-white text-xs">!</span>
              </div>
              <span>Bulk load failed - students will load individually when accessed</span>
            </div>
          `;
          
          // Loading message already removed when table rendered
        }
      })
      .getAllStudentDataForCacheBatched(20); // Use batched version with 20 students per batch
  }

  /**
   * Preload individual student data when bulk loading fails or is incomplete
   * @param {string|number} studentId - Student ID to preload
   */
  function preloadStudentData(studentId) {
    // Check if we're already preloading this student
    if (window._preloadingStudents && window._preloadingStudents[studentId]) {
      console.log('‚è≥ Already preloading student:', studentId);
      return;
    }
    
    // Mark as preloading
    if (!window._preloadingStudents) {
      window._preloadingStudents = {};
    }
    window._preloadingStudents[studentId] = true;
    
    console.log('üîÑ Preloading data for student:', studentId);
    
    google.script.run
      .withSuccessHandler(function(studentData) {
        // Remove preloading flag
        if (window._preloadingStudents) {
          delete window._preloadingStudents[studentId];
        }
        
        if (studentData && studentData.student) {
          // Store in memory cache
          if (window._studentDetailsCache) {
            window._studentDetailsCache[studentId] = studentData;
          }
          
          // Store in localStorage with 30-minute TTL
          const localStorageKey = `student_${studentId}`;
          cacheManager.set(localStorageKey, studentData, 1800000); // 30 minutes
          
          console.log('‚úÖ Preloaded and cached data for student:', studentId);
          
          // If this student's modal is currently open, update it with cached data
          const currentModal = document.getElementById('detailsModalRoot');
          if (currentModal && !currentModal.classList.contains('hidden')) {
            // Check if this is the same student
            const modalStudentId = document.querySelector('[data-student-id]');
            if (modalStudentId && modalStudentId.getAttribute('data-student-id') === String(studentId)) {
              console.log('üîÑ Updating currently open modal with preloaded data');
              if (typeof loadStudent === 'function') {
                loadStudent(studentData);
              }
            }
          }
        } else {
          console.warn('‚ö†Ô∏è No data returned for preload of student:', studentId);
        }
      })
      .withFailureHandler(function(error) {
        // Remove preloading flag on error
        if (window._preloadingStudents) {
          delete window._preloadingStudents[studentId];
        }
        console.error('‚ùå Failed to preload data for student:', studentId, error);
      })
      .getStudentDetailsOptimized(studentId);
  }

  /**
   * Debug function to check cache status
   * @param {string|number} studentId - Optional student ID to check
   */
  function debugCache(studentId = null) {
    console.log('Cache initialized:', !!window._studentDetailsCache);
    console.log('Cache type:', typeof window._studentDetailsCache);
    
    if (window._studentDetailsCache) {
      console.log('Total cached students:', Object.keys(window._studentDetailsCache).length);
      console.log('Cache keys:', Object.keys(window._studentDetailsCache));
      
      if (studentId) {
        const normalizedId = String(studentId).trim();
        console.log('Looking for student:', normalizedId);
        console.log('Direct lookup:', window._studentDetailsCache[normalizedId]);
        
        // Try alternative keys
        const alternativeKeys = [
          String(Number(studentId)),
          Number(studentId).toString(),
          studentId.toString(),
          String(studentId)
        ];
        
        for (const key of alternativeKeys) {
          if (window._studentDetailsCache[key]) {
            console.log('Found with key:', key, 'Data:', window._studentDetailsCache[key]);
          }
        }
      }
    }
    
    // Show localStorage cache stats
    const stats = cacheManager.getStats();
    console.log('üìà localStorage Cache Stats:', stats);
  }

  /**
   * Refresh the student list from the server
   * This function can be called after adding/updating students
   */
  window.refreshStudentList = function() {
    console.log('üîÑ Refreshing student list...');
    
    // Show loading state
    const tbody = document.getElementById('studentTable');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-8"><div class="flex justify-center items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><span class="ml-2 text-gray-600">Refreshing students...</span></div></td></tr>';
    }
    
    // Fetch fresh data from server
    google.script.run
      .withSuccessHandler(function(data) {
        // Update the global data
        window._headers = data[0];
        window._rows = data.slice(1);
        window._displayRows = window._rows.slice();
        window._customOrder = getCustomOrder(window._headers);
        
        // Re-render the table
        renderTable();
        hookSearch();
        
        console.log('‚úÖ Student list refreshed successfully');
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to refresh student list:', error);
        
        // Show error message
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-8 text-red-600">Failed to refresh students. Please try again.</td></tr>';
        }
      })
      .getStudents();
  };



  /**
   * renderTable: display the filtered & sorted rows in the table body
   */
  function renderTable() {
    var tbody = document.getElementById('studentTable');
    tbody.innerHTML = '';
    if (!window._displayRows.length) {
      tbody.innerHTML = '<tr><td colspan="'+window._headers.length+'" class="text-center text-gray-500 py-6">No students found.</td></tr>';
      return;
    }
    var idIdx = window._headers.indexOf('ID');
    var order = window._customOrder || window._headers;
    window._displayRows.forEach(function(row) {
      var tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.setAttribute('data-student-id', row[idIdx]);
      tr.onclick = function() { 
        console.log('üñ±Ô∏è Row clicked, ID index:', idIdx, 'Row ID value:', row[idIdx], 'Type:', typeof row[idIdx]);
        openStudentDetails(row[idIdx]); 
      };
      
      order.forEach(function(h, i) {
        var colIdx = window._headers.indexOf(h);
        var td = document.createElement('td');
        
        // Add sticky class to ID column
        if (h === 'ID') {
          td.className = 'sticky-col';
        }
        
        var cellValue = row[colIdx] || '';
        
                 // Handle different column types
         switch(h) {
          case 'ÂΩìÊó•„Ç≠„É£„É≥„Çª„É´':
            var badgeClass = cellValue === 'Ê∏à' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
            td.innerHTML = '<span class="' + badgeClass + '">' + cellValue + '</span>';
            td.style.textAlign = 'center';
            td.className = 'text-center';
            break;
            
          case 'Status':
            var statusClass = '';
            switch(cellValue) {
              case 'Active': statusClass = 'badge badge-status-active'; break;
              case 'Dormant': statusClass = 'badge badge-status-dormant'; break;
              case 'DEMO': statusClass = 'badge badge-status-demo'; break;
              default: statusClass = 'badge badge-status-dormant';
            }
            td.innerHTML = '<span class="' + statusClass + '">' + cellValue + '</span>';
            td.style.textAlign = 'center';
            break;
            
                     case 'Payment':
             var paymentClass = cellValue === 'NEO' ? 'badge badge-pay-neo' : 'badge badge-pay-old';
             td.innerHTML = '<span class="' + paymentClass + '">' + cellValue + '</span>';
             td.style.textAlign = 'center';
             break;
             
           case 'Group':
             var groupClass = cellValue === 'Individual' ? 'badge badge-group-individual' : 'badge badge-group-group';
             td.innerHTML = '<span class="' + groupClass + '">' + cellValue + '</span>';
             td.style.textAlign = 'center';
             break;
             
           case 'ÂΩìÊó• Cancellation':
             var cancelClass = cellValue === 'Ê∏à' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
             td.innerHTML = '<span class="' + cancelClass + '">' + cellValue + '</span>';
             td.style.textAlign = 'center';
             break;
             
                      case 'email':
            td.innerHTML = '<span class="truncate" title="' + cellValue + '">' + cellValue + '</span>';
            break;
            
          case 'phone':
            td.innerHTML = '<span class="truncate" title="' + cellValue + '">' + cellValue + '</span>';
            td.style.textAlign = 'center';
            break;
            
                     case 'Â≠ê':
             // Simply check if the value is the character 'Â≠ê'
             td.innerHTML = cellValue === 'Â≠ê' ? 'Â≠ê' : '';
             td.style.textAlign = 'center';
             break;
            
          case '‰∫∫Êï∞':
            td.style.textAlign = 'center';
            td.textContent = cellValue;
            break;
            
                     default:
             // Catch-all for any cancellation column that wasn't caught above
             if (h.includes('ÂΩìÊó•') || h.includes('Cancellation') || h.includes('„Ç≠„É£„É≥„Çª„É´')) {
               var cancelClass = cellValue === 'Ê∏à' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
               td.innerHTML = '<span class="' + cancelClass + '">' + cellValue + '</span>';
               td.style.textAlign = 'center';
             } else {
               td.textContent = cellValue;
             }
        }
        
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  /**
   * hookSearch: filter rows as user types in search box
   */
  function hookSearch() {
    document.getElementById('searchInput').oninput = function() {
      var q = this.value.trim().toLowerCase();
      window._displayRows = q
        ? window._rows.filter(r => r.some(c => String(c).toLowerCase().includes(q)))
        : window._rows.slice();
      sortDisplayRows();
      renderTable();
    };
  }

  /**
   * sortDisplayRows: helper to sort window._displayRows based on current sort settings
   */
  function sortDisplayRows() {
    if (window._sortCol === null) return;
    var h = window._headers[window._sortCol];
    window._displayRows.sort(function(a, b) {
      var v1 = a[window._sortCol], v2 = b[window._sortCol];
      // ID: numeric sort
      if (h === 'ID') {
        return window._sortAsc ? (Number(v1) - Number(v2)) : (Number(v2) - Number(v1));
      }
      // Status: custom order, then by Name
      if (h === 'Status') {
        var idx1 = statusOrder.indexOf(v1);
        var idx2 = statusOrder.indexOf(v2);
        if (idx1 === -1) idx1 = statusOrder.length;
        if (idx2 === -1) idx2 = statusOrder.length;
        if (idx1 !== idx2) return window._sortAsc ? idx1 - idx2 : idx2 - idx1;
        // Secondary sort by Name
        var nameIdx = window._headers.indexOf('Name');
        var n1 = a[nameIdx] || '';
        var n2 = b[nameIdx] || '';
        return window._sortAsc ? n1.localeCompare(n2) : n2.localeCompare(n1);
      }
      // Default: string sort
      if (v1 == v2) return 0;
      if (window._sortAsc) return v1 > v2 ? 1 : -1;
      return v1 < v2 ? 1 : -1;
    });
  }

  // Global utility functions for cache management
  window.clearAllCache = function() {
    console.log('üóëÔ∏è Clearing all cache...');
    
    // Clear memory cache
    if (window._studentDetailsCache) {
      window._studentDetailsCache = {};
    }
    
    // Clear localStorage cache
    cacheManager.clearAll();
    
    console.log('‚úÖ All cache cleared');
  };

  window.getCacheStats = function() {
    const memoryStats = {
      totalEntries: window._studentDetailsCache ? Object.keys(window._studentDetailsCache).length : 0,
      keys: window._studentDetailsCache ? Object.keys(window._studentDetailsCache) : []
    };
    
    const localStorageStats = cacheManager.getStats();
    
    console.log('üìä Memory Cache Stats:', memoryStats);
    console.log('üìä localStorage Cache Stats:', localStorageStats);
    
    return {
      memory: memoryStats,
      localStorage: localStorageStats
    };
  };

  window.cleanupCache = function() {
    console.log('üßπ Cleaning up expired cache entries...');
    cacheManager.cleanupExpiredCache();
    console.log('‚úÖ Cache cleanup completed');
  };

  window.testCache = function(studentId = null) {
    if (!studentId) {
      // Test with first available student ID
      const idIdx = window._headers.indexOf('ID');
      if (idIdx !== -1 && window._rows.length > 0) {
        studentId = window._rows[0][idIdx];
      }
    }
    
    if (!studentId) {
      console.log('‚ùå No student ID available for testing');
      return;
    }
    
    console.log('üß™ Testing cache for student:', studentId);
    
    // Test memory cache
    const memoryResult = getStudentDetailsFromCache(studentId);
    console.log('Memory cache result:', memoryResult ? '‚úÖ Found' : '‚ùå Not found');
    
    // Test localStorage directly
    const localStorageKey = `student_${studentId}`;
    const localStorageResult = cacheManager.get(localStorageKey);
    console.log('localStorage result:', localStorageResult ? '‚úÖ Found' : '‚ùå Not found');
    
    // Test cache freshness
    const isFresh = cacheManager.isCacheFresh(localStorageKey, 1800000);
    console.log('Cache freshness:', isFresh ? '‚úÖ Fresh' : '‚ùå Expired');
    
    return {
      memory: memoryResult,
      localStorage: localStorageResult,
      isFresh: isFresh
    };
  };

  // Make cacheManager globally accessible for debugging
  window.cacheManager = cacheManager;
  
  // Global function to manually trigger bulk loading
  window.triggerBulkLoad = function() {
    console.log('üîÑ Manually triggering bulk data load...');
    loadAllStudentDataInBulk();
  };
  
  // Global function to clear cache for a specific student
  window.clearStudentCache = function(studentId) {
    console.log('üóëÔ∏è Clearing cache for student ID: ' + studentId);
    if (window._studentDetailsCache && window._studentDetailsCache[studentId]) {
      delete window._studentDetailsCache[studentId];
      console.log('‚úÖ Cleared memory cache for student ' + studentId);
    }
    if (window.cacheManager) {
      window.cacheManager.remove('student_' + studentId);
      console.log('‚úÖ Cleared localStorage cache for student ' + studentId);
    }
  };
  
  // Global function to preload specific student
  window.preloadStudent = function(studentId) {
    if (!studentId) {
      console.log('‚ùå Please provide a student ID');
      return;
    }
    preloadStudentData(studentId);
  };
  
  // Global function to check bulk loading status
  window.checkBulkLoadingStatus = function() {
    console.log('üîç Bulk Loading Status:');
    console.log('Bulk loading in progress:', window._bulkLoadingInProgress);
    console.log('Memory cache entries:', window._studentDetailsCache ? Object.keys(window._studentDetailsCache).length : 0);
    console.log('localStorage cache entries:', cacheManager.getStats().activeEntries);
    
    if (window._bulkLoadingInProgress) {
      console.log('‚è≥ Bulk loading is still in progress - please wait');
    } else {
      console.log('‚úÖ Bulk loading completed or not started');
    }
    
    return {
      inProgress: window._bulkLoadingInProgress,
      memoryCacheCount: window._studentDetailsCache ? Object.keys(window._studentDetailsCache).length : 0,
      localStorageCacheCount: cacheManager.getStats().activeEntries
    };
  };
  
  // Clear localStorage on page load for testing
  localStorage.clear();
  if (window._studentDetailsCache) {
    window._studentDetailsCache = {};
  }
</script>