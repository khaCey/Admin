<!DOCTYPE html>
<html lang="en-GB">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Admin – Isolated Nav + Students</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <?!= include('Styles'); ?>
</head>
<body class="bg-gray-100">
  <!-- Fixed top navbar -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-green-600 text-white shadow-lg">
    <div class="flex items-center justify-between px-4 py-3">
      <div class="flex items-center">
        <button class="p-2 hover:bg-green-700 rounded-lg transition-colors mr-3" id="toggleSidebarBtn" aria-label="Toggle sidebar">
          <i id="sidebarMenuIcon" data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <a class="text-xl font-semibold" href="#" id="navbarBrand">Green Square</a>
      </div>
      <div class="flex items-center space-x-3">
        <button class="px-4 py-2 border border-white text-white rounded-lg hover:bg-white hover:text-green-600 transition-colors flex items-center space-x-2" onclick="showForm()">
          <i data-lucide="user-plus" class="w-4 h-4"></i>
          <span>Add Student</span>
        </button>
        <button id="newFeatureBtn" class="px-4 py-2 border border-white text-white rounded-lg hover:bg-white hover:text-green-600 transition-colors flex items-center space-x-2">
          <i data-lucide="alert-circle" class="w-4 h-4"></i>
          <span>未納</span>
        </button>
        <button id="unscheduledBtn" class="px-4 py-2 border border-white text-white rounded-lg hover:bg-white hover:text-green-600 transition-colors flex items-center space-x-2">
          <i data-lucide="calendar-x" class="w-4 h-4"></i>
          <span>未定</span>
        </button>
        <div class="relative notification-wrapper">
          <button id="notifBtn" type="button" class="px-4 py-2 border border-white text-white rounded-lg hover:bg-white hover:text-green-600 transition-colors flex items-center space-x-2" onclick="toggleNotifications()">
            <i data-lucide="bell" class="w-4 h-4"></i>
          </button>
          <span id="notifCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
          <div id="notifMenu" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 hidden z-50">
            <div class="px-4 py-2 border-b border-gray-200 font-semibold text-gray-700">Notifications</div>
            <div id="notifList" class="max-h-64 overflow-y-auto"></div>
            <div class="border-t border-gray-200"></div>
            <button id="viewAllBtn" class="w-full px-4 py-2 text-left text-green-600 hover:bg-gray-50">View All</button>
            <button id="newNotifBtn" class="w-full px-4 py-2 text-left text-green-600 hover:bg-gray-50">New Notification</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar (Students only) -->
  <nav id="sidebar" class="fixed top-16 left-0 h-screen w-64 bg-gray-50 border-r border-gray-200 transition-transform duration-300 z-40 transform -translate-x-full">
      <div class="p-4">
        <ul>
<li>
            <a class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-green-100 hover:text-green-700 rounded-lg transition-colors active:bg-green-600 active:text-white" href="#" onclick="showStudents(); return false;">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Students</span>
            </a>
          </li>
          <li>
            <a class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-green-100 hover:text-green-700 rounded-lg transition-colors" href="#" onclick="showCodePage(); return false;">
              <i data-lucide="code" class="w-5 h-5"></i>
              <span>Code</span>
            </a>
          </li>
</ul>
      </div>
    </nav>

  <!-- Main content -->
  <main id="mainContent" class="pt-16 h-screen bg-gray-100 transition-all duration-300 w-full sidebar-content flex flex-col">
    <div class="p-6 w-full flex flex-col h-full">
      <!-- Students view will be injected here -->
      <div id="studentsRoot"></div>
    </div>
  </main>

  <!-- Code page content (hidden by default) -->
  <div id="codePage" class="pt-16 h-screen bg-gray-100 transition-all duration-300 w-full sidebar-content flex flex-col" style="display: none;">
    <div class="p-6 w-full flex flex-col h-full">
      <div class="max-w-7xl mx-auto w-full">
        <!-- Page Header -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900">Code Management</h1>
          <p class="text-gray-600 mt-2">Manage and view your Google Apps Script code</p>
        </div>

        <!-- Code Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="p-2 bg-blue-100 rounded-lg">
                <i data-lucide="upload" class="w-6 h-6 text-blue-600"></i>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 ml-3">Push Code</h3>
            </div>
            <p class="text-gray-600 mb-4">Deploy your local changes to Google Apps Script</p>
            <button onclick="pushCode()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
              Push to Apps Script
            </button>
          </div>

          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="p-2 bg-green-100 rounded-lg">
                <i data-lucide="download" class="w-6 h-6 text-green-600"></i>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 ml-3">Pull Code</h3>
            </div>
            <p class="text-gray-600 mb-4">Download the latest code from Google Apps Script</p>
            <button onclick="pullCode()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
              Pull from Apps Script
            </button>
          </div>

          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="p-2 bg-purple-100 rounded-lg">
                <i data-lucide="git-branch" class="w-6 h-6 text-purple-600"></i>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 ml-3">Version Control</h3>
            </div>
            <p class="text-gray-600 mb-4">Manage code versions and deployments</p>
            <button onclick="showVersions()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
              View Versions
            </button>
          </div>
        </div>

        <!-- Code Status -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Code Status</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-sm font-medium text-gray-500 mb-2">Last Push</h3>
              <p class="text-lg font-semibold text-gray-900" id="lastPushTime">Never</p>
            </div>
            <div>
              <h3 class="text-sm font-medium text-gray-500 mb-2">Status</h3>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="codeStatus">
                Up to date
              </span>
            </div>
          </div>
        </div>

        <!-- Recent Changes -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Changes</h2>
          <div class="space-y-4" id="recentChanges">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div class="flex items-center">
                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                <div>
                  <p class="font-medium text-gray-900">Fixed lesson grouping logic</p>
                  <p class="text-sm text-gray-500">Updated frontend to group lessons by eventID</p>
                </div>
              </div>
              <span class="text-sm text-gray-500">2 hours ago</span>
            </div>
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div class="flex items-center">
                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                <div>
                  <p class="font-medium text-gray-900">Added EventID to backend</p>
                  <p class="text-sm text-gray-500">Updated getExistingLessonsFromSheet to include eventID</p>
                </div>
              </div>
              <span class="text-sm text-gray-500">4 hours ago</span>
            </div>
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div class="flex items-center">
                <div class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></div>
                <div>
                  <p class="font-medium text-gray-900">Fixed card positioning</p>
                  <p class="text-sm text-gray-500">Updated card positioning logic to use unique lessons count</p>
                </div>
              </div>
              <span class="text-sm text-gray-500">6 hours ago</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loader overlay -->
  <div id="loader" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
  </div>

  <?!= include('HelperFunctions'); ?>
  <?!= include('ListScripts'); ?>

  <script>
    // Minimal showStudents() to render the Students include into mainContent
    function showStudents() { 
      google.script.run.withSuccessHandler(function(html) {
        document.getElementById('mainContent').innerHTML = html;
        // Run Students' initialiser (scripts inside includes won't auto-execute after innerHTML)
        if (typeof onLoad === 'function') { try { onLoad(); } catch(e){ console.error(e); } }
        if (window.lucide && lucide.createIcons) lucide.createIcons();
        }).include('Students');
    }
    document.addEventListener('DOMContentLoaded', function() {
      // icons + initial view
      if (window.lucide && lucide.createIcons) lucide.createIcons();
      showStudents();
      
      // New Feature Modal functionality
      const newFeatureBtn = document.getElementById('newFeatureBtn');
      const newFeatureModal = document.getElementById('newFeatureModal');
      const newFeatureClose = document.getElementById('newFeatureClose');
      const newFeatureCancel = document.getElementById('newFeatureCancel');
      const newFeatureOK = document.getElementById('newFeatureOK');
      
      // Open modal
      if (newFeatureBtn) {
        newFeatureBtn.addEventListener('click', function() {
          newFeatureModal.classList.remove('hidden');
          // Re-initialize icons after showing modal
          if (window.lucide && lucide.createIcons) lucide.createIcons();
          // Load unpaid students data
          loadUnpaidStudents();
        });
      }
      
      // Refresh button functionality
      const refreshUnpaidBtn = document.getElementById('refreshUnpaidBtn');
      if (refreshUnpaidBtn) {
        refreshUnpaidBtn.addEventListener('click', function() {
          loadUnpaidStudents();
        });
      }
      
      // Unscheduled button functionality
      const unscheduledBtn = document.getElementById('unscheduledBtn');
      if (unscheduledBtn) {
        unscheduledBtn.addEventListener('click', function() {
          newFeatureModal.classList.remove('hidden');
          // Re-initialize icons after showing modal
          if (window.lucide && lucide.createIcons) lucide.createIcons();
          // Load unscheduled students data
          loadUnscheduledStudents();
        });
      }
      
      // Book Lesson button functionality
      const bookLessonBtn = document.getElementById('bookLessonBtn');
      if (bookLessonBtn) {
        bookLessonBtn.addEventListener('click', function() {
          // Get current student data from the global student object
          console.log('Book lesson button clicked. Current student:', window.student);
          console.log('Student ID check:', window.student?.ID || window.student?.id);
          
          if (window.student && (window.student.ID || window.student.id)) {
            openBookLessonModal({ 
              student: window.student,
              onClose: () => {
                console.log('Book lesson modal closed');
              }
            });
          } else {
            alert('Please select a student first to book a lesson.');
          }
        });
      }
      
      // Function to load unpaid students from Unpaid sheet
      function loadUnpaidStudents() {
        const tableBody = document.getElementById('unpaidStudentsTableBody');
        const countElement = document.getElementById('unpaidCount');
        const countContainer = document.getElementById('unpaidStudentsCount');
        const modalTitle = document.getElementById('modalTitle');
        const modalHeaderText = document.getElementById('modalHeaderText');
        
        // Update modal title
        if (modalTitle) modalTitle.textContent = 'Unpaid Students';
        if (modalHeaderText) modalHeaderText.textContent = 'Students with Outstanding Payments';
        
        // Show loading state
        tableBody.innerHTML = `
          <tr>
            <td class="px-3 py-2 text-center text-gray-500">
              <div class="flex justify-center items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                <span class="ml-2 text-gray-600">Loading unpaid students...</span>
              </div>
            </td>
          </tr>
        `;
        if (window.lucide && lucide.createIcons) lucide.createIcons();
        
        // Fetch data from LessonsMonth sheet
        google.script.run
          .withSuccessHandler(function(data) {
            if (data && data.length > 0) {
              // Clear loading state
              tableBody.innerHTML = '';
              
              // Populate table with student names
              data.forEach(function(student) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.setAttribute('data-student-id', student.id);
                
                row.innerHTML = `
                  <td class="px-3 py-2 text-left text-sm text-gray-900">
                    ${student.name || 'Unknown'}
                  </td>
                `;
                
                // Add click handler to open student details
                row.addEventListener('click', function() {
                  const studentId = this.getAttribute('data-student-id');
                  if (studentId && typeof openStudentDetails === 'function') {
                    openStudentDetails(studentId);
                    closeNewFeatureModal();
                  }
                });
                
                tableBody.appendChild(row);
              });
              
              // Update count
              if (countElement) countElement.textContent = data.length;
              if (countContainer) countContainer.classList.remove('hidden');
            } else {
              // No unpaid students found
              tableBody.innerHTML = `
                <tr>
                  <td class="px-3 py-2 text-center text-gray-500">
                    <div class="flex justify-center items-center">
                      <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                      <span class="ml-2">All students are up to date with payments!</span>
                    </div>
                  </td>
                </tr>
              `;
              if (countElement) countElement.textContent = '0';
              if (countContainer) countContainer.classList.remove('hidden');
            }
            
            // Re-initialize icons
            if (window.lucide && lucide.createIcons) lucide.createIcons();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading unpaid students:', error);
            tableBody.innerHTML = `
              <tr>
                <td class="px-3 py-2 text-center text-red-500">
                  <div class="flex justify-center items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span class="ml-2">Error loading data. Please try again.</span>
                  </div>
                </td>
              </tr>
            `;
            if (window.lucide && lucide.createIcons) lucide.createIcons();
          })
          .getUnpaidStudents();
      }
      
      // Function to load unscheduled students from LessonsMonth sheet
      function loadUnscheduledStudents() {
        const tableBody = document.getElementById('unpaidStudentsTableBody');
        const countElement = document.getElementById('unpaidCount');
        const countContainer = document.getElementById('unpaidStudentsCount');
        const modalTitle = document.getElementById('modalTitle');
        const modalHeaderText = document.getElementById('modalHeaderText');
        
        // Update modal title
        if (modalTitle) modalTitle.textContent = 'Unscheduled Students';
        if (modalHeaderText) modalHeaderText.textContent = 'Students with no Appointments this month';
        
        // Show loading state
        tableBody.innerHTML = `
          <tr>
            <td class="px-3 py-2 text-center text-gray-500">
              <div class="flex justify-center items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                <span class="ml-2 text-gray-600">Loading unscheduled students...</span>
              </div>
            </td>
          </tr>
        `;
        if (window.lucide && lucide.createIcons) lucide.createIcons();
        
        // Fetch data from LessonsMonth sheet
        google.script.run
          .withSuccessHandler(function(data) {
            if (data && data.length > 0) {
              // Clear loading state
              tableBody.innerHTML = '';
              
              // Populate table with student names
              data.forEach(function(student) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.setAttribute('data-student-id', student.id);
                
                row.innerHTML = `
                  <td class="px-3 py-2 text-left text-sm text-gray-900">
                    ${student.name || 'Unknown'}
                  </td>
                `;
                
                // Add click handler to open student details
                row.addEventListener('click', function() {
                  const studentId = this.getAttribute('data-student-id');
                  if (studentId && typeof openStudentDetails === 'function') {
                    openStudentDetails(studentId);
                    closeNewFeatureModal();
                  }
                });
                
                tableBody.appendChild(row);
              });
              
              // Update count
              if (countElement) countElement.textContent = data.length;
              if (countContainer) countContainer.classList.remove('hidden');
            } else {
              // No unscheduled students found
              tableBody.innerHTML = `
                <tr>
                  <td class="px-3 py-2 text-center text-gray-500">
                    <div class="flex justify-center items-center">
                      <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                      <span class="ml-2">All students have scheduled lessons!</span>
                    </div>
                  </td>
                </tr>
              `;
              if (countElement) countElement.textContent = '0';
              if (countContainer) countContainer.classList.remove('hidden');
            }
            
            // Re-initialize icons
            if (window.lucide && lucide.createIcons) lucide.createIcons();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading unscheduled students:', error);
            tableBody.innerHTML = `
              <tr>
                <td class="px-3 py-2 text-center text-red-500">
                  <div class="flex justify-center items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span class="ml-2">Error loading data. Please try again.</span>
                  </div>
                </td>
              </tr>
            `;
            if (window.lucide && lucide.createIcons) lucide.createIcons();
          })
          .getUnscheduledStudents();
      }
      
      // Close modal functions
      function closeNewFeatureModal() {
        newFeatureModal.classList.add('hidden');
      }
      
      if (newFeatureClose) newFeatureClose.addEventListener('click', closeNewFeatureModal);
      if (newFeatureCancel) newFeatureCancel.addEventListener('click', closeNewFeatureModal);
      if (newFeatureOK) newFeatureOK.addEventListener('click', closeNewFeatureModal);
      
      // Close modal when clicking backdrop
      if (newFeatureModal) {
        newFeatureModal.addEventListener('click', function(e) {
          if (e.target === newFeatureModal) {
            closeNewFeatureModal();
          }
        });
      }
    });
  </script>

  <!-- Details Modal + Popovers + Forms -->
  <div id="detailsModalRoot" class="fixed inset-0 z-[70] flex items-center justify-center p-4 sm:p-8 hidden bg-black bg-opacity-50">
    <div class="relative w-full max-w-[1400px] h-[90vh] rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 overflow-hidden flex flex-col">
      <div id="detailsLoading" class="absolute inset-0 flex items-center justify-center bg-white z-10 hidden">
        <div class="w-12 h-12 rounded-full border-4 border-gray-300 border-t-green-600 animate-spin"></div>
      </div>

      <div class="flex items-start justify-between bg-green-600 text-white px-6 py-4 flex-shrink-0">
        <div class="min-w-0 pr-4">
          <h2 id="studentName" class="text-xl sm:text-2xl font-semibold truncate"></h2>
          <p class="text-white/90 text-sm sm:text-base truncate">
  <span id="studentKanji"></span>
  <span id="studentContact" class="ml-2 text-white/80 text-xs sm:text-sm">
    <span id="studentEmail"></span>
    <span class="mx-1">•</span>
    <span id="studentPhone"></span>
  </span>
</p>
        </div>
        <div class="flex items-center gap-2">
          <span id="statusPill" class="badge">Status</span>
        </div>
      </div>

      <div class="p-4 sm:p-6 flex-1 bg-white overflow-y-auto">
        <div class="grid grid-cols-1 xl:grid-cols-[576px_1fr] gap-6">
          <section id="latestSection" class="rounded-xl border border-gray-200 bg-white shadow-card w-[576px] h-[300px] grid grid-rows-[auto,1fr]">
            <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
              <h3 class="font-semibold">Latest Record</h3>
              <div class="flex items-center gap-2">
                <button id="bookLessonBtn" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Book a Lesson
                </button>
                <div id="lr_monthTabs" class="inline-flex rounded-lg overflow-hidden border border-gray-200"></div>
              </div>
            </header>
            <div class="px-4 py-3 space-y-3">
              <table class="w-full text-sm">
                <tbody id="lr_table"></tbody>
              </table>
              <div class="border-t border-gray-200 my-2"></div>
              <div id="lr_cards" class="gap-2 lr-cards"></div>
            </div>
          </section>

          <section class="rounded-xl border border-gray-200 bg-white shadow h-[300px] flex flex-col">
            <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200 flex-shrink-0">
              <h3 class="font-semibold">All Payments</h3>
              <div class="flex items-center gap-2">
                <button id="addPaymentBtn" class="inline-flex items-center gap-2 rounded-lg bg-green-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-green-700">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14M5 12h14"/></svg>
                  Add Payment
                </button>
              </div>
            </header>
            <div class="flex-1 overflow-y-auto">
              <table class="min-w-full text-sm">
                <thead class="sticky top-0 bg-green-600 text-white">
                  <tr>
                    <th class="px-3 py-2 text-left">Transaction ID</th>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Year</th>
                    <th class="px-3 py-2 text-left">Month</th>
                    <th class="px-3 py-2 text-left">Price</th>
                    <th class="px-3 py-2 text-left">Lessons</th>
                    <th class="px-3 py-2 text-left">Method</th>
                    <th class="px-3 py-2 text-left">Staff</th>
                  </tr>
                </thead>
                <tbody id="paymentsBody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </section>
        </div>

        <section class="mt-5 rounded-xl border border-gray-200 bg-white shadow h-[300px] flex flex-col">
          <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200 flex-shrink-0">
  <h3 class="font-semibold">All Notes</h3>
  <div class="flex items-center gap-2">
    <input id="noteSearch" type="search" placeholder="Search notes"
           class="hidden sm:block w-60 rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-green-500" />
    <button id="addNoteBtn" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium hover:bg-gray-50">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14M5 12h14"/></svg>
      Add Note
    </button>
  </div>
</header>
<div class="flex-1 overflow-y-auto">
            <table class="min-w-full text-sm">
              <thead class="sticky top-0 bg-green-600 text-white">
                <tr><th class="px-3 py-2 text-left">Date</th><th class="px-3 py-2 text-left">Note</th><th class="px-3 py-2 text-left">Staff</th></tr>
              </thead>
              <tbody id="notesBody" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="flex items-center justify-between px-4 sm:px-6 py-4 bg-gray-50 border-t border-gray-200 flex-shrink-0">
        <button id="deleteBtn" class="inline-flex items-center gap-2 rounded-lg bg-red-600 text-white px-4 py-2 text-sm font-semibold hover:bg-red-700">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          Delete
        </button>
        <div class="flex items-center gap-2">
          <button id="editBtn" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold hover:bg-gray-50">Edit</button>
          <button id="closeBtn" class="inline-flex items-center gap-2 rounded-lg bg-gray-800 text-white px-4 py-2 text-sm font-semibold hover:bg-black">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Payment Modal (Add/Edit) ===== -->
  <div id="paymentModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <form id="paymentForm" class="w-full max-w-xl rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 id="paymentModalTitle" class="text-lg font-semibold">Add Payment</h3>
          <button type="button" id="paymentClose" class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs font-medium hover:bg-gray-50">Close</button>
        </header>
        <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
          <div class="sm:col-span-2">
            <label class="block text-gray-600 mb-1">Transaction ID</label>
            <input id="p_txn" name="transactionId" class="w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-100" readonly required />
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Date</label>
            <input id="p_date" name="date" type="date" class="w-full rounded-md border border-gray-300 px-3 py-2" required />
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Lessons</label>
            <input id="p_lessons" name="lessons" type="number" min="0" class="w-full rounded-md border border-gray-300 px-3 py-2" />
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Month</label>
            <select id="p_month" name="month" class="w-full rounded-md border border-gray-300 px-3 py-2">
              <option value="January">January</option>
              <option value="February">February</option>
              <option value="March">March</option>
              <option value="April">April</option>
              <option value="May">May</option>
              <option value="June">June</option>
              <option value="July">July</option>
              <option value="August">August</option>
              <option value="September">September</option>
              <option value="October">October</option>
              <option value="November">November</option>
              <option value="December">December</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Price</label>
            <input id="p_price" name="price" type="number" min="0" step="100" class="w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-100" readonly />
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Method</label>
            <select id="p_method" name="method" class="w-full rounded-md border border-gray-300 px-3 py-2">
              <option>Card</option>
              <option>Cash</option>
              <option>Bank</option>
              <option>PayPay</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Staff</label>
            <input id="p_staff" name="staff" class="w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-100" readonly />
          </div>
        </div>
        <footer class="flex items-center justify-between gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="paymentDelete" class="hidden rounded-md bg-rose-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-rose-700">Delete</button>
          <button type="submit" class="rounded-md bg-green-600 text-white px-4 py-1.5 text-sm font-semibold hover:bg-green-700">Save</button>
        </footer>
      </form>
    </div>
  </div>

  <!-- ===== Lesson Details Modal ===== -->
  <div id="lessonDetailsModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <div class="w-full max-w-md rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 id="lessonDetailsTitle" class="text-lg font-semibold">Lesson Details</h3>
          <button type="button" id="lessonDetailsClose" class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs font-medium hover:bg-gray-50">Close</button>
        </header>
        <div class="p-4 space-y-4">
          <div class="flex items-center gap-3">
            <div id="lessonStatusDot" class="w-3 h-3 rounded-full"></div>
            <span id="lessonStatusText" class="font-medium"></span>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <label class="block text-gray-600 mb-1">Date</label>
              <div id="lessonDate" class="font-medium"></div>
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Time</label>
              <div id="lessonTime" class="font-medium"></div>
            </div>
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Notes</label>
            <div id="lessonNotes" class="text-sm text-gray-700 bg-gray-50 rounded-md p-3 min-h-[60px]">
              No additional notes available.
            </div>
          </div>
        </div>
        <footer class="flex items-center justify-between px-4 py-3 border-t border-gray-200">
          <div class="flex gap-2">
            <button type="button" id="lessonCancelBtn" class="rounded-md border border-red-300 bg-red-50 px-3 py-1.5 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
              Cancel
            </button>
            <button type="button" id="lessonRescheduleBtn" class="rounded-md border border-blue-300 bg-blue-50 px-3 py-1.5 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Reschedule
            </button>
            <button type="button" id="lessonRemoveBtn" class="rounded-md border border-gray-300 bg-gray-50 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
              Remove
            </button>
          </div>
          <button type="button" id="lessonDetailsCancel" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- ===== Book Lesson Modal ===== -->
  <div id="bookLessonModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <div class="w-full max-w-6xl rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <div>
            <h3 id="bookLessonTitle" class="text-xl font-semibold text-gray-900">Book a New Lesson</h3>
            <p id="bookLessonStudentInfo" class="text-sm text-gray-600 mt-1">Loading student information...</p>
          </div>
          <button type="button" id="bookLessonClose" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Close</button>
        </header>
        
        <div class="p-6">
          <!-- Week Navigation -->
          <div class="flex items-center justify-between mb-6">
            <button type="button" id="prevWeekBtn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Previous Week
            </button>
            <h4 id="currentWeekDisplay" class="text-lg font-semibold text-gray-900">Week of [Date]</h4>
            <button type="button" id="nextWeekBtn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              Next Week
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>

          <!-- Calendar Grid -->
          <div class="bg-white overflow-hidden">
            <!-- Calendar Body - Scrollable (with sticky header inside) -->
            <div class="overflow-y-auto" style="max-height: 70vh; min-height: 400px;">
              <!-- Calendar Header - Sticky -->
              <div class="sticky top-0 z-10 grid grid-cols-8 bg-green-600 text-white">
                <div class="px-4 py-3 text-sm font-semibold text-center">Time</div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="0">
                  <div>MON</div>
                  <div id="date-0" class="text-xs font-normal mt-1">--</div>
                </div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="1">
                  <div>TUE</div>
                  <div id="date-1" class="text-xs font-normal mt-1">--</div>
                </div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="2">
                  <div>WED</div>
                  <div id="date-2" class="text-xs font-normal mt-1">--</div>
                </div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="3">
                  <div>THU</div>
                  <div id="date-3" class="text-xs font-normal mt-1">--</div>
                </div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="4">
                  <div>FRI</div>
                  <div id="date-4" class="text-xs font-normal mt-1">--</div>
                </div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="5">
                  <div>SAT</div>
                  <div id="date-5" class="text-xs font-normal mt-1">--</div>
                </div>
                <div class="px-4 py-3 text-sm font-semibold text-center" data-day="6">
                  <div>SUN</div>
                  <div id="date-6" class="text-xs font-normal mt-1">--</div>
                </div>
              </div>
              
              <div id="calendarGrid" class="grid grid-cols-8" style="grid-auto-rows: 60px; min-height: 660px; margin: 0; padding: 0;">
                <!-- Time slots will be generated by JavaScript -->
              </div>
            </div>
          </div>

        </div>

        <footer class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200">
          <button type="button" id="bookLessonCancel" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- ===== Time Slot Selection Modal ===== -->
  <div id="timeSlotModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <div class="w-full max-w-md rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <div>
            <h3 id="timeSlotTitle" class="text-lg font-semibold text-gray-900">Select Time Slot</h3>
            <p id="timeSlotInfo" class="text-sm text-gray-600 mt-1">Choose your preferred time</p>
          </div>
          <button type="button" id="timeSlotClose" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Close</button>
        </header>
        
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Selected Time</label>
            <div id="selectedTimeDisplay" class="p-3 bg-gray-50 rounded-lg text-lg font-medium text-gray-900">
              <!-- Selected time will be displayed here -->
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Lesson Type</label>
            <select id="slotType" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm">
              <option value="Online">Online</option>
              <option value="Cafe">Cafe</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
            <textarea id="slotNotes" rows="3" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm" placeholder="Any additional notes for this lesson..."></textarea>
          </div>
        </div>

        <footer class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200">
          <button type="button" id="timeSlotCancel" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
          <button type="button" id="timeSlotConfirm" class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Confirm Booking</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- ===== Note Modal (Add/Edit) ===== -->
  <div id="noteModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <form id="noteForm" class="w-full max-w-xl rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 id="noteModalTitle" class="text-lg font-semibold">Add Note</h3>
          <button type="button" id="noteClose" class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs font-medium hover:bg-gray-50">Close</button>
        </header>
        <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
          <div>
            <label class="block text-gray-600 mb-1">Date</label>
            <input id="n_date" name="date" type="date" class="w-full rounded-md border border-gray-300 px-3 py-2" required />
          </div>
          <div>
            <label class="block text-gray-600 mb-1">Staff</label>
            <input id="n_staff" name="staff" class="w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-100" readonly />
          </div>
          <div class="sm:col-span-2">
            <label class="block text-gray-600 mb-1">Note</label>
            <textarea id="n_text" name="text" rows="5" class="w-full rounded-md border border-gray-300 px-3 py-2"></textarea>
          </div>
        </div>
        <footer class="flex items-center justify-between gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="noteDelete" class="hidden rounded-md bg-rose-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-rose-700">Delete</button>
          <button type="submit" class="rounded-md bg-green-600 text-white px-4 py-1.5 text-sm font-semibold hover:bg-green-700">Save</button>
        </footer>
      </form>
    </div>
  </div>

  <!-- ===== Confirmation Modal ===== -->
  <div id="confirmModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <div class="w-full max-w-md rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 id="confirmModalTitle" class="text-lg font-semibold">Confirm Action</h3>
          <button type="button" id="confirmClose" class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs font-medium hover:bg-gray-50">Close</button>
        </header>
        <div class="p-4">
          <p id="confirmMessage" class="text-gray-700 mb-4">Are you sure you want to proceed?</p>
        </div>
        <footer class="flex items-center justify-end gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="confirmCancel" class="rounded-md border border-gray-300 bg-white px-4 py-1.5 text-sm font-semibold text-gray-700 hover:bg-gray-50">Cancel</button>
          <button type="button" id="confirmOK" class="rounded-md bg-rose-600 text-white px-4 py-1.5 text-sm font-semibold hover:bg-rose-700">Confirm</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- ===== Notification Modal ===== -->
  <div id="notificationModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <div class="w-full max-w-md rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 id="notificationModalTitle" class="text-lg font-semibold">Notification</h3>
          <button type="button" id="notificationClose" class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs font-medium hover:bg-gray-50">Close</button>
        </header>
        <div class="p-4">
          <div class="flex items-start space-x-3">
            <div id="notificationIcon" class="flex-shrink-0 mt-0.5">
              <!-- Icon will be set dynamically -->
            </div>
            <div class="flex-1">
              <p id="notificationMessage" class="text-gray-700 mb-2"></p>
              <p id="notificationDetails" class="text-sm text-gray-500"></p>
            </div>
          </div>
        </div>
        <footer class="flex items-center justify-end gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="notificationOK" class="rounded-md bg-green-600 text-white px-4 py-1.5 text-sm font-semibold hover:bg-green-700">OK</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- ===== Unpaid Students Modal ===== -->
  <div id="newFeatureModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <div class="w-full max-w-4xl rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 bg-green-600 text-white">
          <h3 id="modalTitle" class="text-lg font-semibold">Unpaid Students</h3>
          <button type="button" id="newFeatureClose" class="rounded-md border border-white/30 bg-white/10 px-2.5 py-1 text-xs font-medium hover:bg-white/20">Close</button>
        </header>
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                  <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                </div>
              </div>
              <div>
                <h4 id="modalHeaderText" class="text-lg font-medium text-gray-900">Students with Outstanding Payments</h4>
                <p class="text-sm text-gray-500">Click on a student to view their details</p>
              </div>
            </div>
            <button id="refreshUnpaidBtn" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium hover:bg-gray-50">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i>
              Refresh
            </button>
          </div>
          
          <!-- Table wrapper matching student list style -->
          <div class="relative overflow-auto max-h-[50vh] w-full rounded-xl border border-black/5 bg-white shadow-sm">
            <table class="min-w-full border-separate border-spacing-0">
              <thead class="sticky top-0 bg-green-600 text-white shadow">
                <tr>
                  <th class="px-3 py-2 text-left font-semibold">Student Name</th>
                </tr>
              </thead>
              <tbody id="unpaidStudentsTableBody">
                <tr>
                  <td class="px-3 py-2 text-center text-gray-500">
                    <div class="flex justify-center items-center">
                      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                      <span class="ml-2 text-gray-600">Loading unpaid students...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div id="unpaidStudentsCount" class="mt-4 text-sm text-gray-600 hidden">
            <span class="font-medium">Total unpaid students: </span>
            <span id="unpaidCount" class="font-semibold text-red-600">0</span>
          </div>
        </div>
        <footer class="flex items-center justify-end gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="newFeatureCancel" class="rounded-md border border-gray-300 bg-white px-4 py-1.5 text-sm font-semibold text-gray-700 hover:bg-gray-50">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- ===== Add / Edit Student Modal ===== -->
  <div id="studentModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <form id="studentForm" class="w-full max-w-2xl rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 bg-green-600 text-white">
          <h3 id="studentModalTitle" class="text-lg font-semibold">Add Student</h3>
          <button type="button" id="studentClose" class="rounded-md border border-white/30 bg-white/10 px-2.5 py-1 text-xs font-medium hover:bg-white/20">Close</button>
        </header>

        <div class="p-4 space-y-6">
          <!-- Identity -->
          <section>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div class="sm:col-span-2">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="user" class="h-4 w-4 text-gray-500"></i><span>Name <span class="text-rose-600">*</span></span></label>
                <input id="s_name" name="name" required class="w-full rounded-md border border-gray-300 px-3 py-2" placeholder="Tarou Tanaka" />
              </div>
              <div class="sm:col-span-2">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="type" class="h-4 w-4 text-gray-500"></i><span>漢字 <span class="text-rose-600">*</span></span></label>
                <input id="s_kanji" name="kanji" required class="w-full rounded-md border border-gray-300 px-3 py-2" placeholder="田中 太郎" />
              </div>
              <div>
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="phone" class="h-4 w-4 text-gray-500"></i><span>Phone <span class="text-rose-600">*</span></span></label>
                <div class="flex items-center gap-2">
                  <input id="s_phone1" inputmode="numeric" pattern="[0-9]{3}" required maxlength="3" class="w-16 rounded-md border border-gray-300 px-2 py-2 text-center" placeholder="090" />
                  <span class="text-gray-400">-</span>
                  <input id="s_phone2" inputmode="numeric" pattern="[0-9]{4}" required maxlength="4" class="w-20 rounded-md border border-gray-300 px-2 py-2 text-center" placeholder="0000" />
                  <span class="text-gray-400">-</span>
                  <input id="s_phone3" inputmode="numeric" pattern="[0-9]{4}" required maxlength="4" class="w-20 rounded-md border border-gray-300 px-2 py-2 text-center" placeholder="0000" />
                </div>
              </div>
              <div>
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="mail" class="h-4 w-4 text-gray-500"></i><span>Email <span class="text-rose-600">*</span></span></label>
                <input id="s_email" name="email" type="email" required class="w-full rounded-md border border-gray-300 px-3 py-2" placeholder="name@example.com" />
              </div>
            </div>
          </section>

          <!-- Meta -->
          <section>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div>
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="users" class="h-4 w-4 text-gray-500"></i><span>Group</span></label>
                <select id="s_group" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option value="Individual">Individual</option>
                  <option value="Group">Group</option>
                </select>
              </div>
              <div id="s_groupSizeContainer" class="hidden">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="hash" class="h-4 w-4 text-gray-500"></i><span>人数 (Group Size)</span></label>
                <select id="s_groupSize" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="flex items-center gap-3">
                <input id="s_child" type="checkbox" class="h-4 w-4 rounded border-gray-300" />
                <label for="s_child" class="text-sm font-semibold text-gray-800 flex items-center gap-2"><i data-lucide="baby" class="h-4 w-4 text-gray-500"></i><span>子 (Child)</span></label>
              </div>
            </div>
          </section>
        </div>

        <footer class="flex items-center justify-between gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="studentDelete" class="hidden rounded-md bg-rose-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-rose-700">Delete</button>
          <div class="flex items-center gap-2">
            <button type="button" id="studentCancel" class="rounded-md border border-gray-300 bg-white px-4 py-1.5 text-sm font-semibold hover:bg-gray-50">Cancel</button>
            <button type="submit" class="rounded-md bg-green-600 text-white px-4 py-1.5 text-sm font-semibold hover:bg-green-700">Save</button>
          </div>
        </footer>
      </form>
    </div>
  </div>

  <!-- ===== Edit Student Modal ===== -->
  <div id="editStudentModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8 overflow-auto">
      <form id="editStudentForm" class="w-full max-w-2xl rounded-2xl bg-white modal-card ring-1 ring-black/5">
        <header class="flex items-center justify-between px-4 py-3 bg-green-600 text-white">
          <h3 id="editStudentTitle" class="text-lg font-semibold">Edit Student</h3>
          <button type="button" id="editStudentClose" class="rounded-md border border-white/30 bg-white/10 px-2.5 py-1 text-xs font-medium hover:bg-white/20">Close</button>
        </header>

        <div class="p-4 space-y-6">
          <!-- Identity -->
          <section>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div class="sm:col-span-2">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="user" class="h-4 w-4 text-gray-500"></i><span>Name <span class="text-rose-600">*</span></span></label>
                <input id="e_name" required class="w-full rounded-md border border-gray-300 px-3 py-2" placeholder="Tarou Tanaka" />
              </div>
              <div class="sm:col-span-2">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="type" class="h-4 w-4 text-gray-500"></i><span>漢字 <span class="text-rose-600">*</span></span></label>
                <input id="e_kanji" required class="w-full rounded-md border border-gray-300 px-3 py-2" placeholder="田中 太郎" />
              </div>
              <div>
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="phone" class="h-4 w-4 text-gray-500"></i><span>Phone <span class="text-rose-600">*</span></span></label>
                <div class="flex items-center gap-2">
                  <input id="e_phone1" inputmode="numeric" pattern="[0-9]{3}" required maxlength="3" class="w-16 rounded-md border border-gray-300 px-2 py-2 text-center" placeholder="090" />
                  <span class="text-gray-400">-</span>
                  <input id="e_phone2" inputmode="numeric" pattern="[0-9]{4}" required maxlength="4" class="w-20 rounded-md border border-gray-300 px-2 py-2 text-center" placeholder="0000" />
                  <span class="text-gray-400">-</span>
                  <input id="e_phone3" inputmode="numeric" pattern="[0-9]{4}" required maxlength="4" class="w-20 rounded-md border border-gray-300 px-2 py-2 text-center" placeholder="0000" />
                </div>
              </div>
              <div>
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="mail" class="h-4 w-4 text-gray-500"></i><span>Email <span class="text-rose-600">*</span></span></label>
                <input id="e_email" type="email" required class="w-full rounded-md border border-gray-300 px-3 py-2" placeholder="name@example.com" />
              </div>
            </div>
          </section>

          <!-- Meta -->
          <section>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 text-sm">
              <div class="sm:col-span-1">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="badge-check" class="h-4 w-4 text-gray-500"></i><span>Status</span></label>
                <select id="e_status" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option>Active</option>
                  <option>Dormant</option>
                  <option>DEMO</option>
                </select>
              </div>
              <div class="sm:col-span-1">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="credit-card" class="h-4 w-4 text-gray-500"></i><span>Payment Type</span></label>
                <select id="e_paytype" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option>NEO</option>
                  <option>OLD</option>
                </select>
              </div>
              <div class="sm:col-span-1">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="calendar-x" class="h-4 w-4 text-gray-500"></i><span>当日キャンセル</span></label>
                <select id="e_cancelSD" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option>未</option>
                  <option>済</option>
                </select>
              </div>
              <div class="sm:col-span-1 flex items-end">
                <div class="flex items-center gap-3">
                  <input id="e_child" type="checkbox" class="h-4 w-4 rounded border-gray-300" />
                  <label for="e_child" class="text-sm font-semibold text-gray-800 flex items-center gap-2"><i data-lucide="baby" class="h-4 w-4 text-gray-500"></i><span>子 (Child)</span></label>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm mt-3">
              <div>
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="users" class="h-4 w-4 text-gray-500"></i><span>Group</span></label>
                <select id="e_group" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option value="Individual">Individual</option>
                  <option value="Group">Group</option>
                </select>
              </div>
              <div id="e_groupSizeContainer" class="hidden">
                <label class="block font-semibold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="hash" class="h-4 w-4 text-gray-500"></i><span>人数 (Group Size)</span></label>
                <select id="e_groupSize" class="w-full rounded-md border border-gray-300 px-3 py-2">
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
              <div class="flex items-center gap-3">
                <input id="e_child" type="checkbox" class="h-4 w-4 rounded border-gray-300" />
                <label for="e_child" class="text-sm font-semibold text-gray-800 flex items-center gap-2"><i data-lucide="baby" class="h-4 w-4 text-gray-500"></i><span>子 (Child)</span></label>
              </div>
            </div>
          </section>
        </div>

        <footer class="flex items-center justify-between gap-2 px-4 py-3 bg-gray-50 border-t border-gray-200">
          <button type="button" id="e_delete" class="rounded-md bg-rose-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-rose-700">Delete</button>
          <div class="flex items-center gap-2">
            <button type="button" id="e_cancel" class="rounded-md border border-gray-300 bg-white px-4 py-1.5 text-sm font-semibold hover:bg-gray-50">Cancel</button>
            <button type="submit" class="rounded-md bg-green-600 text-white px-4 py-1.5 text-sm font-semibold hover:bg-green-700">Save</button>
          </div>
        </footer>
      </form>
    </div>
  </div>

  <script>
    const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let student = {}; let latestMap = {}; let displayOrder = [];
    // Make student globally accessible
    window.student = student;

    // ---------- Utilities ----------
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $  = (sel, root=document) => root.querySelector(sel);
    const show = (el) => el && el.classList.remove('hidden');
    const hide = (el) => el && el.classList.add('hidden');

    // Generate a 7-character ID using letters and numbers (case-sensitive)
    function generateNoteId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 7; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // Generate transaction ID (TXN-<random string>)
    function generateTransactionId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return 'TXN-' + result;
    }

    // Calculate price based on lessons count (client-side for speed)
    function calculatePrice(lessonsCount) {
      if (!student || !lessonsCount || lessonsCount <= 0) {
        payEls.price.value = '';
        return;
      }

      // Get student's payment type and group info
      const paymentType = student.paymentType || 'NEO'; // Default to NEO
      const group = student.group || 'Individual';
      const groupSize = student.groupSize || '2';

      console.log('Calculating price client-side:', {
        lessonsCount,
        paymentType,
        group,
        groupSize
      });

      // Fee calculation based on actual fee table structure
      let pricePerLesson = 0;
      
      if (paymentType === 'NEO') {
        if (group === 'Individual') {
          // Determine frequency based on lesson count
          if (lessonsCount <= 3) {
            pricePerLesson = 7150; // 2x rate
          } else if (lessonsCount <= 7) {
            pricePerLesson = 5720; // 4x rate
          } else {
            pricePerLesson = 4950; // 8x rate
          }
        } else if (group === 'Group') {
          const size = parseInt(groupSize) || 2;
          if (size === 2) {
            if (lessonsCount <= 3) pricePerLesson = 4675; // 2x rate
            else if (lessonsCount <= 7) pricePerLesson = 3960; // 4x rate
            else pricePerLesson = 3575; // 8x rate
          } else if (size === 3) {
            if (lessonsCount <= 3) pricePerLesson = 3850; // 2x rate
            else if (lessonsCount <= 7) pricePerLesson = 3373; // 4x rate
            else pricePerLesson = 3117; // 8x rate
          } else if (size === 4) {
            if (lessonsCount <= 3) pricePerLesson = 3438; // 2x rate
            else if (lessonsCount <= 7) pricePerLesson = 3080; // 4x rate
            else pricePerLesson = 2888; // 8x rate
          } else {
            pricePerLesson = 3960; // Default to 2-person group 4x rate
          }
        }
      } else if (paymentType === 'OLD') {
        if (group === 'Individual') {
          if (lessonsCount <= 3) {
            pricePerLesson = 4620; // 2x rate
          } else if (lessonsCount <= 7) {
            pricePerLesson = 4400; // 4x rate
          } else {
            pricePerLesson = 3960; // 8x rate
          }
        } else if (group === 'Group') {
          const size = parseInt(groupSize) || 2;
          if (size === 2) {
            if (lessonsCount <= 3) pricePerLesson = 2860; // 2x rate
            else if (lessonsCount <= 7) pricePerLesson = 2750; // 4x rate
            else pricePerLesson = 2530; // 8x rate
          } else if (size === 3) {
            if (lessonsCount <= 3) pricePerLesson = 2273; // 2x rate
            else if (lessonsCount <= 7) pricePerLesson = 2200; // 4x rate
            else pricePerLesson = 2053; // 8x rate
          } else if (size === 4) {
            if (lessonsCount <= 3) pricePerLesson = 1980; // 2x rate
            else if (lessonsCount <= 7) pricePerLesson = 1925; // 4x rate
            else pricePerLesson = 1815; // 8x rate
          } else {
            pricePerLesson = 2750; // Default to 2-person group 4x rate
          }
        }
      }

      const totalPrice = lessonsCount * pricePerLesson;
      console.log('Calculated price:', totalPrice, 'using rate:', pricePerLesson, 'for', lessonsCount, 'lessons');
      payEls.price.value = totalPrice;
    }

    function formatDateDDMMYYYY(iso){
      if(!iso) return '';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function monthName(d){
      return new Date(d).toLocaleString('en-GB', { month:'long' });
    }

    const el = {
      name: document.getElementById('studentName'),
      kanji: document.getElementById('studentKanji'),
      email: document.getElementById('studentEmail'),
      phone: document.getElementById('studentPhone'),
      contact: document.getElementById('studentContact'),
      statusPill: document.getElementById('statusPill'),
      latestSection: document.getElementById('latestSection'),
      paymentsBody: document.getElementById('paymentsBody'),
      notesBody: document.getElementById('notesBody'),
      noteSearch: document.getElementById('noteSearch'),
      editBtn: document.getElementById('editBtn'),
      deleteBtn: document.getElementById('deleteBtn'),
      closeBtn: document.getElementById('closeBtn'),
    };



    // ---------- Note Modal API ----------
    const noteEls = {
      root: $('#noteModal'), form: $('#noteForm'), title: $('#noteModalTitle'),
      close: $('#noteClose'), del: $('#noteDelete'),
      date: $('#n_date'), staff: $('#n_staff'), text: $('#n_text')
    };

    function openNoteModal({ mode='add', note=null, onSave=()=>{}, onDelete=()=>{}, onClose=()=>{} }={}){
      noteEls.title.textContent = mode === 'edit' ? 'Edit Note' : 'Add Note';
      noteEls.del.classList.toggle('hidden', mode !== 'edit');

      // Prefill
      let dateValue = '';
      if (note?.Date) {
        // Handle different date formats
        if (note.Date.includes('/')) {
          // Convert DD/MM/YYYY to YYYY-MM-DD
          const parts = note.Date.split('/');
          if (parts.length === 3) {
            dateValue = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
          }
        } else {
          // Try to parse as ISO date
          try {
            dateValue = new Date(note.Date).toISOString().slice(0, 10);
          } catch (e) {
            dateValue = '';
          }
        }
      } else if (mode === 'add') {
        // Default to today's date for new notes
        dateValue = new Date().toISOString().slice(0, 10);
      }
      noteEls.date.value = dateValue;
      noteEls.staff.value = note?.Staff || note?.staff || '';
      noteEls.text.value = note?.Note || note?.text || note?.note || '';

              // Auto-fill staff name from Code sheet B1 if adding new note
        if (mode === 'add' && window.google && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(function(staffName) {
              if (staffName && !noteEls.staff.value) {
                noteEls.staff.value = staffName;
              }
            })
            .withFailureHandler(function(error) {
              console.error('Failed to get staff name:', error);
            })
            .getCurrentStaffName();
        }

      const submit = (e) => {
        e.preventDefault();
        const iso = noteEls.date.value;
        const studentId = student?.id || student?.ID || '';
        console.log('Creating note with student ID:', studentId);
        console.log('Student object:', student);
        const payload = {
          'StudentID': studentId, // Add Student ID
          ID: note?.ID || generateNoteId(), // Generate new ID if not editing
          Date: formatDateDDMMYYYY(iso), // app uses DD/MM/YYYY
          Note: noteEls.text.value.trim(),
          Staff: noteEls.staff.value.trim()
        };
        console.log('Note payload:', payload);
        onSave(payload);
        cleanup();
      };
      const doDelete = () => { if(mode==='edit'){ onDelete(note); cleanup(); } };
      const doClose  = () => { onClose(); cleanup(); };

      function cleanup(){
        noteEls.form.removeEventListener('submit', submit);
        noteEls.del.removeEventListener('click', doDelete);
        noteEls.close.removeEventListener('click', doClose);
        hide(noteEls.root);
      }

      noteEls.form.addEventListener('submit', submit);
      noteEls.del.addEventListener('click', doDelete);
      noteEls.close.addEventListener('click', doClose);
      show(noteEls.root);
      setTimeout(()=> noteEls.date.focus(), 0);
    }

    // ---------- Confirmation Modal API ----------
    const confirmEls = {
      root: $('#confirmModal'), title: $('#confirmModalTitle'), message: $('#confirmMessage'),
      close: $('#confirmClose'), cancel: $('#confirmCancel'), ok: $('#confirmOK')
    };

    function openConfirmModal({ title='Confirm Action', message='Are you sure you want to proceed?', onConfirm=()=>{}, onCancel=()=>{}, onClose=()=>{} }={}){
      confirmEls.title.textContent = title;
      confirmEls.message.textContent = message;

      const doConfirm = () => { onConfirm(); cleanup(); };
      const doCancel = () => { onCancel(); cleanup(); };
      const doClose = () => { onClose(); cleanup(); };

      function cleanup(){
        confirmEls.ok.removeEventListener('click', doConfirm);
        confirmEls.cancel.removeEventListener('click', doCancel);
        confirmEls.close.removeEventListener('click', doClose);
        hide(confirmEls.root);
      }

      confirmEls.ok.addEventListener('click', doConfirm);
      confirmEls.cancel.addEventListener('click', doCancel);
      confirmEls.close.addEventListener('click', doClose);
      show(confirmEls.root);
      setTimeout(()=> confirmEls.ok.focus(), 0);
    }

    // ---------- Notification Modal API ----------
    const notificationEls = {
      root: $('#notificationModal'), title: $('#notificationModalTitle'), message: $('#notificationMessage'),
      details: $('#notificationDetails'), icon: $('#notificationIcon'), close: $('#notificationClose'), ok: $('#notificationOK')
    };

    function openNotificationModal({ type='success', title='Notification', message='', details='', onClose=()=>{} }={}){
      notificationEls.title.textContent = title;
      notificationEls.message.textContent = message;
      notificationEls.details.textContent = details;

      // Set icon and colors based on type
      const iconStyles = {
        success: {
          icon: '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          buttonClass: 'bg-green-600 hover:bg-green-700'
        },
        error: {
          icon: '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          buttonClass: 'bg-red-600 hover:bg-red-700'
        },
        warning: {
          icon: '<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
          buttonClass: 'bg-yellow-600 hover:bg-yellow-700'
        },
        info: {
          icon: '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          buttonClass: 'bg-blue-600 hover:bg-blue-700'
        }
      };

      const style = iconStyles[type] || iconStyles.info;
      notificationEls.icon.innerHTML = style.icon;
      notificationEls.ok.className = `rounded-md text-white px-4 py-1.5 text-sm font-semibold ${style.buttonClass}`;

      const doClose = () => { onClose(); cleanup(); };

      function cleanup(){
        notificationEls.ok.removeEventListener('click', doClose);
        notificationEls.close.removeEventListener('click', doClose);
        hide(notificationEls.root);
      }

      notificationEls.ok.addEventListener('click', doClose);
      notificationEls.close.addEventListener('click', doClose);
      show(notificationEls.root);
      setTimeout(()=> notificationEls.ok.focus(), 0);
    }

    // ---------- Payment Modal API ----------
    const payEls = {
      root: $('#paymentModal'), form: $('#paymentForm'), title: $('#paymentModalTitle'),
      close: $('#paymentClose'), del: $('#paymentDelete'),
      txn: $('#p_txn'), date: $('#p_date'), lessons: $('#p_lessons'), month: $('#p_month'), price: $('#p_price'), method: $('#p_method'), staff: $('#p_staff')
    };

    // ---------- Lesson Details Modal API ----------
    const lessonDetailsEls = {
      root: $('#lessonDetailsModal'), title: $('#lessonDetailsTitle'),
      close: $('#lessonDetailsClose'), cancel: $('#lessonDetailsCancel'),
      statusDot: $('#lessonStatusDot'), statusText: $('#lessonStatusText'),
      date: $('#lessonDate'), time: $('#lessonTime'), notes: $('#lessonNotes'),
      cancelBtn: $('#lessonCancelBtn'), rescheduleBtn: $('#lessonRescheduleBtn'), removeBtn: $('#lessonRemoveBtn')
    };

    // ---------- Book Lesson Modal API ----------
    const bookLessonEls = {
      root: $('#bookLessonModal'), title: $('#bookLessonTitle'),
      close: $('#bookLessonClose'), cancel: $('#bookLessonCancel'),
      studentInfo: $('#bookLessonStudentInfo'), calendarGrid: $('#calendarGrid'),
      currentWeekDisplay: $('#currentWeekDisplay'), prevWeekBtn: $('#prevWeekBtn'), nextWeekBtn: $('#nextWeekBtn')
    };

    // ---------- Time Slot Modal API ----------
    const timeSlotEls = {
      root: $('#timeSlotModal'), title: $('#timeSlotTitle'), info: $('#timeSlotInfo'),
      close: $('#timeSlotClose'), cancel: $('#timeSlotCancel'), confirm: $('#timeSlotConfirm'),
      selectedTimeDisplay: $('#selectedTimeDisplay'), 
      type: $('#slotType'), notes: $('#slotNotes')
    };

    function openLessonDetailsModal({ lesson=null, student=null, onClose=()=>{} }={}){
      if (!lesson) {
        console.error('No lesson data provided');
        return;
      }

      // Set status styling
      const statusStyles = {
        scheduled: { color: 'bg-emerald-600', text: 'Scheduled' },
        cancelled: { color: 'bg-slate-500', text: 'Cancelled' },
        rescheduled: { color: 'bg-amber-500', text: 'Rescheduled' },
        unbooked: { color: 'bg-orange-500', text: 'Unbooked' },
        unscheduled: { color: 'bg-red-500', text: 'Unscheduled' }
      };

      const status = lesson.status || 'scheduled';
      const style = statusStyles[status] || statusStyles.scheduled;

      lessonDetailsEls.statusDot.className = `w-3 h-3 rounded-full ${style.color}`;
      lessonDetailsEls.statusText.textContent = style.text;

      // Format date and time in Japanese style
      let day = lesson.day || '';
      let time = lesson.time || '';
      
      if (day && day !== '--') {
        day = parseInt(day).toString() + '日';
      }
      
      if (time && time !== '--') {
        time = time.replace(':', '：');
      }

      lessonDetailsEls.date.textContent = day || 'Not specified';
      lessonDetailsEls.time.textContent = time || 'Not specified';

      // Set notes (placeholder for now)
      lessonDetailsEls.notes.textContent = 'No additional notes available.';

      const doClose = () => { onClose(); cleanup(); };

      function cleanup(){
        lessonDetailsEls.close.removeEventListener('click', doClose);
        lessonDetailsEls.cancel.removeEventListener('click', doClose);
        lessonDetailsEls.cancelBtn.removeEventListener('click', handleCancelLesson);
        lessonDetailsEls.rescheduleBtn.removeEventListener('click', handleRescheduleLesson);
        lessonDetailsEls.removeBtn.removeEventListener('click', handleRemoveLesson);
        hide(lessonDetailsEls.root);
      }

      // Handle lesson actions
      function handleCancelLesson() {
        console.log('Cancel lesson clicked', lesson);
        
        const reason = prompt('Please enter the reason for cancellation:');
        if (!reason) return;
        
        // For now, we'll use a placeholder event ID since lesson cards don't have event IDs yet
        // TODO: Add event ID to lesson data structure
        const eventId = 'placeholder_event_id_' + Date.now();
        const studentId = student?.id || student?.ID || 'unknown';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('Lesson cancelled successfully!');
              doClose();
              // Refresh the latest record to show updated status
              if (typeof updateLatestRecord === 'function') {
                updateLatestRecord();
              }
            } else {
              alert('Error cancelling lesson: ' + result.error);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Error cancelling lesson:', error);
            alert('Error cancelling lesson. Please try again.');
          })
          .cancelLesson(eventId, reason, studentId);
      }

      function handleRescheduleLesson() {
        console.log('Reschedule lesson clicked', lesson);
        
        const newDateTime = prompt('Please enter the new date and time (YYYY-MM-DD HH:MM):');
        if (!newDateTime) return;
        
        const reason = prompt('Please enter the reason for rescheduling:');
        if (!reason) return;
        
        // For now, we'll use a placeholder event ID since lesson cards don't have event IDs yet
        // TODO: Add event ID to lesson data structure
        const eventId = 'placeholder_event_id_' + Date.now();
        const studentId = student?.id || student?.ID || 'unknown';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('Lesson rescheduled successfully!');
              doClose();
              // Refresh the latest record to show updated status
              if (typeof updateLatestRecord === 'function') {
                updateLatestRecord();
              }
            } else {
              alert('Error rescheduling lesson: ' + result.error);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Error rescheduling lesson:', error);
            alert('Error rescheduling lesson. Please try again.');
          })
          .rescheduleLesson(eventId, newDateTime, reason, studentId);
      }

      function handleRemoveLesson() {
        console.log('Remove lesson clicked', lesson);
        
        if (!confirm('Are you sure you want to remove this lesson? This action cannot be undone.')) {
          return;
        }
        
        const reason = prompt('Please enter the reason for removal:');
        if (!reason) return;
        
        // For now, we'll use a placeholder event ID since lesson cards don't have event IDs yet
        // TODO: Add event ID to lesson data structure
        const eventId = 'placeholder_event_id_' + Date.now();
        const studentId = student?.id || student?.ID || 'unknown';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('Lesson removed successfully!');
              doClose();
              // Refresh the latest record to show updated status
              if (typeof updateLatestRecord === 'function') {
                updateLatestRecord();
              }
            } else {
              alert('Error removing lesson: ' + result.error);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Error removing lesson:', error);
            alert('Error removing lesson. Please try again.');
          })
          .removeLesson(eventId, reason, studentId);
      }

      // Add event listeners
      lessonDetailsEls.close.addEventListener('click', doClose);
      lessonDetailsEls.cancel.addEventListener('click', doClose);
      lessonDetailsEls.cancelBtn.addEventListener('click', handleCancelLesson);
      lessonDetailsEls.rescheduleBtn.addEventListener('click', handleRescheduleLesson);
      lessonDetailsEls.removeBtn.addEventListener('click', handleRemoveLesson);
      
      show(lessonDetailsEls.root);
    }

    function openTimeSlotModal({ date=null, time=null, student=null, onClose=()=>{}, onConfirm=()=>{} }={}){
      if (!date || !time || !student) {
        console.error('Missing required data for time slot modal');
        return;
      }

      // Format the selected time for display
      const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const dayName = dayNames[date.getDay()];
      const dateStr = date.toLocaleDateString();
      const timeStr = `${dayName}, ${dateStr} at ${time}`;
      
      // Update modal content
      timeSlotEls.selectedTimeDisplay.textContent = timeStr;
      timeSlotEls.type.value = 'Cafe'; // Default to Cafe
      timeSlotEls.notes.value = '';

      // Add event listeners
      const doClose = () => { onClose(); cleanup(); };
      const doConfirm = () => {
        const lessonData = {
          date: date.toISOString().split('T')[0],
          time: time,
          duration: 50, // Fixed duration of 50 minutes
          type: timeSlotEls.type.value,
          notes: timeSlotEls.notes.value,
          studentId: student.ID || student.id,
          studentName: student.Name || student.name || 'Unknown Student'
        };
        onConfirm(lessonData);
        cleanup();
      };

      function cleanup(){
        timeSlotEls.close.removeEventListener('click', doClose);
        timeSlotEls.cancel.removeEventListener('click', doClose);
        timeSlotEls.confirm.removeEventListener('click', doConfirm);
        hide(timeSlotEls.root);
      }

      timeSlotEls.close.addEventListener('click', doClose);
      timeSlotEls.cancel.addEventListener('click', doClose);
      timeSlotEls.confirm.addEventListener('click', doConfirm);
      
      show(timeSlotEls.root);
    }

    function handleTimeSlotBooking(lessonData) {
      console.log('Booking lesson with data:', lessonData);
      
      // Create datetime string for backend
      const dateTime = new Date(lessonData.date + 'T' + lessonData.time);
      
      // Book the lesson
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Lesson booked successfully!');
            // Close the booking modal and refresh data
            if (typeof updateLatestRecord === 'function') {
              updateLatestRecord();
            }
            // Close the booking modal
            const doClose = () => { 
              bookLessonEls.close.removeEventListener('click', doClose);
              bookLessonEls.cancel.removeEventListener('click', doClose);
              hide(bookLessonEls.root);
            };
            doClose();
          } else {
            alert('Error booking lesson: ' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error booking lesson:', error);
          alert('Error booking lesson. Please try again.');
        })
        .bookLesson(lessonData.studentId, dateTime.toISOString(), lessonData.duration, lessonData.type, lessonData.notes);
    }

    function openBookLessonModal({ student=null, onClose=()=>{} }={}){
      if (!student) {
        console.error('No student data provided for booking lesson');
        return;
      }

      // Set student information
      const studentName = student.Name || student.name || 'Unknown Student';
      const studentKanji = student['漢字'] || student.kanji || '';
      const studentGroup = student.Group || student.group || 'Individual';
      
      bookLessonEls.studentInfo.textContent = `${studentName} ${studentKanji ? '(' + studentKanji + ')' : ''} - ${studentGroup}`;
      
      // Initialize calendar (no need for default values since we're using the time slot modal)

      // Initialize calendar - start from Monday of current week
      let currentWeek = new Date();
      // Adjust to start from Monday (day 1)
      const dayOfWeek = currentWeek.getDay();
      // getDay() returns: 0=Sunday, 1=Monday, 2=Tuesday, etc.
      // To get to Monday: if Sunday(0), go back 6 days; otherwise go back (dayOfWeek - 1) days
      const daysToMonday = dayOfWeek === 0 ? -6 : -(dayOfWeek - 1);
      currentWeek.setDate(currentWeek.getDate() + daysToMonday);
      let selectedSlot = null;

      function generateCalendarWithLessons(weekStart, lessonsByDay) {
        console.log('Generating calendar with lessons:', lessonsByDay);
        
        // Clear existing grid
        bookLessonEls.calendarGrid.innerHTML = '';

        // Define opening hours for each day of the week - 10:00-20:00 for all days
        const openingHours = {
          0: { start: 10, end: 20 }, // Sunday: 10-20
          1: { start: 10, end: 20 }, // Monday: 10-20
          2: { start: 10, end: 20 }, // Tuesday: 10-20
          3: { start: 10, end: 20 }, // Wednesday: 10-20
          4: { start: 10, end: 20 }, // Thursday: 10-20
          5: { start: 10, end: 20 }, // Friday: 10-20
          6: { start: 10, end: 20 }  // Saturday: 10-20
        };
        
        // Generate time slots based on opening hours for each day
        const allTimeSlots = new Set();
        
        // Check each day of the week to get the full range of opening hours
        for (let day = 0; day < 7; day++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + day);
          const dayOfWeek = dayDate.getDay();
          const hours = openingHours[dayOfWeek];
          
          // Add time slots for this day's opening hours
          for (let hour = hours.start; hour <= hours.end; hour++) {
            allTimeSlots.add(`${hour.toString().padStart(2, '0')}:00`);
          }
        }
        
        // Convert to sorted array
        const timeSlots = Array.from(allTimeSlots).sort();
        console.log('Generated time slots based on opening hours:', timeSlots);
        console.log('Total time slots generated:', timeSlots.length);
        console.log('Time slots should include 20:00 (not 21:00):', timeSlots.includes('20:00'), timeSlots.includes('21:00'));
        console.log('All time slots:', timeSlots);
        console.log('Opening hours used:', openingHours);
        console.log('Expected total height:', timeSlots.length * 60, 'px (', timeSlots.length, 'slots × 60px each)');
        console.log('Container max-height: 70vh, Content height:', timeSlots.length * 60, 'px');
        console.log('Viewport height:', window.innerHeight);
        console.log('70vh =', window.innerHeight * 0.7, 'px');
        console.log('Should scroll:', timeSlots.length * 60 > (window.innerHeight * 0.7));
        
        // Check actual dimensions after content is rendered
        setTimeout(() => {
          const container = document.querySelector('.overflow-y-auto');
          const grid = document.getElementById('calendarGrid');
          if (container && grid) {
            console.log('=== ACTUAL DIMENSIONS ===');
            console.log('Container offset height:', container.offsetHeight);
            console.log('Container scroll height:', container.scrollHeight);
            console.log('Grid offset height:', grid.offsetHeight);
            console.log('Container max-height (computed):', getComputedStyle(container).maxHeight);
            console.log('Has scrollbar:', container.scrollHeight > container.offsetHeight);
            console.log('Scrollbar visible:', container.scrollHeight > container.clientHeight);
          }
        }, 1000);
        
        // Generate calendar grid with lessons
        console.log('=== GENERATING TIME SLOTS ===');
        timeSlots.forEach((slotTime, index) => {
          const hour = parseInt(slotTime.split(':')[0]);
          const minute = parseInt(slotTime.split(':')[1]) || 0;
          console.log(`Generating slot ${index + 1}/${timeSlots.length}: ${slotTime} (hour: ${hour})`);
          
          // Use 60px height for time slots
          const cellHeight = 60;
          
          // Time column
          const timeCell = document.createElement('div');
          timeCell.className = 'px-2 text-sm text-gray-600 border-r border-gray-200 bg-gray-50 flex items-center relative';
          timeCell.style.height = `${cellHeight}px`;
          timeCell.textContent = slotTime;
          
          // Add horizontal line through the entire calendar width
          const horizontalLine = document.createElement('div');
          horizontalLine.className = 'absolute top-0 left-0 h-px bg-gray-300';
          horizontalLine.style.width = 'calc(100% * 8)'; // Span all 8 columns
          horizontalLine.style.zIndex = '10';
          timeCell.appendChild(horizontalLine);
          
          bookLessonEls.calendarGrid.appendChild(timeCell);

          // Day columns (Monday to Sunday)
          for (let day = 0; day < 7; day++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + day);
            const dayOfWeek = dayDate.getDay();
            const hours = openingHours[dayOfWeek];
            
            const slotCell = document.createElement('div');
            slotCell.className = 'px-1 text-sm border-r border-gray-200 transition-colors flex flex-col justify-start relative';
            slotCell.style.height = `${cellHeight}px`;
            slotCell.dataset.day = day;
            slotCell.dataset.hour = hour;
            slotCell.dataset.date = dayDate.toISOString().split('T')[0];
            slotCell.dataset.time = slotTime;
            
            // Check if this time slot is within opening hours for this day
            if (hour < hours.start || hour > hours.end) {
              // Outside opening hours - unavailable
              slotCell.className += ' bg-gray-100 text-gray-400 cursor-not-allowed';
              slotCell.textContent = '';
              slotCell.title = `Closed (${hours.start}:00-${hours.end}:00)`;
            } else {
              // Check for existing lessons at this time
              // Use local date formatting to avoid timezone shift
              const year = dayDate.getFullYear();
              const month = String(dayDate.getMonth() + 1).padStart(2, '0');
              const dayOfMonth = String(dayDate.getDate()).padStart(2, '0');
              const dayKey = `${year}-${month}-${dayOfMonth}`;
              const dayLessons = lessonsByDay[dayKey] && lessonsByDay[dayKey][slotTime];
              
              if (dayLessons && dayLessons.length > 0) {
                // Filter to only show scheduled lessons
                const scheduledLessons = dayLessons.filter(lesson => lesson.status === 'scheduled');
                
                if (scheduledLessons.length > 0) {
                  // Group lessons by eventID to avoid duplicates
                  const groupedLessons = {};
                  scheduledLessons.forEach(lesson => {
                    const eventId = lesson.eventID || lesson.title || 'unknown';
                    if (!groupedLessons[eventId]) {
                      groupedLessons[eventId] = {
                        eventID: eventId,
                        title: lesson.title || 'Group Lesson',
                        status: lesson.status,
                        startTime: lesson.startTime,
                        endTime: lesson.endTime
                      };
                    }
                  });
                  
                  const uniqueLessons = Object.values(groupedLessons);
                  
                  // Show existing lessons as cards
                  const lessonsContainer = document.createElement('div');
                  lessonsContainer.className = 'flex h-full p-1 relative';
                  
                  uniqueLessons.forEach((lesson, index) => {
                  const lessonCard = document.createElement('div');
                  lessonCard.className = 'bg-green-600 border border-green-700 rounded-md text-xs p-2 absolute top-1 w-4/5 shadow-sm hover:shadow-lg transition-all duration-200 cursor-pointer text-white';
                  lessonCard.style.height = '50px';
                  lessonCard.style.zIndex = 10 + index;
                  
                  // Calculate position: first card at left, last card at right, others distributed
                  const totalCards = uniqueLessons.length;
                  const containerWidth = 100; // percentage
                  const cardWidth = 80; // percentage
                  const availableSpace = containerWidth - cardWidth;
                  
                  if (totalCards === 1) {
                    lessonCard.style.left = '1px';
                  } else {
                    const spacing = availableSpace / (totalCards - 1);
                    const leftPosition = 1 + (spacing * index);
                    lessonCard.style.left = `${leftPosition}%`;
                  }
                  
                  const title = document.createElement('div');
                  title.className = 'font-semibold text-white truncate mb-1';
                  title.textContent = lesson.title || 'Group Lesson';
                  lessonCard.appendChild(title);
                  
                  
                  if (lesson.status) {
                    const status = document.createElement('div');
                    status.className = 'text-white text-xs truncate mb-1';
                    status.textContent = lesson.status;
                    lessonCard.appendChild(status);
                  }

                  // Add hover effect to bring card to front
                  lessonCard.addEventListener('mouseenter', () => {
                    lessonCard.style.zIndex = 100;
                  });
                  
                  lessonCard.addEventListener('mouseleave', () => {
                    lessonCard.style.zIndex = 10 + index;
                  });

                  // Add click handler to view lesson details
                  lessonCard.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openLessonDetailsModal({
                      lesson: lesson,
                      student: { name: lesson.studentName || lesson.title },
                      onClose: () => {
                        console.log('Lesson details modal closed');
                      }
                    });
                  });
                  
                  lessonsContainer.appendChild(lessonCard);
                });
                
                slotCell.appendChild(lessonsContainer);
                slotCell.title = `Click to book at ${slotTime} (${scheduledLessons.length} lesson${scheduledLessons.length > 1 ? 's' : ''})`;
                }
              } else {
                // Available slot
                slotCell.className += ' bg-green-50 text-green-700 hover:bg-green-200 cursor-pointer';
                slotCell.textContent = '';
                slotCell.title = `${slotTime} - Available`;
                
                // Add click handler for booking
                slotCell.addEventListener('click', () => selectTimeSlot(slotCell, dayDate, slotTime));
              }
            }
            
            bookLessonEls.calendarGrid.appendChild(slotCell);
          }
        });
      }

      function generateCalendarWithLessonCards(weekStart, lessonsByDay) {
        console.log('=== GENERATING CALENDAR WITH LESSON CARDS ===');
        console.log('Week start:', weekStart);
        console.log('Lessons by day received:', lessonsByDay);

        const openingHours = {
          0: { start: 10, end: 20 }, // Sunday: 10-20
          1: { start: 10, end: 20 }, // Monday: 10-20
          2: { start: 10, end: 20 }, // Tuesday: 10-20
          3: { start: 10, end: 20 }, // Wednesday: 10-20
          4: { start: 10, end: 20 }, // Thursday: 10-20
          5: { start: 10, end: 20 }, // Friday: 10-20
          6: { start: 10, end: 20 }  // Saturday: 10-20
        };

        // lessonsByDay is already organized by date and time from getLessonsForWeek
        const lessonsByDateTime = lessonsByDay;

        const allTimeSlots = new Set();
        for (let day = 0; day < 7; day++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + day);
          const dayOfWeek = dayDate.getDay();
          const hours = openingHours[dayOfWeek];

          for (let hour = hours.start; hour <= hours.end; hour++) {
            allTimeSlots.add(`${hour.toString().padStart(2, '0')}:00`);
          }
        }

        const timeSlots = Array.from(allTimeSlots).sort();
        console.log('Time slots:', timeSlots);

        timeSlots.forEach(slotTime => {
          const hour = parseInt(slotTime.split(':')[0]);
          const minute = parseInt(slotTime.split(':')[1]) || 0;

          const cellHeight = 60;

          const timeCell = document.createElement('div');
          timeCell.className = 'px-2 text-sm text-gray-600 border-r border-gray-200 bg-gray-50 flex items-center relative';
          timeCell.style.height = `${cellHeight}px`;
          timeCell.textContent = slotTime;

          const horizontalLine = document.createElement('div');
          horizontalLine.className = 'absolute top-0 left-0 h-px bg-gray-300';
          horizontalLine.style.width = 'calc(100% * 8)';
          horizontalLine.style.zIndex = '10';
          timeCell.appendChild(horizontalLine);

          bookLessonEls.calendarGrid.appendChild(timeCell);

          for (let day = 0; day < 7; day++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + day);
            const dayOfWeek = dayDate.getDay();
            const hours = openingHours[dayOfWeek];
            // Use local date formatting to avoid timezone shift
            const year = dayDate.getFullYear();
            const month = String(dayDate.getMonth() + 1).padStart(2, '0');
            const dayOfMonth = String(dayDate.getDate()).padStart(2, '0');
            const dayKey = `${year}-${month}-${dayOfMonth}`;

            const slotCell = document.createElement('div');
            slotCell.className = 'px-1 text-sm border-r border-gray-200 transition-colors flex flex-col justify-start relative';
            slotCell.style.height = `${cellHeight}px`;
            slotCell.dataset.day = day;
            slotCell.dataset.hour = hour;
            slotCell.dataset.date = dayKey;
            slotCell.dataset.time = slotTime;

            if (hour < hours.start || hour > hours.end) {
              slotCell.className += ' bg-gray-100 text-gray-400 cursor-not-allowed';
              slotCell.textContent = '';
              slotCell.title = `Closed (${hours.start}:00-${hours.end}:00)`;
            } else {
              // Check if there are lessons at this time
              const dayLessons = lessonsByDateTime[dayKey] && lessonsByDateTime[dayKey][slotTime];
              
              if (dayLessons && dayLessons.length > 0) {
                console.log(`Found ${dayLessons.length} lessons for ${dayKey} at ${slotTime}:`, dayLessons);
                
                // Filter to only show scheduled lessons
                const scheduledLessons = dayLessons.filter(lesson => lesson.status === 'scheduled');
                
                if (scheduledLessons.length > 0) {
                  // Group lessons by eventID to avoid duplicates
                  const groupedLessons = {};
                  scheduledLessons.forEach(lesson => {
                    const eventId = lesson.eventID || lesson.title || 'unknown';
                    if (!groupedLessons[eventId]) {
                      groupedLessons[eventId] = {
                        eventID: eventId,
                        title: lesson.title || 'Group Lesson',
                        status: lesson.status,
                        startTime: lesson.startTime,
                        endTime: lesson.endTime
                      };
                    }
                  });
                  
                  const uniqueLessons = Object.values(groupedLessons);
                  
                  // Display lesson cards
                  const lessonsContainer = document.createElement('div');
                  lessonsContainer.className = 'flex h-full p-1 relative';

                  uniqueLessons.forEach((lesson, index) => {
                  const lessonCard = document.createElement('div');
                  lessonCard.className = 'bg-green-600 border border-green-700 rounded-md text-xs p-2 absolute top-1 w-4/5 shadow-sm hover:shadow-lg transition-all duration-200 cursor-pointer text-white';
                  lessonCard.style.height = '50px';
                  lessonCard.style.zIndex = 10 + index;
                  
                  // Calculate position: first card at left, last card at right, others distributed
                  const totalCards = uniqueLessons.length;
                  const containerWidth = 100; // percentage
                  const cardWidth = 80; // percentage
                  const availableSpace = containerWidth - cardWidth;
                  
                  if (totalCards === 1) {
                    lessonCard.style.left = '1px';
                  } else {
                    const spacing = availableSpace / (totalCards - 1);
                    const leftPosition = 1 + (spacing * index);
                    lessonCard.style.left = `${leftPosition}%`;
                  }

                  const title = document.createElement('div');
                  title.className = 'font-semibold text-white truncate mb-1';
                  title.textContent = lesson.title || 'Group Lesson';
                  lessonCard.appendChild(title);
                  

                  const time = document.createElement('div');
                  time.className = 'text-white text-xs truncate mb-1';
                  // Handle both Date objects and ISO string formats, use direct timezone
                  const startTime = lesson.startTime instanceof Date ? lesson.startTime : new Date(lesson.startTime);
                  const endTime = lesson.endTime instanceof Date ? lesson.endTime : new Date(lesson.endTime);
                  
                  const startHours = String(startTime.getHours()).padStart(2, '0');
                  const startMinutes = String(startTime.getMinutes()).padStart(2, '0');
                  const endHours = String(endTime.getHours()).padStart(2, '0');
                  const endMinutes = String(endTime.getMinutes()).padStart(2, '0');
                  
                  time.textContent = `${startHours}:${startMinutes} - ${endHours}:${endMinutes}`;
                  lessonCard.appendChild(time);

                  if (lesson.location || lesson.type) {
                    const location = document.createElement('div');
                    location.className = 'text-blue-600 text-xs truncate';
                    location.textContent = lesson.location || lesson.type || '';
                    lessonCard.appendChild(location);
                  }

                  // Add hover effect to bring card to front
                  lessonCard.addEventListener('mouseenter', () => {
                    lessonCard.style.zIndex = 100;
                  });
                  
                  lessonCard.addEventListener('mouseleave', () => {
                    lessonCard.style.zIndex = 10 + index;
                  });

                  // Add click handler to view lesson details
                  lessonCard.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openLessonDetailsModal({
                      lesson: lesson,
                      student: { name: lesson.title || lesson.studentName },
                      onClose: () => {
                        console.log('Lesson details modal closed');
                      }
                    });
                  });

                  lessonsContainer.appendChild(lessonCard);
                });

                slotCell.appendChild(lessonsContainer);
                slotCell.className += ' bg-blue-50';
                slotCell.title = `Lessons at ${slotTime} (${scheduledLessons.length} lesson${scheduledLessons.length > 1 ? 's' : ''})`;
                }
              } else {
                // Available slot
                slotCell.className += ' bg-green-50 text-green-700 hover:bg-green-200 cursor-pointer';
                slotCell.textContent = '';
                slotCell.title = `${slotTime} - Available`;

                slotCell.addEventListener('click', () => selectTimeSlot(slotCell, dayDate, slotTime));
              }
            }

            bookLessonEls.calendarGrid.appendChild(slotCell);
          }
        });
      }

      function generateFallbackCalendar(weekStart) {
        // Fallback calendar when backend data is not available
        console.log('Generating fallback calendar');
        
        // Clear the calendar grid first
        bookLessonEls.calendarGrid.innerHTML = '';
        
        // Define opening hours for each day of the week - 10:00-20:00 for all days
        const openingHours = {
          0: { start: 10, end: 20 }, // Sunday: 10-20
          1: { start: 10, end: 20 }, // Monday: 10-20
          2: { start: 10, end: 20 }, // Tuesday: 10-20
          3: { start: 10, end: 20 }, // Wednesday: 10-20
          4: { start: 10, end: 20 }, // Thursday: 10-20
          5: { start: 10, end: 20 }, // Friday: 10-20
          6: { start: 10, end: 20 }  // Saturday: 10-20
        };
        
        // Generate time slots based on opening hours for each day
        const allTimeSlots = new Set();
        
        // Check each day of the week to get the full range of opening hours
        for (let day = 0; day < 7; day++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + day);
          const dayOfWeek = dayDate.getDay();
          const hours = openingHours[dayOfWeek];
          
          // Add time slots for this day's opening hours
          for (let hour = hours.start; hour <= hours.end; hour++) {
            allTimeSlots.add(`${hour.toString().padStart(2, '0')}:00`);
          }
        }
        
        // Convert to sorted array
        const timeSlots = Array.from(allTimeSlots).sort();
        console.log('Fallback time slots:', timeSlots);
        
        // Generate grid rows
        timeSlots.forEach(slotTime => {
          const hour = parseInt(slotTime.split(':')[0]);
          const minute = parseInt(slotTime.split(':')[1]) || 0;
          
          // Use 60px height for time slots
          const cellHeight = 60;
          
          // Time column
          const timeCell = document.createElement('div');
          timeCell.className = 'px-2 text-sm text-gray-600 border-r border-gray-200 bg-gray-50 flex items-center relative';
          timeCell.style.height = `${cellHeight}px`;
          timeCell.textContent = slotTime;
          
          // Add horizontal line through the entire calendar width
          const horizontalLine = document.createElement('div');
          horizontalLine.className = 'absolute top-0 left-0 h-px bg-gray-300';
          horizontalLine.style.width = 'calc(100% * 8)'; // Span all 8 columns
          horizontalLine.style.zIndex = '10';
          timeCell.appendChild(horizontalLine);
          
          bookLessonEls.calendarGrid.appendChild(timeCell);

          // Day columns (Monday to Sunday)
          for (let day = 0; day < 7; day++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + day);
            
            const slotCell = document.createElement('div');
            slotCell.className = 'px-1 text-sm border-r border-gray-200 transition-colors flex flex-col justify-start relative bg-gray-50 p-0 cursor-pointer hover:bg-gray-100';
            slotCell.style.height = `${cellHeight}px`;
            slotCell.dataset.day = day;
            slotCell.dataset.hour = hour;
            slotCell.dataset.date = dayDate.toISOString().split('T')[0];
            slotCell.dataset.time = slotTime;
            
            // All slots are available in fallback mode
            slotCell.title = `${slotTime} - Available`;
            
            // Add click handler for booking
            slotCell.addEventListener('click', () => selectTimeSlot(slotCell, dayDate, slotTime));
            
            bookLessonEls.calendarGrid.appendChild(slotCell);
          }
        });
        
        console.log('Fallback calendar generated with', timeSlots.length, 'time slots');
      }

      function createSimpleBookingCalendar(weekStart) {
        console.log('Creating simple booking calendar for week:', weekStart);
        
        // Clear the calendar grid
        bookLessonEls.calendarGrid.innerHTML = '';
        
        // Create a simple calendar with time slots 10:00-20:00
        const timeSlots = ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
        
        // Generate calendar rows
        timeSlots.forEach(slotTime => {
          const hour = parseInt(slotTime.split(':')[0]);
          
          // Time column
          const timeCell = document.createElement('div');
          timeCell.className = 'px-2 text-sm text-gray-600 border-r border-gray-200 bg-gray-50 flex items-center relative';
          timeCell.style.height = '60px';
          timeCell.textContent = slotTime;
          
          // Add horizontal line through the entire calendar width
          const horizontalLine = document.createElement('div');
          horizontalLine.className = 'absolute top-0 left-0 h-px bg-gray-300';
          horizontalLine.style.width = 'calc(100% * 8)'; // Span all 8 columns
          horizontalLine.style.zIndex = '10';
          timeCell.appendChild(horizontalLine);
          
          bookLessonEls.calendarGrid.appendChild(timeCell);

          // Day columns (Monday to Sunday)
          for (let day = 0; day < 7; day++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + day);
            
            const slotCell = document.createElement('div');
            slotCell.className = 'px-1 text-sm border-r border-gray-200 transition-colors flex flex-col justify-start relative bg-gray-50 p-0 cursor-pointer hover:bg-gray-100';
            slotCell.style.height = '60px';
            slotCell.dataset.day = day;
            slotCell.dataset.hour = hour;
            slotCell.dataset.date = dayDate.toISOString().split('T')[0];
            slotCell.dataset.time = slotTime;
            slotCell.title = `${slotTime} - Click to book lesson`;
            
            // Add click handler for booking
            slotCell.addEventListener('click', () => {
              console.log('Time slot clicked:', slotTime, 'on', dayDate.toISOString().split('T')[0]);
              alert(`Booking lesson for ${slotTime} on ${dayDate.toISOString().split('T')[0]}`);
            });
            
            bookLessonEls.calendarGrid.appendChild(slotCell);
          }
        });
        
        console.log('Simple booking calendar created with', timeSlots.length, 'time slots');
      }

      function generateCalendarGrid(weekStart) {
        // Prevent multiple simultaneous calendar generations
        if (window.calendarGenerating) {
          console.log('⚠️ Calendar already being generated, skipping...');
          return;
        }
        window.calendarGenerating = true;
        
        // Clear existing grid
        bookLessonEls.calendarGrid.innerHTML = '';

        // Fetch lessons for the week and log to console
        console.log('=== Fetching lessons for week:', weekStart, '===');
        
        // Log the exact date being sent to backend
        console.log('📅 Frontend weekStart:', weekStart);
        console.log('📅 Frontend weekStart.toISOString():', weekStart.toISOString());
        console.log('📅 Frontend weekStart local string:', weekStart.toLocaleString());
        
        // Calculate the date range that should be fetched
        const endDate = new Date(weekStart);
        endDate.setDate(weekStart.getDate() + 7);
        console.log('📅 Frontend date range:', weekStart.toISOString(), 'to', endDate.toISOString());
        
        // Try to fetch lessons from Google Sheets using debug function
        console.log('🔍 Calling getExistingLessonsFromSheet...');
        console.log('🔍 About to call getExistingLessonsFromSheet...');
        
        // Show loading spinner
        bookLessonEls.calendarGrid.innerHTML = `
          <div class="col-span-8 flex flex-col items-center justify-center min-h-[400px] w-full bg-gray-50 rounded-lg p-8">
            <div class="relative">
              <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200"></div>
              <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent absolute top-0 left-0"></div>
            </div>
            <div class="mt-4 text-center">
              <p class="text-lg font-medium text-gray-900">Loading Lessons</p>
              <p class="text-sm text-gray-500 mt-1">Fetching schedule data...</p>
            </div>
          </div>
        `;
        
        try {
          google.script.run
            .withSuccessHandler(function(result) {
              console.log('✅ Raw result received:', result);
              console.log('✅ Data type:', typeof result);
              console.log('✅ Data stringified:', JSON.stringify(result));
              
              // Check if result has error property
              if (result && result.error) {
                console.error('❌ Backend error:', result.error);
                console.error('❌ Error stack:', result.stack);
                generateFallbackCalendar(weekStart);
                return;
              }
              
              // Check if result has success property and it's false
              if (result && result.success === false) {
                console.error('❌ Backend returned success: false');
                console.error('❌ Error:', result.error);
                generateFallbackCalendar(weekStart);
                return;
              }
              
              // Try to parse the data if it's a string
              let lessonsByDay = result;
              if (typeof result === 'string') {
                try {
                  lessonsByDay = JSON.parse(result);
                  console.log('✅ Successfully parsed JSON data:', lessonsByDay);
                } catch (e) {
                  console.error('❌ Failed to parse JSON:', e);
                  generateFallbackCalendar(weekStart);
                  return;
                }
              }
              
              console.log('✅ Processed lesson data:', lessonsByDay);
              if (lessonsByDay && Object.keys(lessonsByDay).length > 0) {
                console.log('📊 Total days with lessons:', Object.keys(lessonsByDay).length);
                console.log('📅 Lessons by day:', lessonsByDay);
                
                // Log detailed lesson information
                Object.keys(lessonsByDay).forEach(date => {
                  const dayLessons = lessonsByDay[date];
                  console.log(`📆 ${date}: ${Object.keys(dayLessons).length} time slots`);
                  Object.keys(dayLessons).forEach(time => {
                    const timeLessons = dayLessons[time];
                    console.log(`  ${time}: ${timeLessons.length} lessons`);
                    timeLessons.forEach((lesson, index) => {
                      console.log(`    ${index + 1}. ${lesson.studentName} (${lesson.status})`);
                    });
                  });
                });
                
                // Generate calendar with lesson cards
                generateCalendarWithLessonCards(weekStart, lessonsByDay);
                window.calendarGenerating = false;
              } else {
                console.log('⚠️ No lesson data returned or empty object');
                generateFallbackCalendar(weekStart);
                window.calendarGenerating = false;
              }
            })
            .withFailureHandler(function(error) {
              console.error('❌ Error in getExistingLessonsFromSheet:', error);
              // Fallback to simple calendar
              generateFallbackCalendar(weekStart);
              window.calendarGenerating = false;
            })
            .getExistingLessonsFromSheet(weekStart.toISOString());
        } catch (error) {
          console.error('❌ Error calling debug function:', error);
          generateFallbackCalendar(weekStart);
          window.calendarGenerating = false;
        }
      }

      function selectTimeSlot(cell, date, time) {
        // Open the time slot selection modal
        openTimeSlotModal({
          date: date,
          time: time,
          student: student,
          onClose: () => {
            // Close the time slot modal and return to booking modal
          },
          onConfirm: (lessonData) => {
            // Handle the lesson booking
            handleTimeSlotBooking(lessonData);
          }
        });
      }

      function updateWeekDisplay(weekStart) {
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const startStr = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const endStr = weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        bookLessonEls.currentWeekDisplay.textContent = `Week of ${startStr} - ${endStr}`;
        
        // Update date numbers in the calendar header
        for (let day = 0; day < 7; day++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + day);
          const dateElement = document.getElementById(`date-${day}`);
          if (dateElement) {
            dateElement.textContent = dayDate.getDate();
          }
        }
      }

      function navigateWeek(direction) {
        currentWeek.setDate(currentWeek.getDate() + (direction * 7));
        updateWeekDisplay(currentWeek);
        generateCalendarGrid(currentWeek);
      }

      // Removed clearSelection function - no longer needed with time slot modal

      const doClose = () => { onClose(); cleanup(); };

      function cleanup(){
        bookLessonEls.close.removeEventListener('click', doClose);
        bookLessonEls.cancel.removeEventListener('click', doClose);
        bookLessonEls.prevWeekBtn.removeEventListener('click', () => navigateWeek(-1));
        bookLessonEls.nextWeekBtn.removeEventListener('click', () => navigateWeek(1));
        hide(bookLessonEls.root);
      }

      // Removed old handleSaveLesson function - now using time slot modal

      // Initialize calendar
      updateWeekDisplay(currentWeek);
      generateCalendarGrid(currentWeek);

      // Add event listeners
      bookLessonEls.close.addEventListener('click', doClose);
      bookLessonEls.cancel.addEventListener('click', doClose);
      bookLessonEls.prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
      bookLessonEls.nextWeekBtn.addEventListener('click', () => navigateWeek(1));
      
      show(bookLessonEls.root);
    }

    function openPaymentModal({ mode='add', payment=null, onSave=()=>{}, onDelete=()=>{}, onClose=()=>{} }={}){
      payEls.title.textContent = mode === 'edit' ? 'Edit Payment' : 'Add Payment';
      payEls.del.classList.toggle('hidden', mode !== 'edit');

      // Auto-generate transaction ID for new payments
      if (mode === 'add') {
        payEls.txn.value = generateTransactionId();
      } else {
        payEls.txn.value = payment?.['Transaction ID'] || payment?.transactionId || '';
      }
      
      // Default to today's date for new payments
      if (mode === 'add') {
        payEls.date.value = new Date().toISOString().slice(0, 10);
      } else {
        payEls.date.value = payment?.Date ? new Date(payment.Date).toISOString().slice(0,10) : (payment?.date || '').slice(0,10);
      }
      
      payEls.lessons.value = payment?.Amount ?? payment?.lessons ?? '';
      payEls.month.value = payment?.Month || payment?.month || new Date().toLocaleString('en-US', { month: 'long' });
      const rawTotal = payment?.Total ?? (payment?.price ? String(payment.price).replace(/[^0-9]/g,'') : '');
      payEls.price.value   = rawTotal;
      payEls.method.value  = payment?.Method || payment?.method || 'Card';
      payEls.staff.value   = payment?.Staff  || payment?.staff  || '';

      // Auto-fill lessons and staff for new payments
      if (mode === 'add' && window.google && google.script && google.script.run) {
        // Get scheduled lessons count
        const studentId = student?.id || student?.ID || '';
        if (studentId) {
          google.script.run
            .withSuccessHandler(function(lessonsCount) {
              if (lessonsCount > 0) {
                payEls.lessons.value = lessonsCount;
                // Auto-calculate price based on lessons
                calculatePrice(lessonsCount);
              }
            })
            .withFailureHandler(function(error) {
              console.error('Failed to get scheduled lessons:', error);
            })
            .getScheduledLessonsCount(studentId);
        }
        
        // Get staff name
        google.script.run
          .withSuccessHandler(function(staffName) {
            if (staffName && !payEls.staff.value) {
              payEls.staff.value = staffName;
            }
          })
          .withFailureHandler(function(error) {
            console.error('Failed to get staff name:', error);
          })
          .getCurrentStaffName();
      }

      const submit = (e) => {
        e.preventDefault();
        const iso = payEls.date.value;
        const d   = new Date(iso);
        const payload = {
          'Student ID': student?.id || student?.ID || '', // Add Student ID
          'Transaction ID': payEls.txn.value.trim(),
          Date: iso,
          Year: String(d.getFullYear()),
          Month: payEls.month.value,
          Total: String(payEls.price.value || ''), // store numeric string
          Amount: String(payEls.lessons.value || ''),
          Method: payEls.method.value,
          Staff: payEls.staff.value.trim()
        };
        console.log('Payment payload being sent:', payload);
        console.log('Price value:', payEls.price.value);
        console.log('Lessons value:', payEls.lessons.value);
        onSave(payload);
        cleanup();
      };
      const doDelete = () => { if(mode==='edit'){ onDelete(payment); cleanup(); } };
      const doClose  = () => { onClose(); cleanup(); };

      function cleanup(){
        payEls.form.removeEventListener('submit', submit);
        payEls.del.removeEventListener('click', doDelete);
        payEls.close.removeEventListener('click', doClose);
        hide(payEls.root);
      }

      // Add event listener for lessons field to auto-calculate price
      payEls.lessons.addEventListener('input', function() {
        const lessonsCount = parseInt(this.value) || 0;
        if (lessonsCount > 0) {
          calculatePrice(lessonsCount);
        } else {
          payEls.price.value = '';
        }
      });

      payEls.form.addEventListener('submit', submit);
      payEls.del.addEventListener('click', doDelete);
      payEls.close.addEventListener('click', doClose);
      show(payEls.root);
      setTimeout(()=> payEls.txn.focus(), 0);
    }

    // ---------- Student Modal API ----------
    const studentEls = {
      root: $('#studentModal'), form: $('#studentForm'), title: $('#studentModalTitle'),
      close: $('#studentClose'), cancel: $('#studentCancel'), del: $('#studentDelete'),
      name: $('#s_name'), kanji: $('#s_kanji'), phone1: $('#s_phone1'), phone2: $('#s_phone2'), phone3: $('#s_phone3'), email: $('#s_email'),
      child: $('#s_child'), group: $('#s_group'), groupSize: $('#s_groupSize'), groupSizeContainer: $('#s_groupSizeContainer'),
    };

    const editStudentEls = {
      root: $('#editStudentModal'), form: $('#editStudentForm'), title: $('#editStudentTitle'),
      close: $('#editStudentClose'), cancel: $('#e_cancel'), del: $('#e_delete'),
      name: $('#e_name'), kanji: $('#e_kanji'), phone1: $('#e_phone1'), phone2: $('#e_phone2'), phone3: $('#e_phone3'), email: $('#e_email'),
      child: $('#e_child'), status: $('#e_status'), paytype: $('#e_paytype'), cancelSD: $('#e_cancelSD'),
      group: $('#e_group'), groupSize: $('#e_groupSize'), groupSizeContainer: $('#e_groupSizeContainer')
    };

    // ---- Phone helpers ----
    function splitPhone(str){
      const d = (str||'').replace(/[^0-9]/g,'').slice(0,11);
      return [d.slice(0,3), d.slice(3,7), d.slice(7,11)];
    }
    function setPhone(str, els){
      const [a,b,c] = splitPhone(str);
      if (els.phone1) els.phone1.value = a || '';
      if (els.phone2) els.phone2.value = b || '';
      if (els.phone3) els.phone3.value = c || '';
    }
    function combinePhone(els){
      const a = (els.phone1?.value || '').trim();
      const b = (els.phone2?.value || '').trim();
      const c = (els.phone3?.value || '').trim();
      if (!a && !b && !c) return '';
      return `${a}-${b}-${c}`;
    }
    function attachPhoneHandlers(els){
      const fields = [els.phone1, els.phone2, els.phone3];
      const max = [3,4,4];
      fields.forEach((f,i)=>{
        if(!f) return;
        f.addEventListener('input', (e)=>{
          const clean = e.target.value.replace(/[^0-9]/g,'');
          e.target.value = clean.slice(0, max[i]);
          if (e.target.value.length === max[i] && i < fields.length-1) fields[i+1].focus();
        });
        f.addEventListener('keydown', (e)=>{
          if (e.key === 'Backspace' && e.target.selectionStart === 0 && e.target.selectionEnd === 0 && !e.target.value && i>0) {
            fields[i-1].focus();
          }
        });
      });
      if (fields[0]) {
        fields[0].addEventListener('paste', (e)=>{
          const t = (e.clipboardData || window.clipboardData).getData('text');
          const d = (t||'').replace(/[^0-9]/g,'').slice(0,11);
          if(!d) return;
          e.preventDefault();
          fields[0].value = d.slice(0,3);
          fields[1].value = d.slice(3,7);
          fields[2].value = d.slice(7,11);
          if (fields[2].value) fields[2].focus(); else if (fields[1].value) fields[1].focus(); else fields[0].focus();
        });
      }
    }

    function openStudentModal({ mode='add', student=null, onSave=()=>{}, onDelete=()=>{}, onClose=()=>{} }={}){
      studentEls.title.textContent = mode === 'edit' ? 'Edit Student' : 'Add Student';
      studentEls.del.classList.toggle('hidden', mode !== 'edit');

      // Prefill
      studentEls.name.value   = student?.student?.Name || student?.name || '';
      studentEls.kanji.value  = student?.student?.['漢字'] || student?.kanji || '';
      setPhone(student?.student?.phone || student?.phone || '', studentEls);
      studentEls.email.value  = student?.student?.email || '';
      studentEls.child.checked= !!(student?.student?.['子'] || student?.child);

      const submit = (e) => {
        e.preventDefault();
        if (!studentEls.form.reportValidity()) { return; }
        const backend = {
          student: {
            Name: studentEls.name.value.trim(),
            '漢字': studentEls.kanji.value.trim() || undefined,
            Phone: (combinePhone(studentEls) || undefined),
            Email: studentEls.email.value.trim() || undefined,
            'phone (secondary)': '',
            Status: 'DEMO',
            '子': studentEls.child.checked ? '子' : undefined,
            Payment: 'NEO',
            Group: studentEls.group.value || 'Individual',
            '人数': studentEls.group.value === 'Group' ? (studentEls.groupSize.value || '2') : '1',
            '当日': '未'
          },
          payments: [],
          notes: []
        };
        const internal = {
          name: studentEls.name.value.trim(),
          kanji: studentEls.kanji.value.trim(),
          status: 'DEMO',
          latestByMonth: {},
          payments: [],
          notes: []
        };
        onSave({ backend, internal });
        cleanup();
      };
      const doDelete = () => { if (mode==='edit') { onDelete(student); cleanup(); } };
      const doClose  = () => { onClose(); cleanup(); };

      function cleanup(){
        studentEls.form.removeEventListener('submit', submit);
        studentEls.del.removeEventListener('click', doDelete);
        studentEls.close.removeEventListener('click', doClose);
        studentEls.cancel.removeEventListener('click', doClose);
        hide(studentEls.root);
      }

      studentEls.form.addEventListener('submit', submit);
      studentEls.del.addEventListener('click', doDelete);
      studentEls.close.addEventListener('click', doClose);
      studentEls.cancel.addEventListener('click', doClose);

      show(studentEls.root);
      setTimeout(()=> studentEls.name.focus(), 0);
    }

    function openEditStudentModal({ student, onSave=()=>{}, onDelete=()=>{}, onClose=()=>{} }={}){
      const original = student || {};

      // Prefill from either backend payload or internal model
      editStudentEls.name.value  = original?.student?.Name || original?.name || '';
      editStudentEls.kanji.value = original?.student?.['漢字'] || original?.kanji || '';
      setPhone(original?.student?.phone || original?.phone || '', editStudentEls);
      editStudentEls.email.value = original?.student?.email || original?.email || '';
      editStudentEls.child.checked = !!(original?.student?.['子'] || original?.child || original?.child);
      editStudentEls.status.value  = original?.student?.Status || original?.status || 'Active';
      editStudentEls.paytype.value = original?.student?.['Payment Type'] || original?.paymentType || original?.paymentType || 'NEO';
      editStudentEls.cancelSD.value = original?.student?.['当日'] || original?.student?.['当日キャンセル'] || original?.cancelSameDay || original?.cancelSameDay || '未';
      editStudentEls.group.value = original?.student?.Group || original?.group || original?.group || 'Individual';
      editStudentEls.groupSize.value = original?.student?.['人数'] || original?.groupSize || original?.groupSize || '2';
      
      // Show/hide group size container based on current group value
      if (editStudentEls.groupSizeContainer) {
        if (editStudentEls.group.value === 'Group') {
          editStudentEls.groupSizeContainer.classList.remove('hidden');
        } else {
          editStudentEls.groupSizeContainer.classList.add('hidden');
        }
      }

      // Custom phone validation - remove pattern validation temporarily
      if (editStudentEls.phone1) editStudentEls.phone1.removeAttribute('pattern');
      if (editStudentEls.phone2) editStudentEls.phone2.removeAttribute('pattern');
      if (editStudentEls.phone3) editStudentEls.phone3.removeAttribute('pattern');

      const submit = (e) => {
        e.preventDefault();
        
        // Custom phone validation
        const phone1 = editStudentEls.phone1?.value || '';
        const phone2 = editStudentEls.phone2?.value || '';
        const phone3 = editStudentEls.phone3?.value || '';
        
        if (!phone1 || !phone2 || !phone3) {
          openConfirmModal({
            title: 'Validation Error',
            message: 'Please fill in all phone number fields',
            onConfirm: () => {
              // Just close the modal
            },
            onCancel: () => {
              // Just close the modal
            }
          });
          return;
        }
        
        if (!/^\d{3}$/.test(phone1) || !/^\d{4}$/.test(phone2) || !/^\d{4}$/.test(phone3)) {
          openConfirmModal({
            title: 'Validation Error',
            message: 'Please enter valid phone numbers (3 digits, 4 digits, 4 digits)',
            onConfirm: () => {
              // Just close the modal
            },
            onCancel: () => {
              // Just close the modal
            }
          });
          return;
        }
        
        if (!editStudentEls.form.reportValidity()) return;

        const status = editStudentEls.status ? editStudentEls.status.value : (original?.student?.Status || original?.status || 'Active');
        const ptype  = editStudentEls.paytype ? editStudentEls.paytype.value : (original?.student?.['Payment Type'] || 'NEO');
        const cancelSD = editStudentEls.cancelSD ? editStudentEls.cancelSD.value : (original?.student?.['当日キャンセル'] || '未');

        const backend = {
          student: {
            Name: editStudentEls.name.value.trim(),
            '漢字': editStudentEls.kanji.value.trim() || undefined,
            Phone: (combinePhone(editStudentEls) || undefined),
            Email: editStudentEls.email.value.trim() || undefined,
            'phone (secondary)': '',
            Status: status,
            '子': editStudentEls.child.checked ? '子' : undefined,
            Payment: ptype,
            '当日': cancelSD,
            Group: editStudentEls.group.value || 'Individual',
            '人数': editStudentEls.group.value === 'Group' ? (editStudentEls.groupSize.value || '2') : '1'
          }
        };

        const internal = {
          name: editStudentEls.name.value.trim(),
          kanji: editStudentEls.kanji.value.trim(),
          status: status,
          paymentType: ptype,
          cancelSameDay: cancelSD,
          child: editStudentEls.child.checked,
          phone: combinePhone(editStudentEls),
          email: editStudentEls.email.value.trim()
        };

        onSave({ backend, internal, original });
        cleanup();
      };

      const doDelete = () => { onDelete(original); cleanup(); };
      const doClose  = () => { onClose(); cleanup(); };

      function cleanup(){
        editStudentEls.form.removeEventListener('submit', submit);
        editStudentEls.del.removeEventListener('click', doDelete);
        editStudentEls.close.removeEventListener('click', doClose);
        editStudentEls.cancel.removeEventListener('click', doClose);
        hide(editStudentEls.root);
      }

      editStudentEls.form.addEventListener('submit', submit);
      editStudentEls.del.addEventListener('click', doDelete);
      editStudentEls.close.addEventListener('click', doClose);
      editStudentEls.cancel.addEventListener('click', doClose);

      show(editStudentEls.root);
      setTimeout(()=> editStudentEls.name.focus(), 0);
    }

    // Attach phone handlers
    attachPhoneHandlers(studentEls);
    attachPhoneHandlers(editStudentEls);
    
    // Attach group handlers
    function attachGroupHandlers(els) {
      if (els.group) {
        els.group.addEventListener('change', function() {
          if (els.groupSizeContainer) {
            if (this.value === 'Group') {
              els.groupSizeContainer.classList.remove('hidden');
            } else {
              els.groupSizeContainer.classList.add('hidden');
            }
          }
        });
      }
    }
    
    attachGroupHandlers(studentEls);
    attachGroupHandlers(editStudentEls);

    // Offline Queue System for handling failed operations
    const OfflineQueue = {
      queue: [],
      isOnline: navigator.onLine,
      
      init() {
        // Listen for online/offline events
        window.addEventListener('online', () => {
          this.isOnline = true;
          this.processQueue();
          this.updateConnectionStatus('online');
        });
        
        window.addEventListener('offline', () => {
          this.isOnline = false;
          this.updateConnectionStatus('offline');
        });
        
        // Load existing queue from localStorage
        this.loadQueue();
        
        // Process queue on page load if online
        if (this.isOnline) {
          this.processQueue();
        }
      },
      
      addOperation(operation) {
        const queueItem = {
          id: Date.now() + Math.random(),
          timestamp: new Date().toISOString(),
          operation: operation,
          retryCount: 0,
          maxRetries: 3
        };
        
        this.queue.push(queueItem);
        this.saveQueue();
        this.updateQueueStatus();
        
        console.log('📝 Added operation to offline queue:', queueItem);
      },
      
      async processQueue() {
        if (!this.isOnline || this.queue.length === 0) return;
        
        console.log('🔄 Processing offline queue...', this.queue.length, 'operations');
        
        const operationsToProcess = [...this.queue];
        this.queue = [];
        
        for (const item of operationsToProcess) {
          try {
            await this.executeOperation(item);
            console.log('✅ Successfully processed queued operation:', item.id);
          } catch (error) {
            console.error('❌ Failed to process queued operation:', item.id, error);
            
            // Retry if under max retries
            if (item.retryCount < item.maxRetries) {
              item.retryCount++;
              this.queue.push(item);
              console.log(`🔄 Retrying operation ${item.id} (attempt ${item.retryCount})`);
            } else {
              console.error('💀 Operation failed permanently:', item.id);
              this.showFailedOperation(item);
            }
          }
        }
        
        this.saveQueue();
        this.updateQueueStatus();
      },
      
      async executeOperation(item) {
        const { operation } = item;
        
        if (!window.google || !google.script || !google.script.run) {
          throw new Error('Google Apps Script not available');
        }
        
        return new Promise((resolve, reject) => {
          const scriptCall = google.script.run[operation.method](...operation.params);
          
          scriptCall
            .withSuccessHandler(resolve)
            .withFailureHandler(reject);
        });
      },
      
      saveQueue() {
        try {
          localStorage.setItem('offlineQueue', JSON.stringify(this.queue));
        } catch (error) {
          console.error('Failed to save offline queue:', error);
        }
      },
      
      loadQueue() {
        try {
          const saved = localStorage.getItem('offlineQueue');
          if (saved) {
            this.queue = JSON.parse(saved);
            console.log('📥 Loaded offline queue:', this.queue.length, 'operations');
          }
        } catch (error) {
          console.error('Failed to load offline queue:', error);
          this.queue = [];
        }
      },
      
      updateConnectionStatus(status) {
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
          statusEl.className = `px-2 py-1 rounded text-xs ${
            status === 'online' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
          }`;
          statusEl.textContent = status === 'online' ? '🟢 Online' : '🔴 Offline';
        }
      },
      
      updateQueueStatus() {
        const queueEl = document.getElementById('queueStatus');
        if (queueEl && this.queue.length > 0) {
          queueEl.className = 'px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800';
          queueEl.textContent = `⏳ ${this.queue.length} pending`;
          queueEl.style.display = 'inline-block';
        } else if (queueEl) {
          queueEl.style.display = 'none';
        }
      },
      
      showFailedOperation(item) {
        openConfirmModal({
          title: 'Sync Failed',
          message: `Failed to sync ${item.operation.type} operation after ${item.maxRetries} attempts. The data is saved locally but not on the server. Would you like to retry manually?`,
          onConfirm: () => {
            item.retryCount = 0;
            this.queue.push(item);
            this.saveQueue();
            this.updateQueueStatus();
            this.processQueue();
          },
          onCancel: () => {
            // Remove from queue permanently
            console.log('🗑️ Permanently removed failed operation:', item.id);
          }
        });
      }
    };
    
    // Initialize offline queue system
    OfflineQueue.init();

    // Enhanced cache management for dynamic updates
    function updateStudentCache(studentId, type, data, revert = false, oldData = null) {
      if (!studentId) return;
      
      const cacheKey = String(studentId);
      
      // Update memory cache
      if (window._studentDetailsCache && window._studentDetailsCache[cacheKey]) {
        const cachedData = window._studentDetailsCache[cacheKey];
        
        if (revert) {
          // Revert changes - remove the last item or specific item
          if (type === 'payment' && cachedData.payments) {
            if (data === null) {
              // Special case: remove all payments (for deletion)
              cachedData.payments = [];
            } else {
              // Remove the last item
              cachedData.payments.pop();
            }
          } else if (type === 'note' && cachedData.notes) {
            if (data === null) {
              // Special case: remove all notes (for deletion)
              cachedData.notes = [];
            } else {
              // Remove the last item
              cachedData.notes.pop();
            }
          }
        } else {
          // Add new data or update existing data
          if (type === 'payment') {
            if (!cachedData.payments) cachedData.payments = [];
            if (data) {
              // Check if this is an update (has oldData) or a new addition
              if (oldData) {
                // Update existing payment
                const index = cachedData.payments.findIndex(p => 
                  p['Transaction ID'] === oldData['Transaction ID'] || 
                  p.transactionId === oldData.transactionId ||
                  p.id === oldData.id
                );
                if (index !== -1) {
                  cachedData.payments[index] = data;
                } else {
                  cachedData.payments.push(data);
                }
              } else {
                // Add new payment
                cachedData.payments.push(data);
              }
            }
          } else if (type === 'note') {
            if (!cachedData.notes) cachedData.notes = [];
            if (data) {
              // Check if this is an update (has oldData) or a new addition
              if (oldData) {
                // Update existing note
                const index = cachedData.notes.findIndex(n => 
                  n.ID === oldData.ID || 
                  (n.Date === oldData.Date && n.Note === oldData.Note && n.Staff === oldData.Staff)
                );
                if (index !== -1) {
                  cachedData.notes[index] = data;
                } else {
                  cachedData.notes.push(data);
                }
              } else {
                // Add new note
                cachedData.notes.push(data);
              }
            }
          } else if (type === 'student') {
            // Update student data
            Object.assign(cachedData.student, data);
          }
        }
        
        // Update localStorage cache
        const localStorageKey = `student_${cacheKey}`;
        if (typeof cacheManager !== 'undefined') {
          cacheManager.set(localStorageKey, cachedData, 1800000); // 30 minutes
        }
        
        console.log(`✅ Cache updated for student ${studentId}, type: ${type}, revert: ${revert}, update: ${!!oldData}`);
      }
    }

    function removePaymentFromCache(studentId, paymentToRemove) {
      if (!studentId || !paymentToRemove) return;
      
      const cacheKey = String(studentId);
      
      // Update memory cache
      if (window._studentDetailsCache && window._studentDetailsCache[cacheKey]) {
        const cachedData = window._studentDetailsCache[cacheKey];
        
        if (cachedData.payments) {
          // Find and remove the specific payment
          const transactionId = paymentToRemove['Transaction ID'] || 
                               paymentToRemove.transactionId || 
                               paymentToRemove.id || 
                               paymentToRemove['Txn'] || 
                               paymentToRemove.txn;
          
          if (transactionId) {
            cachedData.payments = cachedData.payments.filter(p => {
              const pId = p['Transaction ID'] || p.transactionId || p.id || p['Txn'] || p.txn;
              return pId !== transactionId;
            });
          }
        }
        
        // Update localStorage cache
        const localStorageKey = `student_${cacheKey}`;
        if (typeof cacheManager !== 'undefined') {
          cacheManager.set(localStorageKey, cachedData, 1800000); // 30 minutes
        }
        
        console.log(`✅ Removed payment from cache for student ${studentId}`);
      }
    }

    function removeNoteFromCache(studentId, noteToRemove) {
      if (!studentId || !noteToRemove) return;
      
      const cacheKey = String(studentId);
      
      // Update memory cache
      if (window._studentDetailsCache && window._studentDetailsCache[cacheKey]) {
        const cachedData = window._studentDetailsCache[cacheKey];
        
        if (cachedData.notes) {
          // Find and remove the specific note by matching Date, Note, and Staff
          cachedData.notes = cachedData.notes.filter(n => 
            !(n.Date === noteToRemove.Date && 
              n.Note === noteToRemove.Note && 
              n.Staff === noteToRemove.Staff)
          );
        }
        
        // Update localStorage cache
        const localStorageKey = `student_${cacheKey}`;
        if (typeof cacheManager !== 'undefined') {
          cacheManager.set(localStorageKey, cachedData, 1800000); // 30 minutes
        }
        
        console.log(`✅ Removed note from cache for student ${studentId}`);
      }
    }

    function updateStudentTableRow(studentId, studentData) {
      // Find the table row for this student
      const tableRows = document.querySelectorAll('#studentTable tr');
      const idIndex = window._headers ? window._headers.indexOf('ID') : -1;
      
      if (idIndex === -1) return;
      
      for (let i = 1; i < tableRows.length; i++) { // Skip header row
        const cells = tableRows[i].querySelectorAll('td');
        if (cells[idIndex] && cells[idIndex].textContent.trim() === String(studentId)) {
          // Update the row with new data
          const nameIndex = window._headers.indexOf('Name');
          const kanjiIndex = window._headers.indexOf('漢字');
          const statusIndex = window._headers.indexOf('Status');
          const emailIndex = window._headers.indexOf('Email');
          const phoneIndex = window._headers.indexOf('Phone');
          
          if (nameIndex !== -1 && cells[nameIndex]) {
            cells[nameIndex].textContent = studentData.Name || '';
          }
          if (kanjiIndex !== -1 && cells[kanjiIndex]) {
            cells[kanjiIndex].textContent = studentData['漢字'] || '';
          }
          if (statusIndex !== -1 && cells[statusIndex]) {
            const status = studentData.Status || '';
            let statusClass = '';
            switch(status) {
              case 'Active': statusClass = 'badge badge-status-active'; break;
              case 'Dormant': statusClass = 'badge badge-status-dormant'; break;
              case 'DEMO': statusClass = 'badge badge-status-demo'; break;
              default: statusClass = 'badge badge-status-dormant';
            }
            cells[statusIndex].innerHTML = '<span class="' + statusClass + '">' + status + '</span>';
            cells[statusIndex].style.textAlign = 'center';
          }
          if (emailIndex !== -1 && cells[emailIndex]) {
            cells[emailIndex].textContent = studentData.Email || '';
          }
          if (phoneIndex !== -1 && cells[phoneIndex]) {
            cells[phoneIndex].textContent = studentData.Phone || '';
          }
          
          console.log(`✅ Updated table row for student ${studentId}`);
          break;
        }
      }
    }

    function addStudentToTable(studentData) {
      // Add new student to the table
      const tableBody = document.querySelector('#studentTable');
      if (!tableBody || !window._headers) return;
      
      // Remove loading row if it exists
      const loadingRow = document.getElementById('loadingRow');
      if (loadingRow) {
        loadingRow.remove();
      }
      
      const newRow = document.createElement('tr');
      newRow.className = 'hover:bg-gray-50 cursor-pointer';
      
      // Handle temporary IDs
      if (studentData.ID && studentData.ID.startsWith('temp_')) {
        newRow.setAttribute('data-temp-id', studentData.ID);
        newRow.style.opacity = '0.7'; // Visual indicator for temporary row
      } else {
        newRow.addEventListener('click', () => openStudentDetails(studentData.ID));
        newRow.setAttribute('data-student-id', studentData.ID);
      }
      
      // Use the same order as the existing table
      const order = window._customOrder || window._headers;
      order.forEach(header => {
        const cell = document.createElement('td');
        cell.className = 'px-4 py-3 text-sm text-gray-900';
        
        const cellValue = studentData[header] || '';
        
        // Handle different column types with proper badge styling
        switch(header) {
          case '当日キャンセル':
            const cancelBadgeClass = cellValue === '済' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
            cell.innerHTML = '<span class="' + cancelBadgeClass + '">' + cellValue + '</span>';
            cell.style.textAlign = 'center';
            cell.className = 'text-center';
            break;
            
          case 'Status':
            let statusClass = '';
            switch(cellValue) {
              case 'Active': statusClass = 'badge badge-status-active'; break;
              case 'Dormant': statusClass = 'badge badge-status-dormant'; break;
              case 'DEMO': statusClass = 'badge badge-status-demo'; break;
              default: statusClass = 'badge badge-status-dormant';
            }
            cell.innerHTML = '<span class="' + statusClass + '">' + cellValue + '</span>';
            cell.style.textAlign = 'center';
            break;
            
          case 'Payment':
            const paymentClass = cellValue === 'NEO' ? 'badge badge-pay-neo' : 'badge badge-pay-old';
            cell.innerHTML = '<span class="' + paymentClass + '">' + cellValue + '</span>';
            cell.style.textAlign = 'center';
            break;
            
          case 'Group':
            const groupClass = cellValue === 'Individual' ? 'badge badge-group-individual' : 'badge badge-group-group';
            cell.innerHTML = '<span class="' + groupClass + '">' + cellValue + '</span>';
            cell.style.textAlign = 'center';
            break;
            
          case '当日 Cancellation':
            const cancelBadgeClass2 = cellValue === '済' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
            cell.innerHTML = '<span class="' + cancelBadgeClass2 + '">' + cellValue + '</span>';
            cell.style.textAlign = 'center';
            break;
            
          case '当日':
            const cancelBadgeClass3 = cellValue === '済' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
            cell.innerHTML = '<span class="' + cancelBadgeClass3 + '">' + cellValue + '</span>';
            cell.style.textAlign = 'center';
            break;
            
          case '人数':
            cell.style.textAlign = 'center';
            cell.textContent = cellValue;
            break;
            
          default:
            cell.textContent = cellValue;
            break;
        }
        
        newRow.appendChild(cell);
      });
      
      // Insert at the beginning (newest first)
      tableBody.insertBefore(newRow, tableBody.firstChild);
      
      // Also add to the data arrays
      if (window._rows && window._displayRows && window._headers) {
        const idIndex = window._headers.indexOf('ID');
        if (idIndex !== -1) {
          // Create a row array matching the headers
          const rowData = window._headers.map(header => studentData[header] || '');
          window._rows.unshift(rowData); // Add to beginning
          window._displayRows.unshift(rowData); // Add to beginning
          console.log(`✅ Added new student ${studentData.ID} to data arrays`);
        }
      }
      
      console.log(`✅ Added new student ${studentData.ID} to table`);
    }

    function updateLatestRecordWithPayment(payment) {
      if (!payment || !payment.Month || !payment.Amount) return;
      
      // Get current month and next month
      const now = new Date();
      const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const currentMonth = MONTHS[now.getMonth()];
      const nextMonth = MONTHS[(now.getMonth() + 1) % 12];
      
      // Determine which month this payment is for
      let targetMonth = currentMonth;
      if (payment.Month) {
        const monthStr = payment.Month.toLowerCase();
        if (monthStr.includes('jan')) targetMonth = 'Jan';
        else if (monthStr.includes('feb')) targetMonth = 'Feb';
        else if (monthStr.includes('mar')) targetMonth = 'Mar';
        else if (monthStr.includes('apr')) targetMonth = 'Apr';
        else if (monthStr.includes('may')) targetMonth = 'May';
        else if (monthStr.includes('jun')) targetMonth = 'Jun';
        else if (monthStr.includes('jul')) targetMonth = 'Jul';
        else if (monthStr.includes('aug')) targetMonth = 'Aug';
        else if (monthStr.includes('sep')) targetMonth = 'Sep';
        else if (monthStr.includes('oct')) targetMonth = 'Oct';
        else if (monthStr.includes('nov')) targetMonth = 'Nov';
        else if (monthStr.includes('dec')) targetMonth = 'Dec';
      }
      
      // Update the latestMap with payment status and unscheduled lessons
      if (!latestMap[targetMonth]) {
        latestMap[targetMonth] = { Payment: '済', lessons: [] };
      } else {
        latestMap[targetMonth].Payment = '済';
      }
      
      // Add unscheduled lessons based on payment amount
      const lessonCount = parseInt(payment.Amount) || 0;
      const existingLessons = latestMap[targetMonth].lessons || [];
      const scheduledLessons = existingLessons.filter(lesson => lesson.status !== 'unscheduled').length;
      const unscheduledCount = Math.max(0, lessonCount - scheduledLessons);
      
      // Remove existing unscheduled lessons
      latestMap[targetMonth].lessons = existingLessons.filter(lesson => lesson.status !== 'unscheduled');
      
      // Add new unscheduled lessons
      for (let i = 0; i < unscheduledCount; i++) {
        latestMap[targetMonth].lessons.push({
          day: '--',
          time: '--',
          status: 'unscheduled'
        });
      }
      
      // Update the Latest Record display
      updateLatestRecord();
      
      console.log(`✅ Updated Latest Record for ${targetMonth}: Payment=済, ${unscheduledCount} unscheduled lessons`);
    }

    function revertLatestRecordWithPayment(payment) {
      if (!payment || !payment.Month) return;
      
      console.log('🔄 Reverting Latest Record for payment:', payment);
      
      // Get current month and next month
      const now = new Date();
      const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const currentMonth = MONTHS[now.getMonth()];
      const nextMonth = MONTHS[(now.getMonth() + 1) % 12];
      
      // Determine which month this payment was for
      let targetMonth = currentMonth;
      if (payment.Month) {
        const monthStr = payment.Month.toLowerCase();
        console.log('🔍 Payment month string:', monthStr);
        if (monthStr.includes('jan')) targetMonth = 'Jan';
        else if (monthStr.includes('feb')) targetMonth = 'Feb';
        else if (monthStr.includes('mar')) targetMonth = 'Mar';
        else if (monthStr.includes('apr')) targetMonth = 'Apr';
        else if (monthStr.includes('may')) targetMonth = 'May';
        else if (monthStr.includes('jun')) targetMonth = 'Jun';
        else if (monthStr.includes('jul')) targetMonth = 'Jul';
        else if (monthStr.includes('aug')) targetMonth = 'Aug';
        else if (monthStr.includes('sep')) targetMonth = 'Sep';
        else if (monthStr.includes('oct')) targetMonth = 'Oct';
        else if (monthStr.includes('nov')) targetMonth = 'Nov';
        else if (monthStr.includes('dec')) targetMonth = 'Dec';
      }
      
      console.log('🎯 Target month for reversion:', targetMonth);
      
      // Revert payment status to unpaid
      console.log('🔍 Current latestMap:', latestMap);
      console.log('🔍 latestMap[targetMonth] before:', latestMap[targetMonth]);
      
      if (latestMap[targetMonth]) {
        latestMap[targetMonth].Payment = '未';
        console.log('🔍 latestMap[targetMonth] after:', latestMap[targetMonth]);
        
        // Remove unscheduled lessons that were added by this payment
        const lessonCount = parseInt(payment.Amount) || 0;
        const existingLessons = latestMap[targetMonth].lessons || [];
        const scheduledLessons = existingLessons.filter(lesson => lesson.status !== 'unscheduled').length;
        const unscheduledToRemove = Math.max(0, lessonCount - scheduledLessons);
        
        // Remove the unscheduled lessons
        let removedCount = 0;
        latestMap[targetMonth].lessons = existingLessons.filter(lesson => {
          if (lesson.status === 'unscheduled' && removedCount < unscheduledToRemove) {
            removedCount++;
            return false;
          }
          return true;
        });
      }
      
      // Update the Latest Record display
      updateLatestRecord();
      
      console.log(`✅ Reverted Latest Record for ${targetMonth}: Payment=未`);
    }

    // Wire up modal buttons
    document.getElementById('addPaymentBtn').addEventListener('click', () => {
      openPaymentModal({
        mode: 'add',
        onSave: (payment) => {
          // Optimistic update: Add payment to UI immediately
          if (!student.payments) student.payments = [];
          student.payments.push(payment);
          renderPaymentsTable();
          
          // Update cache immediately
          updateStudentCache(student.id, 'payment', payment);
          
          // Update Latest Record with new payment status and unscheduled lessons
          updateLatestRecordWithPayment(payment);
          
          // Save to backend
          if (window.google && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(result) {
                console.log('Payment added successfully:', result);
                // Update cache with server response
                updateStudentCache(student.id, 'payment', result);
              })
              .withFailureHandler(function(error) {
                console.error('Failed to add payment:', error);
                
                // Add to offline queue for retry
                OfflineQueue.addOperation({
                  type: 'payment',
                  method: 'insertPayment',
                  params: [payment],
                  studentId: student.id,
                  data: payment
                });
                
                // Show offline message instead of error
                openNotificationModal({
                  type: 'warning',
                  title: 'Payment Saved Locally',
                  message: 'Payment saved locally and will sync when connection is restored.'
                });
              })
              .insertPayment(payment);
          }
        }
      });
    });

    document.getElementById('addNoteBtn').addEventListener('click', () => {
      openNoteModal({
        mode: 'add',
        onSave: (note) => {
          // Optimistic update: Add note to UI immediately
          if (!student.notes) student.notes = [];
          student.notes.push(note);
          renderNotes();
          
          // Update cache immediately
          updateStudentCache(student.id, 'note', note);
          
          // Save to backend
          if (window.google && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(result) {
                console.log('Note added successfully:', result);
                // Update cache with server response
                updateStudentCache(student.id, 'note', result);
              })
              .withFailureHandler(function(error) {
                console.error('Failed to add note:', error);
                
                // Add to offline queue for retry
                OfflineQueue.addOperation({
                  type: 'note',
                  method: 'insertNote',
                  params: [note],
                  studentId: student.id,
                  data: note
                });
                
                // Show offline message instead of error
                openNotificationModal({
                  type: 'warning',
                  title: 'Note Saved Locally',
                  message: 'Note saved locally and will sync when connection is restored.'
                });
              })
              .addNote(note);
          }
        }
      });
    });

    // Wire up student edit button
    el.editBtn.addEventListener('click', () => {
      // Use the actual student data that's already loaded in the modal
      const currentStudent = student;
      
      // Store the current student ID for later use
      const currentStudentId = student?.id || student?.ID || '';
      console.log('Current student ID:', currentStudentId);
      
      // Open modal immediately with current data (no backend fetch needed)
      openEditStudentModal({
        student: currentStudent,
        onSave: ({ backend, internal }) => {
          // Optimistic update: Update UI immediately
          const oldStudent = { ...student };
          student = { ...student, ...internal };
          renderHeader();
          
          // Update table row immediately
          const studentId = currentStudentId || student?.id || student?.ID || '';
          updateStudentTableRow(studentId, backend.student);
          
          // Update cache immediately
          updateStudentCache(studentId, 'student', backend.student);
          
          // Save to backend
          if (window.google && google.script && google.script.run) {
            console.log('Attempting to update student with ID:', studentId);
            console.log('Backend data being sent:', backend.student);
            if (studentId) {
              google.script.run
                .withSuccessHandler(function(result) {
                  console.log('Student updated successfully:', result);
                  
                  // Update cache with server response
                  updateStudentCache(studentId, 'student', result);
                })
                .withFailureHandler(function(error) {
                  console.error('Failed to update student:', error);
                  
                  // Revert optimistic update
                  student = oldStudent;
                  renderHeader();
                  updateStudentTableRow(studentId, oldStudent);
                  updateStudentCache(studentId, 'student', oldStudent, true); // Revert
                  
                  openConfirmModal({
                    title: 'Error',
                    message: 'Failed to update student. Please try again.',
                    onConfirm: () => {
                      // Just close the modal
                    },
                    onCancel: () => {
                      // Just close the modal
                    }
                  });
                })
                .updateStudent({ ...backend.student, ID: studentId });
            } else {
              console.error('No student ID found for update');
              
              // Revert optimistic update
              student = oldStudent;
              renderHeader();
              updateStudentTableRow(studentId, oldStudent);
              updateStudentCache(studentId, 'student', oldStudent, true); // Revert
              
              openConfirmModal({
                title: 'Error',
                message: 'Cannot update student: No ID found',
                onConfirm: () => {
                  // Just close the modal
                },
                onCancel: () => {
                  // Just close the modal
                }
              });
            }
          } else {
            console.log('Student updated (backend not available):', backend);
          }
        },
        onDelete: (studentToDelete) => {
          console.log('🗑️ Delete button clicked, showing confirmation modal');
          // Show custom confirmation modal
          openConfirmModal({
            title: 'Delete Student',
            message: 'Are you sure you want to delete this student? This will permanently remove all student data, payments, and notes. This action cannot be undone.',
            onConfirm: () => {
              console.log('✅ User confirmed deletion, proceeding with delete');
              const studentId = studentToDelete?.id || studentToDelete?.ID || currentStudentId;
              
              if (!studentId) {
                openConfirmModal({
                  title: 'Error',
                  message: 'Cannot delete student: Student ID not found',
                  onConfirm: () => {
                    // Just close the modal
                  },
                  onCancel: () => {
                    // Just close the modal
                  }
                });
                return;
              }
              
              // Close the details modal
              const modal = document.getElementById('detailsModalRoot');
              if (modal) {
                modal.classList.add('hidden');
              }
              
              // Delete from backend first
              if (window.google && google.script && google.script.run) {
                google.script.run
                  .withSuccessHandler(function(result) {
                    console.log('Student deleted successfully:', result);
                    
                    // Show success message first
                    openNotificationModal({
                      type: 'success',
                      title: 'Success',
                      message: 'Student deleted successfully',
                      onClose: () => {
                        // Remove from table after success message is closed
                        const tableRow = document.querySelector(`tr[data-student-id="${studentId}"]`);
                        if (tableRow) {
                          tableRow.remove();
                        }
                        
                        // Also remove from the data arrays
                        if (window._rows && window._displayRows) {
                          const idIndex = window._headers ? window._headers.indexOf('ID') : -1;
                          if (idIndex !== -1) {
                            window._rows = window._rows.filter(row => String(row[idIndex]) !== String(studentId));
                            window._displayRows = window._displayRows.filter(row => String(row[idIndex]) !== String(studentId));
                            console.log(`✅ Removed student ${studentId} from data arrays`);
                          }
                        }
                        
                        // Remove from cache
                        if (window._studentDetailsCache && window._studentDetailsCache[studentId]) {
                          delete window._studentDetailsCache[studentId];
                        }
                        
                        // Remove from localStorage cache
                        const localStorageKey = `student_${studentId}`;
                        if (typeof cacheManager !== 'undefined') {
                          cacheManager.remove(localStorageKey);
                        }
                        
                        // Also remove from localStorage directly as backup
                        try {
                          localStorage.removeItem(localStorageKey);
                          console.log(`✅ Removed student ${studentId} from localStorage`);
                        } catch (e) {
                          console.warn('Failed to remove from localStorage:', e);
                        }
                      }
                    });
                  })
                  .withFailureHandler(function(error) {
                    console.error('Failed to delete student:', error);
                    
                    // Revert optimistic update - reload the page to restore data
                    location.reload();
                    
                    openNotificationModal({
                      type: 'error',
                      title: 'Error',
                      message: 'Failed to delete student. Please try again.',
                      details: error.message || error.toString()
                    });
                  })
                  .deleteStudent(studentId);
              } else {
                // Fallback: just update frontend if backend not available
                console.log('Student deleted (backend not available):', studentToDelete);
                openNotificationModal({
                  type: 'success',
                  title: 'Success',
                  message: 'Student deleted successfully'
                });
              }
            },
            onCancel: () => {
              // Do nothing, just close the modal
            }
          });
        }
      });
    });

    // Global function for adding new students (called from navbar)
    window.showForm = function() {
      openStudentModal({
        mode: 'add',
        onSave: ({ backend, internal }) => {
          // Optimistic update: Add student to table immediately
          const tempStudentData = { ...backend.student, ID: 'temp_' + Date.now() };
          addStudentToTable(tempStudentData);
          
          // Save to backend
          console.log('New student created:', backend);
          
          if (window.google && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(newStudentId) {
                console.log('Student added successfully with ID:', newStudentId);
                
                // Update the temporary row with real ID
                const tempRow = document.querySelector(`tr[data-temp-id="${tempStudentData.ID}"]`);
                if (tempRow) {
                  const idCell = tempRow.querySelector('td:first-child');
                  if (idCell) {
                    idCell.textContent = newStudentId;
                    tempRow.removeAttribute('data-temp-id');
                    tempRow.setAttribute('data-student-id', newStudentId);
                    // Remove temporary styling and add click handler
                    tempRow.style.opacity = '';
                    tempRow.addEventListener('click', () => openStudentDetails(newStudentId));
                  }
                }
                
                // Update the data arrays with the real ID
                if (window._rows && window._displayRows && window._headers) {
                  const idIndex = window._headers.indexOf('ID');
                  if (idIndex !== -1) {
                    // Find and update the temporary row in data arrays
                    const tempRowIndex = window._rows.findIndex(row => row[idIndex] === tempStudentData.ID);
                    if (tempRowIndex !== -1) {
                      window._rows[tempRowIndex][idIndex] = newStudentId;
                      window._displayRows[tempRowIndex][idIndex] = newStudentId;
                      console.log(`✅ Updated student ID in data arrays from ${tempStudentData.ID} to ${newStudentId}`);
                    }
                  }
                }
                
                // Add to cache
                const studentData = {
                  student: { ...backend.student, ID: newStudentId },
                  payments: [],
                  notes: [],
                  latestByMonth: {}
                };
                
                if (window._studentDetailsCache) {
                  window._studentDetailsCache[newStudentId] = studentData;
                }
                
                // Update localStorage cache
                const localStorageKey = `student_${newStudentId}`;
                if (typeof cacheManager !== 'undefined') {
                  cacheManager.set(localStorageKey, studentData, 1800000); // 30 minutes
                }
                
                // Show success message
                openNotificationModal({
                  type: 'success',
                  title: 'Student Added Successfully',
                  message: 'The student has been added to the system.',
                  details: 'Student ID: ' + newStudentId
                });
              })
              .withFailureHandler(function(error) {
                console.error('Failed to add student:', error);
                
                // Revert optimistic update - remove the temporary row
                const tempRow = document.querySelector(`tr[data-temp-id="${tempStudentData.ID}"]`);
                if (tempRow) {
                  tempRow.remove();
                }
                
                openNotificationModal({
                  type: 'error',
                  title: 'Failed to Add Student',
                  message: 'There was an error adding the student to the system.',
                  details: error.message || error.toString()
                });
              })
              .addStudent(backend.student);
          } else {
            console.error('Google Apps Script not available');
            
            // Revert optimistic update
            const tempRow = document.querySelector(`tr[data-temp-id="${tempStudentData.ID}"]`);
            if (tempRow) {
              tempRow.remove();
            }
            
            openNotificationModal({
              type: 'error',
              title: 'System Error',
              message: 'Cannot add student at this time.',
              details: 'Google Apps Script is not available. Please refresh the page and try again.'
            });
          }
        }
      });
    };
    
    el.deleteBtn.addEventListener('click', () => {
      console.log('🗑️ Delete button clicked from student details view');
      const studentId = student?.id || student?.ID || '';
      
      if (!studentId) {
        console.log('❌ No student ID found');
        openNotificationModal({
          type: 'error',
          title: 'Error',
          message: 'Cannot delete student: Student ID not found'
        });
        return;
      }
      
      console.log('📋 Showing confirmation modal for student ID:', studentId);
      openConfirmModal({
        title: 'Delete Student',
        message: 'Are you sure you want to delete this student? This will permanently remove all student data, payments, and notes. This action cannot be undone.',
        onConfirm: () => {
          console.log('✅ User confirmed deletion, proceeding with delete for student ID:', studentId);
          // Close the student details modal first
          const modal = document.getElementById('detailsModalRoot');
          if (modal) {
            modal.classList.add('hidden');
          }
          
          // Delete from backend first
          if (window.google && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(result) {
                console.log('Student deleted successfully:', result);
                
                // Show success message first
                openNotificationModal({
                  type: 'success',
                  title: 'Success',
                  message: 'Student deleted successfully',
                  onClose: () => {
                    // Remove from table after success message is closed
                    const tableRow = document.querySelector(`tr[data-student-id="${studentId}"]`);
                    if (tableRow) {
                      tableRow.remove();
                    }
                    
                    // Also remove from the data arrays
                    if (window._rows && window._displayRows) {
                      const idIndex = window._headers ? window._headers.indexOf('ID') : -1;
                      if (idIndex !== -1) {
                        window._rows = window._rows.filter(row => String(row[idIndex]) !== String(studentId));
                        window._displayRows = window._displayRows.filter(row => String(row[idIndex]) !== String(studentId));
                        console.log(`✅ Removed student ${studentId} from data arrays`);
                      }
                    }
                    
                    // Remove from cache
                    if (window._studentDetailsCache && window._studentDetailsCache[studentId]) {
                      delete window._studentDetailsCache[studentId];
                    }
                    
                    // Remove from localStorage cache
                    const localStorageKey = `student_${studentId}`;
                    if (typeof cacheManager !== 'undefined') {
                      cacheManager.remove(localStorageKey);
                    }
                    
                    // Also remove from localStorage directly as backup
                    try {
                      localStorage.removeItem(localStorageKey);
                      console.log(`✅ Removed student ${studentId} from localStorage`);
                    } catch (e) {
                      console.warn('Failed to remove from localStorage:', e);
                    }
                  }
                });
              })
              .withFailureHandler(function(error) {
                console.error('Failed to delete student:', error);
                
                // Revert optimistic update - reload the page to restore data
                location.reload();
                
                openNotificationModal({
                  type: 'error',
                  title: 'Error',
                  message: 'Failed to delete student. Please try again.',
                  details: error.message || error.toString()
                });
              })
              .deleteStudent(studentId);
          } else {
            // Fallback: just update frontend if backend not available
            console.log('Student deleted (backend not available):', student);
            openNotificationModal({
              type: 'success',
              title: 'Success',
              message: 'Student deleted successfully'
            });
          }
        },
        onCancel: () => {
          // Just close the modal
        }
      });
    });
    
    // Function to update student table row with new data
    function updateStudentTableRow(studentId, studentData) {
      // Find the table row for this student
      const tableRows = document.querySelectorAll('#studentTable tr');
      const idIndex = window._headers ? window._headers.indexOf('ID') : -1;
      
      if (idIndex === -1) {
        console.log('Headers not found, cannot update table');
        return;
      }
      
      for (let i = 0; i < tableRows.length; i++) {
        const row = tableRows[i];
        const cells = row.querySelectorAll('td');
        
        if (cells.length > idIndex) {
          const rowId = cells[idIndex].textContent.trim();
          if (rowId === String(studentId)) {
            // Update the row with new data
            updateTableRowCells(row, studentData);
            console.log('Updated table row for student:', studentId);
            return;
          }
        }
      }
      console.log('Student row not found in table:', studentId);
    }
    
    function updateTableRowCells(row, studentData) {
      const cells = row.querySelectorAll('td');
      const headers = window._headers || [];
      
      headers.forEach((header, index) => {
        if (index < cells.length) {
          const cell = cells[index];
          let value = '';
          
          switch (header) {
            case 'Name':
              value = studentData.Name || '';
              cell.textContent = value;
              break;
            case '漢字':
              value = studentData['漢字'] || '';
              cell.textContent = value;
              break;
            case 'Email':
              value = studentData.Email || '';
              cell.textContent = value;
              break;
            case 'Phone':
              value = studentData.Phone || '';
              cell.textContent = value;
              break;
            case 'Status':
              value = studentData.Status || '';
              let statusClass = '';
              switch(value) {
                case 'Active': statusClass = 'badge badge-status-active'; break;
                case 'Dormant': statusClass = 'badge badge-status-dormant'; break;
                case 'DEMO': statusClass = 'badge badge-status-demo'; break;
                default: statusClass = 'badge badge-status-dormant';
              }
              cell.innerHTML = '<span class="' + statusClass + '">' + value + '</span>';
              cell.style.textAlign = 'center';
              break;
            case 'Payment':
              value = studentData.Payment || '';
              const paymentClass = value === 'NEO' ? 'badge badge-pay-neo' : 'badge badge-pay-old';
              cell.innerHTML = '<span class="' + paymentClass + '">' + value + '</span>';
              cell.style.textAlign = 'center';
              break;
            case 'Group':
              value = studentData.Group || '';
              const groupClass = value === 'Individual' ? 'badge badge-group-individual' : 'badge badge-group-group';
              cell.innerHTML = '<span class="' + groupClass + '">' + value + '</span>';
              cell.style.textAlign = 'center';
              break;
            case '当日 Cancellation':
              value = studentData['当日 Cancellation'] || '';
              const cancelBadgeClass = value === '済' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
              cell.innerHTML = '<span class="' + cancelBadgeClass + '">' + value + '</span>';
              cell.style.textAlign = 'center';
              break;
            case '当日':
              value = studentData['当日'] || '';
              const cancelBadgeClass2 = value === '済' ? 'badge badge-cancel-yes' : 'badge badge-cancel-no';
              cell.innerHTML = '<span class="' + cancelBadgeClass2 + '">' + value + '</span>';
              cell.style.textAlign = 'center';
              break;
            case '人数':
              value = studentData['人数'] || '';
              cell.textContent = value;
              cell.style.textAlign = 'center';
              break;
            case '子':
              value = studentData['子'] || '';
              cell.textContent = value;
              cell.style.textAlign = 'center';
              break;
            default:
              // Keep existing value for other columns
              break;
          }
        }
      });
    }
    
    // Initialize Lucide icons
    if (window.lucide && lucide.createIcons) {
      lucide.createIcons();
    }
    
    el.closeBtn.addEventListener('click', ()=> {
      // Don't clear Latest Record data - it should persist in cache
      // if (latestRecordApi) {
      //   latestRecordApi.clear();
      // }
      
      const modal = document.getElementById('detailsModalRoot');
      if (modal) {
        modal.classList.add('hidden');
      }
    });

    // Add click outside modal to close
    document.getElementById('detailsModalRoot').addEventListener('click', function(e) {
      if (e.target === this) {
        // Don't clear Latest Record data - it should persist in cache
        // if (latestRecordApi) {
        //   latestRecordApi.clear();
        // }
        
        this.classList.add('hidden');
      }
    });

    // Add ESC key to close modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('detailsModalRoot');
        if (modal && !modal.classList.contains('hidden')) {
          // Don't clear Latest Record data - it should persist in cache
          // if (latestRecordApi) {
          //   latestRecordApi.clear();
          // }
          
          modal.classList.add('hidden');
        }
      }
    });

    function setStatusPill(status){
      status = status || '';
      el.statusPill.textContent = status;
      el.statusPill.className = 'badge ' + (status.toLowerCase()==='active' ? 'bg-emerald-600 text-white' : 'bg-slate-600 text-white');
    }

    function renderHeader(){
      const s = student || {};
      el.name.textContent = s.name || '';
      el.kanji.textContent = s.kanji || '';
      if (el.email) el.email.textContent = (s.email || s.mail || ''); if (el.phone) el.phone.textContent = (s.phone || s.phoneNumber || s.tel || ''); if (el.contact) el.contact.style.display = ((el.email && el.email.textContent) || (el.phone && el.phone.textContent)) ? '' : 'none'; setStatusPill(s.status || '');
    }

    // ----- Latest Record Component -----
    let latestRecordApi = null;

    function initLatestRecord() {
      if (latestRecordApi) {
        // Just load new data, don't clear
        latestRecordApi.load({ latestByMonth: latestMap });
      } else {
        // Only create new component if it doesn't exist
        latestRecordApi = createLatestRecord({
          root: el.latestSection,
          data: { latestByMonth: latestMap }
        });
      }
    }

    function updateLatestRecord() {
      if (latestRecordApi) {
        latestRecordApi.load({ latestByMonth: latestMap });
      }
      
      // Also update the cache with the latest changes
      if (student && student.id) {
        // Update the student's latestByMonth in memory cache
        if (window._studentDetailsCache && window._studentDetailsCache[student.id]) {
          window._studentDetailsCache[student.id].latestByMonth = { ...latestMap };
        }
        
        // Update localStorage cache
        const cacheKey = `student_${student.id}`;
        if (typeof cacheManager !== 'undefined') {
          const cachedData = cacheManager.get(cacheKey);
          if (cachedData) {
            cachedData.latestByMonth = { ...latestMap };
            cacheManager.set(cacheKey, cachedData, 1800000); // 30 minutes
            console.log('💾 Updated Latest Record in cache for student:', student.id);
          }
        }
      }
    }

    // Latest Record Component Factory
    (function(){
      const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      function deriveLatestByMonth(source){
        const src = source || {};
        const fallback = { Payment: '未', lessons: [] };
        
        // If source has data, preserve ALL months from source
        if (Object.keys(src).length > 0) {
          return { ...src };
        }
        
        // Fallback to current and next month if no source data
        const now = new Date();
        const m1 = MONTHS[now.getMonth()];
        const m2 = MONTHS[(now.getMonth()+1)%12];
        return { [m1]: fallback, [m2]: fallback };
      }

      function payBadges(isPaid){
        const cls = isPaid ? 'bg-emerald-600 text-white' : 'bg-amber-500 text-white';
        const jp  = isPaid ? '済' : '未';
        const en  = isPaid ? 'Paid' : 'Unpaid';
        return `<span class="badge ${cls} mr-1">${jp}</span><span class="badge ${cls}">${en}</span>`;
      }

      function lessonCard(l, idx, month){
        const stylesMap = {
          scheduled:   { accent:'bg-emerald-600', hoverRing:'hover:ring-emerald-500/60', dot:'bg-emerald-600', bg:'bg-emerald-50' },
          cancelled:   { accent:'bg-slate-500',   hoverRing:'hover:ring-slate-500/60',   dot:'bg-slate-500',   bg:'bg-slate-50'   },
          rescheduled: { accent:'bg-amber-500',   hoverRing:'hover:ring-amber-500/60',   dot:'bg-amber-500',   bg:'bg-amber-50'   },
          unbooked:    { accent:'bg-orange-500',  hoverRing:'hover:ring-orange-500/60',  dot:'bg-orange-500',  bg:'bg-orange-50'  },
          unscheduled: { accent:'bg-red-500',     hoverRing:'hover:ring-red-500/60',     dot:'bg-red-500',     bg:'bg-red-50'     }
        };
        const styles = stylesMap[l.status] || stylesMap.cancelled;
        
        // Format day and time in Japanese style
        let day = l.day || '';
        let time = l.time || '';
        
        // Convert day to Japanese format (e.g., "02" -> "2日")
        if (day && day !== '--') {
          // Remove leading zero and add 日
          day = parseInt(day).toString() + '日';
        }
        
        // Convert time to Japanese format (e.g., "15:00" -> "15：00")
        if (time && time !== '--') {
          // Replace colon with Japanese full-width colon
          time = time.replace(':', '：');
        }
        
        const title = (l.status || '').charAt(0).toUpperCase() + (l.status || '').slice(1);
        const label = [day, time].filter(Boolean).join('・');
        return `
          <button type="button"
            class="lr-card group relative inline-flex items-start gap-2 rounded-xl border border-gray-200 ${styles.bg} px-3 py-2 w-full text-left shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-inset ${styles.hoverRing}"
            data-idx="${idx}" data-month="${month}" data-status="${l.status}" aria-label="Lesson ${label} (${title})" title="${title}">
            <span class="absolute left-0 top-0 h-full w-1.5 rounded-l-xl ${styles.accent}"></span>
            <span class="mt-0.5 flex-1">
              <span class="block font-semibold tabular-nums">${label}</span>
              <span class="mt-1 inline-flex items-center text-[11px] text-gray-600">
                <span class="mr-1 h-2 w-2 rounded-full ${styles.dot}"></span>${title}
              </span>
            </span>
          </button>`;
      }

      function mount(root, data){
        const el = {
          root: typeof root === 'string' ? document.querySelector(root) : root,
          tabs: document.getElementById('lr_monthTabs'),
          table: document.getElementById('lr_table'),
          cards: document.getElementById('lr_cards'),
        };

        // Check if all required elements exist
        if (!el.tabs || !el.table || !el.cards) {
          return {
            load: () => {},
            destroy: () => {}
          };
        }

        let latest = deriveLatestByMonth(data?.latestByMonth);
        let currentMonth = Object.keys(latest)[0] || null;

        function renderTabs(){
          const months = Object.keys(latest);
          if (!months.length){ 
            if (el.tabs) el.tabs.innerHTML=''; 
            if (el.table) el.table.innerHTML=''; 
            if (el.cards) el.cards.innerHTML=''; 
            return; 
          }
          el.tabs.innerHTML = months.map((m,i)=> `<button data-month="${m}" class="lr-month px-3 py-1.5 text-sm ${i===0?'bg-green-600 text-white':'bg-gray-50 text-gray-800'} hover:bg-green-600/90 hover:text-white focus:outline-none">${m}</button>`).join('');
          el.tabs.querySelectorAll('.lr-month').forEach(btn => btn.addEventListener('click', () => {
            el.tabs.querySelectorAll('.lr-month').forEach(b=>b.classList.remove('bg-green-600','text-white'));
            el.tabs.querySelectorAll('.lr-month').forEach(b=>b.classList.add('bg-gray-50','text-gray-800'));
            btn.classList.remove('bg-gray-50','text-gray-800');
            btn.classList.add('bg-green-600','text-white');
            currentMonth = btn.dataset.month;
            renderLatest(currentMonth);
          }));
          renderLatest(months[0]);
        }

        function renderLatest(month){
          const data = latest[month] || {};
          const isPaid = (data.Payment==='済' || String(data.Payment||'').toLowerCase()==='paid');
          if (el.table) {
            el.table.innerHTML = `<tr><td class="py-1.5 pr-2 text-gray-600">Payment</td><td class="py-1.5 text-center">${payBadges(isPaid)}</td></tr>`;
          }
          const lessons = Array.isArray(data.lessons) ? data.lessons : [];
          if (el.cards) {
            el.cards.classList.toggle('dense', lessons.length > 6);
            el.cards.innerHTML = lessons.map((l,i)=>lessonCard(l,i,month)).join('');
            
            // Add click event listeners to lesson cards
            el.cards.querySelectorAll('.lr-card').forEach((card, index) => {
              card.addEventListener('click', () => {
                const lesson = lessons[index];
                if (lesson) {
                  openLessonDetailsModal({
                    lesson: lesson,
                    student: window.student, // Access the global student object
                    onClose: () => {
                      // Modal closed
                    }
                  });
                }
              });
            });
          }
        }

        // Initial render
        renderTabs();

        return {
          load(newData){ latest = deriveLatestByMonth(newData?.latestByMonth); renderTabs(); },
          clear(){ 
            // Clear data without destroying DOM elements
            latest = {};
            if (el.tabs) el.tabs.innerHTML = '';
            if (el.table) el.table.innerHTML = '';
            if (el.cards) el.cards.innerHTML = '';
          },
          destroy(){ el.root.innerHTML = ''; }
        };
      }

      // expose factory
      window.createLatestRecord = function({ root, data }){ return mount(root || document.body, data || {}); };
    })();

    // ----- Notes (reversed newest first) -----
    function renderNotes(filter=''){
      const q = (filter||'').trim().toLowerCase();
      const arr = Array.isArray(student.notes) ? student.notes.slice().reverse() : [];
      const list = arr.filter(n => !q || (String(n.text||'')+' '+String(n.staff||'')+' '+String(n.date||'')).toLowerCase().includes(q));
      el.notesBody.innerHTML = list.map((n, index) => 
        `<tr class="odd:bg-gray-50 hover:bg-gray-100 cursor-pointer note-row" data-index="${index}">
          <td class="px-3 py-2 whitespace-nowrap">${n.date||''}</td>
          <td class="px-3 py-2">${n.text||''}</td>
          <td class="px-3 py-2 whitespace-nowrap">${n.staff||''}</td>
        </tr>`
      ).join('') || `<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">No notes</td></tr>`;
      
      // Add event listeners for note row clicks
      el.notesBody.querySelectorAll('.note-row').forEach(row => {
        row.addEventListener('click', () => {
          const index = parseInt(row.dataset.index);
          const note = list[index];
          
          // Convert the note data structure to match what openNoteModal expects
          const noteForModal = {
            ID: note.id,
            Date: note.date,
            Note: note.text,
            Staff: note.staff
          };
          
          openNoteModal({
            mode: 'edit',
            note: noteForModal,
            onSave: (updatedNote) => {
              // Optimistic update: Update UI immediately
              const originalIndex = student.notes.findIndex(n => 
                n.Date === note.Date && n.Note === note.Note && n.Staff === note.Staff
              );
              if (originalIndex !== -1) {
                const oldNote = student.notes[originalIndex];
                student.notes[originalIndex] = updatedNote;
                renderNotes();
                
                // Update cache immediately - pass old note data to update existing entry
                updateStudentCache(student.id, 'note', updatedNote, false, oldNote);
                
                // Save to backend
                if (window.google && google.script && google.script.run) {
                  google.script.run
                    .withSuccessHandler(function(result) {
                      console.log('Note updated successfully:', result);
                      // Cache already updated, no additional action needed
                    })
                    .withFailureHandler(function(error) {
                      console.error('Failed to update note:', error);
                      
                      // Revert optimistic update
                      student.notes[originalIndex] = oldNote;
                      renderNotes();
                      updateStudentCache(student.id, 'note', oldNote, true, updatedNote); // Revert
                      
                      openConfirmModal({
                        title: 'Error',
                        message: 'Failed to update note. Please try again.',
                        onConfirm: () => {
                          // Just close the modal
                        },
                        onCancel: () => {
                          // Just close the modal
                        }
                      });
                    })
                    .updateNote(updatedNote);
                } else {
                  // Fallback: just update frontend if backend not available
                  console.log('Note updated (backend not available):', updatedNote);
                }
              }
            },
            onDelete: (noteToDelete) => {
              // Show custom confirmation modal
              openConfirmModal({
                title: 'Delete Note',
                message: 'Are you sure you want to delete this note? This action cannot be undone.',
                onConfirm: () => {
                  // Optimistic update: Remove note from UI immediately
                  const originalIndex = student.notes.findIndex(n => 
                    n.Date === noteToDelete.Date && n.Note === noteToDelete.Note && n.Staff === noteToDelete.Staff
                  );
                  
                  if (originalIndex !== -1) {
                    const deletedNote = student.notes[originalIndex];
                    student.notes.splice(originalIndex, 1);
                    renderNotes();
                    
                    // Update cache immediately - remove the specific note
                    removeNoteFromCache(student.id, deletedNote);
                    
                    // Delete from backend
                    if (window.google && google.script && google.script.run) {
                      google.script.run
                        .withSuccessHandler(function(result) {
                          console.log('Note deleted successfully:', result);
                          // Cache already updated, no additional action needed
                        })
                        .withFailureHandler(function(error) {
                          console.error('Failed to delete note:', error);
                          
                          // Revert optimistic update
                          student.notes.splice(originalIndex, 0, deletedNote);
                          renderNotes();
                          updateStudentCache(student.id, 'note', deletedNote); // Restore to cache
                          
                          openConfirmModal({
                            title: 'Error',
                            message: 'Failed to delete note. Please try again.',
                            onConfirm: () => {
                              // Just close the modal
                            },
                            onCancel: () => {
                              // Just close the modal
                            }
                          });
                        })
                        .deleteNote(noteToDelete);
                    } else {
                      // Fallback: just update frontend if backend not available
                      console.log('Note deleted (backend not available):', noteToDelete);
                    }
                  }
                },
                onCancel: () => {
                  // Do nothing, just close the modal
                }
              });
            }
          });
        });
      });
    }
    el.noteSearch.addEventListener('input', e => renderNotes(e.target.value));

    // -------- Normalisation helpers --------
    function toArray(x){ 
      if (Array.isArray(x)) return x; 
      if (x && typeof x === 'object') return Object.values(x); 
      return []; 
    }
    function normalisePayments(maybe){
      const arr = toArray(maybe);
      return arr.map(p => {
        const date = p.date || p.Date || p['Date'] || '';
        const lessons = p['Amount'] || (p.lessons ?? p.Lessons ?? p['Number of lessons'] ?? '');
        const price = p['Total'] || (p.price ?? p.Price ?? p.amount);
        const method = p.method || p.Method || '';
        const staff  = p.staff  || p.Staff  || '';
        const txn    = p['Transaction ID'] || p.transactionId || p.id || p['Txn'] || '';
        const year = p.Year || (p.year ?? (date ? new Date(date).getFullYear() : ''));
        const monthName = p.Month || p.month || '';
        return { transactionId: txn, date, year, month: monthName, price, lessons, method, staff };
      });
    }
    function normaliseNotes(maybe){
      const arr = toArray(maybe);
      return arr.map(n => ({ 
        id: n.id || n.ID || '',
        date: n.date || n.Date || '', 
        staff: n.staff || n.Staff || '', 
        text: n.text || n.Note || n.note || '' 
      }));
    }
    function normaliseLatest(latest){
      if (!latest || typeof latest !== 'object') return {};
      const out = {};
      if (Array.isArray(latest)) {
        latest.forEach(v => {
          const k = v.month || '';
          const m = (k && /\d{4}-\d{2}/.test(k)) ? MONTHS[parseInt(k.slice(5,7),10)-1] : (k || '');
          out[m] = { Payment: v.Payment || v.payment || (v.paid ? '済' : '未'), lessons: toArray(v.Lessons || v.lessons) };
        });
      } else {
        for (const [k, v0] of Object.entries(latest)){
          const v = v0 || {};
          const m = (k && /\d{4}-\d{2}/.test(k)) ? MONTHS[parseInt(k.slice(5,7),10)-1] : k;
          out[m] = { Payment: (v.Payment!=null?v.Payment:(v.payment!=null?v.payment:(v.paid?'済':'未'))), lessons: toArray(v.Lessons || v.lessons) };
        }
      }
      return out;
    }
    function safeParse(objOrJson){
      if (objOrJson == null) return {};
      if (typeof objOrJson === 'string'){
        try { return JSON.parse(objOrJson); } catch(_) { return {}; }
      }
      return objOrJson;
    }
    function deriveTwoMonths(latestMapIn){
      const now = new Date();
      const m1 = MONTHS[now.getMonth()];
      const m2 = MONTHS[(now.getMonth()+1)%12];
      const fallback = { Payment: '未', lessons: [] };
      
      // Try to find data with full month-year format first, then fallback to short format
      const currentYear = now.getFullYear();
      const nextYear = (now.getMonth() === 11) ? currentYear + 1 : currentYear;
      const m1Full = `${m1} ${currentYear}`;
      const m2Full = `${m2} ${nextYear}`;
      
      return { 
        map: { 
          [m1]: latestMapIn[m1Full] || latestMapIn[m1] || fallback, 
          [m2]: latestMapIn[m2Full] || latestMapIn[m2] || fallback 
        }, 
        order: [m1, m2] 
      };
    }
    function normaliseForModal(baseResp, latest){
      baseResp = safeParse(baseResp); latest = safeParse(latest);
      const s = baseResp.student || baseResp.info || baseResp.profile || {};
      const payments = baseResp.payments || baseResp.payment || baseResp.paymentHistory || s.payments || [];
      const notes    = baseResp.notes || baseResp.allNotes || s.notes || [];
      const latestN  = normaliseLatest(baseResp.LatestByMonth || baseResp.latestByMonth || latest);
      const derived  = deriveTwoMonths(latestN);
      return {
        id:     s['ID'] || s['id'] || baseResp.id || baseResp.ID || '',
        name:   s['Name'] || s['name'] || baseResp.name || '',
        kanji:  s['漢字'] || s['Kanji'] || s['kanji'] || baseResp.kanji || '',
        status: s['Status']|| s['status']|| baseResp.status || '',
        email:  s['email'] || s['Email'] || s['E-mail'] || s['E_mail'] || s['Email Address'] || s['メール'] || s['Mail'] || s['mail'] || s['連絡先メール'] || s['連絡先メールアドレス'] || s['メールアドレス'] || baseResp.email || baseResp['Email'] || baseResp['E-mail'] || baseResp['Email Address'] || '',
        phone:  s['phone'] || s['Phone'] || s['phone (secondary)'] || s['Mobile'] || s['mobile'] || s['携帯'] || s['電話'] || s['電話番号'] || s['TEL'] || s['Tel'] || s['連絡先電話'] || s['連絡先電話番号'] || baseResp.phone || baseResp['Phone'] || baseResp['Mobile'] || baseResp['TEL'] || '',
        paymentType: s['Payment Type'] || s['Payment'] || s['paymentType'] || s['payment'] || baseResp.paymentType || '',
        cancelSameDay: s['当日キャンセル'] || s['当日'] || s['cancelSameDay'] || s['sameDayCancel'] || baseResp.cancelSameDay || '',
        child: s['子'] || s['child'] || baseResp.child || '',
        group: s['Group'] || s['group'] || baseResp.group || '',
        groupSize: s['人数'] || s['groupSize'] || s['group_size'] || baseResp.groupSize || '',
        latestByMonth: derived.map,
        _displayOrder: derived.order,
        payments: normalisePayments(payments),
        notes: normaliseNotes(notes)
      };
    }

    function loadStudent(model){
      student = Object(model) === model ? model : {};
      latestMap = model.latestByMonth || {};
      displayOrder = Array.isArray(model._displayOrder) ? model._displayOrder : Object.keys(latestMap);
      
      console.log('🔍 Debug - loadStudent called with model:', {
        hasNotes: !!model.notes,
        notesLength: model.notes ? model.notes.length : 0,
        studentNotes: student.notes ? student.notes.length : 0
      });
      
      // Ensure we have the student ID stored
      if (model && model.id) {
        student.id = model.id;
        student.ID = model.id;
      } else if (model && model.student && model.student.ID) {
        student.id = model.student.ID;
        student.ID = model.student.ID;
      }
      
      // Update global student reference
      window.student = student;
      console.log('🔍 Updated window.student:', window.student);

      
      renderHeader(); renderNotes();
      renderPaymentsTable();
      initLatestRecord(); // Initialize with data from the initial response
    }
    window.loadStudent = loadStudent;

    function renderPaymentsTable(){
      const list = Array.isArray(student.payments) ? student.payments : [];
      
      if (!list.length){ 
        el.paymentsBody.innerHTML = `<tr><td colspan="8" class="px-3 py-6 text-center text-gray-500">No payments</td></tr>`; 
        return; 
      }
      
      // Sort payments by date (latest first)
      const sortedList = list.sort((a, b) => {
        const dateA = new Date(a.date || a.Date || a['Date Paid'] || '');
        const dateB = new Date(b.date || b.Date || b['Date Paid'] || '');
        return dateB - dateA; // Latest first
      });
      
      const rows = sortedList.map((p, index) => {
        // Map the actual Payment sheet fields
        const d = p['Date Paid'] || p['Payment Date'] || p.date || p.Date || '';
        const year = p.Year || (d ? new Date(d).getFullYear() : '');
        const month = p.Month || p.month || '';
        
        // Get lessons count - this might be calculated or stored differently
        const lessons = p.Lessons || p['Number of lessons'] || p.lessons || p.Amount || '';
        
        // Format price as currency with yen symbol, commas and no decimals
        const rawPrice = p.Total || p.price || p.amount || 0;
        let price = typeof rawPrice === 'number' || !isNaN(rawPrice) ? 
          Number(rawPrice).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) : 
          (rawPrice ? rawPrice : '0');
        
        // Ensure yen symbol is always present
        if (price && !price.includes('¥')) {
          price = '¥' + price;
        }
        
        const method = p.Method || p.method || '';
        const staff = p.Staff || p.staff || '';
        const txn = p['Transaction ID'] || p.id || p.transactionId || '';
        

        
        return `<tr class="odd:bg-gray-50 hover:bg-gray-100 cursor-pointer payment-row" data-index="${index}">
          <td class="px-3 py-2 whitespace-nowrap">${txn}</td>
          <td class="px-3 py-2 whitespace-nowrap">${d}</td>
          <td class="px-3 py-2 whitespace-nowrap">${year}</td>
          <td class="px-3 py-2 whitespace-nowrap">${month}</td>
          <td class="px-3 py-2 whitespace-nowrap">${price}</td>
          <td class="px-3 py-2 whitespace-nowrap text-center">${lessons}</td>
          <td class="px-3 py-2 whitespace-nowrap">${method}</td>
          <td class="px-3 py-2 whitespace-nowrap">${staff}</td>
        </tr>`;
      }).join('');
      el.paymentsBody.innerHTML = rows;
      
      // Add event listeners for payment row clicks
      el.paymentsBody.querySelectorAll('.payment-row').forEach(row => {
        row.addEventListener('click', () => {
          const index = parseInt(row.dataset.index);
          const payment = sortedList[index];
          
          openPaymentModal({
            mode: 'edit',
            payment: payment,
            onSave: (updatedPayment) => {
              // Optimistic update: Update UI immediately
              const originalIndex = student.payments.findIndex(p => 
                p['Transaction ID'] === payment['Transaction ID'] || 
                p.transactionId === payment.transactionId
              );
              
              if (originalIndex !== -1) {
                const oldPayment = student.payments[originalIndex];
                student.payments[originalIndex] = updatedPayment;
                renderPaymentsTable();
                
                // Update cache immediately - pass old payment data to update existing entry
                updateStudentCache(student.id, 'payment', updatedPayment, false, oldPayment);
                
                // Update Latest Record with updated payment status and unscheduled lessons
                updateLatestRecordWithPayment(updatedPayment);
                
                // Save to backend
                if (window.google && google.script && google.script.run) {
                  google.script.run
                    .withSuccessHandler(function(result) {
                      console.log('Payment updated successfully:', result);
                      // Update cache with server response - pass old payment data to update existing entry
                      updateStudentCache(student.id, 'payment', result, false, oldPayment);
                    })
                    .withFailureHandler(function(error) {
                      console.error('Failed to update payment:', error);
                      
                      // Revert optimistic update
                      student.payments[originalIndex] = oldPayment;
                      renderPaymentsTable();
                      updateStudentCache(student.id, 'payment', oldPayment, true, updatedPayment); // Revert
                      
                      // Revert Latest Record changes
                      revertLatestRecordWithPayment(updatedPayment);
                      updateLatestRecordWithPayment(oldPayment);
                      
                      openConfirmModal({
                        title: 'Error',
                        message: 'Failed to update payment. Please try again.',
                        onConfirm: () => {
                          // Just close the modal
                        },
                        onCancel: () => {
                          // Just close the modal
                        }
                      });
                    })
                    .updatePayment(updatedPayment);
                } else {
                  // Fallback: just update frontend if backend not available
                  console.log('Payment updated (backend not available):', updatedPayment);
                }
              }
            },
            onDelete: (paymentToDelete) => {
              // Show custom confirmation modal
              openConfirmModal({
                title: 'Delete Payment',
                message: 'Are you sure you want to delete this payment? This action cannot be undone.',
                onConfirm: () => {
                  // Get the transaction ID from various possible field names
                  const transactionId = paymentToDelete['Transaction ID'] || 
                                       paymentToDelete.transactionId || 
                                       paymentToDelete.id || 
                                       paymentToDelete['Txn'] || 
                                       paymentToDelete.txn;
                  
                  console.log('Payment to delete:', paymentToDelete);
                  console.log('Transaction ID found:', transactionId);
                  
                  if (!transactionId) {
                    openConfirmModal({
                      title: 'Error',
                      message: 'Cannot delete payment: Transaction ID not found',
                      onConfirm: () => {
                        // Just close the modal
                      },
                      onCancel: () => {
                        // Just close the modal
                      }
                    });
                    return;
                  }
                  
                  // Optimistic update: Remove payment from UI immediately
                  const originalIndex = student.payments.findIndex(p => 
                    p['Transaction ID'] === transactionId || 
                    p.transactionId === transactionId ||
                    p.id === transactionId ||
                    p['Txn'] === transactionId ||
                    p.txn === transactionId
                  );
                  
                  if (originalIndex !== -1) {
                    const deletedPayment = student.payments[originalIndex];
                    student.payments.splice(originalIndex, 1);
                    renderPaymentsTable();
                    
                    // Update cache immediately - remove the specific payment
                    removePaymentFromCache(student.id, deletedPayment);
                    
                    // Update Latest Record - revert payment status and remove unscheduled lessons
                    revertLatestRecordWithPayment(deletedPayment);
                    
                    // Delete from backend
                    if (window.google && google.script && google.script.run) {
                      google.script.run
                        .withSuccessHandler(function(result) {
                          console.log('Payment deleted successfully:', result);
                          // Cache already updated, no additional action needed
                        })
                        .withFailureHandler(function(error) {
                          console.error('Failed to delete payment:', error);
                          
                          // Revert optimistic update
                          student.payments.splice(originalIndex, 0, deletedPayment);
                          renderPaymentsTable();
                          updateStudentCache(student.id, 'payment', deletedPayment); // Restore to cache
                          updateLatestRecordWithPayment(deletedPayment); // Restore Latest Record
                          
                          openConfirmModal({
                            title: 'Error',
                            message: 'Failed to delete payment. Please try again.',
                            onConfirm: () => {
                              // Just close the modal
                            },
                            onCancel: () => {
                              // Just close the modal
                            }
                          });
                        })
                        .deletePayment({ ...paymentToDelete, 'Transaction ID': transactionId });
                    } else {
                      // Fallback: just update frontend if backend not available
                      console.log('Payment deleted (backend not available):', paymentToDelete);
                    }
                  }
                },
                onCancel: () => {
                  // Do nothing, just close the modal
                }
              });
            }
          });
        });
      });
    }

    // -------- Fetch & render --------
    // Removed automatic getStudentDetails call to prevent server overload
    // The modal will only load student details when a user clicks on a student row
    /*
    document.addEventListener('DOMContentLoaded', function(){
      const id = '543';
      if (!(window.google && google.script && google.script.run)) {
        console.warn('Run as Apps Script web app to fetch server data.');
        return;
      }
      google.script.run
        .withSuccessHandler(function (baseResp) {google.script.run
            .withSuccessHandler(function (latest) {
              const model = normaliseForModal(baseResp, latest);
              console.log('[v5] payloads:', {baseResp, latest, model});
              loadStudent(model);
            })
            .withFailureHandler(function (err) { console.error('getLatestByMonth failed', err); loadStudent(normaliseForModal(baseResp, {})); })
            .getLatestByMonth(id);
        })
        .withFailureHandler(function (err) { console.error('getStudentDetails failed', err); })
        .getStudentDetails(id);
    });
    */

    // Cache status update function
    function updateCacheStatus() {
      const indicator = document.getElementById('cacheIndicator');
      const text = document.getElementById('cacheText');
      
      if (!indicator || !text) return;
      
      // Check if cacheManager is available
      if (typeof window.cacheManager !== 'undefined') {
        const stats = window.cacheManager.getStats();
        
        if (stats.activeEntries > 0) {
          indicator.className = 'w-2 h-2 rounded-full bg-green-400';
          text.textContent = `${stats.activeEntries} cached`;
          text.title = `Cache: ${stats.activeEntries} active entries, ${stats.totalSize}`;
        } else {
          indicator.className = 'w-2 h-2 rounded-full bg-yellow-400';
          text.textContent = 'No cache';
          text.title = 'No cached data available';
        }
      } else {
        indicator.className = 'w-2 h-2 rounded-full bg-gray-400';
        text.textContent = 'Cache';
        text.title = 'Cache system not initialized';
      }
    }

    // Update cache status every 30 seconds
    setInterval(updateCacheStatus, 30000);
    
    // Initial cache status update
    setTimeout(updateCacheStatus, 2000);

    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const sidebarMenuIcon = document.getElementById('sidebarMenuIcon');

    // Initialize sidebar state
    sidebar.setAttribute('data-hidden', 'true');

    function toggleSidebar(event) {
      event.preventDefault();
      event.stopPropagation();
      
      console.log('🔧 Toggle sidebar clicked');
      console.log('Sidebar classes:', sidebar.className);
      console.log('Data hidden:', sidebar.getAttribute('data-hidden'));
      
      const isHidden = sidebar.getAttribute('data-hidden') === 'true';
      console.log('Is hidden:', isHidden);
      
      if (isHidden) {
        // Show sidebar
        sidebar.classList.remove('-translate-x-full');
        sidebar.setAttribute('data-hidden', 'false');
        sidebarMenuIcon.setAttribute('data-lucide', 'x');
        console.log('✅ Showing sidebar');
      } else {
        // Hide sidebar
        sidebar.classList.add('-translate-x-full');
        sidebar.setAttribute('data-hidden', 'true');
        sidebarMenuIcon.setAttribute('data-lucide', 'menu');
        console.log('✅ Hiding sidebar');
      }
      
      // Re-initialize icons immediately
      if (window.lucide && lucide.createIcons) {
        lucide.createIcons();
      }
    }

    if (toggleBtn) {
      toggleBtn.addEventListener('click', toggleSidebar);
    }

    // Code page navigation
    function showCodePage() {
      // Hide main content
      document.getElementById('mainContent').style.display = 'none';
      // Show code page
      document.getElementById('codePage').style.display = 'flex';
      // Re-initialize icons
      if (window.lucide && lucide.createIcons) lucide.createIcons();
    }

    // Code management functions
    function pushCode() {
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Pushing...';
      button.disabled = true;
      
      setTimeout(() => {
        button.textContent = 'Push Complete';
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600');
        
        // Update last push time
        document.getElementById('lastPushTime').textContent = new Date().toLocaleString();
        
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
          button.classList.remove('bg-green-600');
          button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      }, 2000);
    }

    function pullCode() {
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Pulling...';
      button.disabled = true;
      
      setTimeout(() => {
        button.textContent = 'Pull Complete';
        button.classList.remove('bg-green-600', 'hover:bg-green-700');
        button.classList.add('bg-blue-600');
        
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
          button.classList.remove('bg-blue-600');
          button.classList.add('bg-green-600', 'hover:bg-green-700');
        }, 2000);
      }, 2000);
    }

    function showVersions() {
      alert('Version control feature coming soon!');
    }
  </script>

</body>
</html>
